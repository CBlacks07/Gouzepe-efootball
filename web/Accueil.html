<!-- Accueil.html -->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>GOUZEPE eFOOTBALL ‚Äî Accueil</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="theme.css">
<link rel="stylesheet" href="common.css">
<script>window.EFOOT_API='https://gouzepe-efootball.onrender.com';</script>




<style>
  :root{
    --bg:#0b1220;--panel:#0f1627;--card:#0c1426;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
    --ok:#14532d;--okbg:#0b1610;--warn:#7c2d12;--warnbg:#1a120b;--danger:#7f1d1d
  }
  :root.light{--bg:#f4f6fb;--panel:#ffffff;--card:#ffffff;--text:#0f172a;--muted:#475569;--border:#e5e7eb}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Trebuchet MS",sans-serif;
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.12), transparent 40%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.10), transparent 40%),
      linear-gradient(180deg, rgba(7,10,22,.94), rgba(15,23,42,.96)),
      url('assets/fond.png') center/cover fixed no-repeat;
  }
  html.light body{
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.18), transparent 42%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.16), transparent 42%),
      linear-gradient(180deg, rgba(255,255,255,.86), rgba(245,247,251,.92)),
      url('assets/fond.png') center/cover fixed no-repeat;
  }
  .wrap{max-width:1200px;margin:auto;padding:12px}

  .top{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 6px;background:rgba(12,18,32,.55);backdrop-filter:blur(6px);border-radius:14px}
  html.light .top{background:rgba(255,255,255,.7)}
  .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .logo{width:72px;height:72px;border-radius:14px;background:url('assets/fond.png') center/cover no-repeat;pointer-events:none}
  .menu-toggle{display:none}
  .menu{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  @media (max-width: 840px){
    .menu-toggle{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
    html.light .menu-toggle{background:#fff}
    .menu{
      position:fixed; right:12px; top:64px; z-index:1000; display:none;
      flex-direction:column; gap:10px; width:min(88vw,340px); padding:12px;
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.35)
    }
    .menu.open{display:flex}
  }


  .btn{border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
  html.light .btn{background:#fff}
  .btn.primary{background:var(--okbg);border-color:var(--ok);color:#d1fae5}
  .btn.warn{background:var(--warnbg);border-color:var(--warn);color:#fde68a}
  .btn.strong{background:#0b1b0f;border-color:#14532d;color:#d1fae5}
  .btn.danger{background:#2a0c0c;border-color:var(--danger);color:#fecaca}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .pill{border:1px solid var(--border);padding:8px 12px;border-radius:12px;background:var(--panel)}
  select,input{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#0b1020;color:var(--text)}
  html.light select,html.light input{background:#fff}
  .grid{display:grid;gap:14px}

  /* 3 cards c√¥te √† c√¥te, responsive */
  .row.cards3{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
  .row.cards3 > .card{flex:1 1 360px;min-width:300px;margin-top:0 !important}

  @media(min-width:980px){.grid.two{grid-template-columns:1fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}

  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{color:var(--muted)}
  .muted{color:var(--muted)}
  .dash{opacity:.6}
  .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  #status{transition:opacity .25s}
  .bad{outline:2px solid #ef4444}

  .compactScores th.mid{width:270px}
  .scoresCell{display:grid;grid-template-rows:auto auto;gap:6px;justify-items:center}
  .compactScores .score input{width:44px;text-align:center}
  /* ====== PACK MOBILE matches (resserrer tout) ====== */
@media (max-width: 700px){

  /* Colonnes fixes pour √©viter le grand vide sur "Joueur 2" */
  #d1_matches, #d2_matches{ table-layout: fixed; }

  /* 1re & 3e colonnes = largeur fixe (ID) */
  #d1_matches th:first-child, #d1_matches td:first-child,
  #d1_matches th:nth-child(3), #d1_matches td:nth-child(3),
  #d2_matches th:first-child, #d2_matches td:first-child,
  #d2_matches th:nth-child(3), #d2_matches td:nth-child(3){
    width: 124px;           /* petit rectangle pour l'ID */
    text-align: center;
    margin: auto;
  }

  /* Colonne du milieu (scores) un peu plus compacte */
  #d1_matches th.mid, #d2_matches th.mid{ width: 190px; margin: auto; } /* avant ‚âà230px :contentReference[oaicite:1]{index=1} */

  /* Derni√®re colonne = juste la poubelle, pas d‚Äôespace mort */
  #d1_matches td:last-child, #d2_matches td:last-child{
    width: 1%;
    padding: 4px 6px;
    white-space: nowrap;
  }

  /* R√©duire l√©g√®rement le padding g√©n√©ral des cases */
  #d1_matches td, #d2_matches td{ padding: 8px; }

  /* Champs ID compacts et rectangulaires */
  #d1_matches input.p1, #d1_matches input.p2,
  #d2_matches input.p1, #d2_matches input.p2{
    width: 14ch;            /* tient un pseudo/nom court */
    max-width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
  }

  /* Rapprocher les scores (aller / retour) */
  .scoresCell{ gap: 4px; }              /* avant 6px :contentReference[oaicite:2]{index=2} */
  .compactScores .score input{ width: 40px; } /* avant 44‚Äì52px :contentReference[oaicite:3]{index=3} */
}


  @media (max-width: 380px){
    .row.toolbar{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .row.toolbar .pill{grid-column:1 / -1}
  }
  dialog{border:none;border-radius:14px;max-width:720px;width:min(92vw,720px);padding:0;background:var(--panel);color:var(--text)}
  dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}
</style>

<!-- ====== Saison: wrapper fetch + badge ====== -->
<script>
  let ACTIVE_SEASON = null;
  const urlSeason = new URL(location.href).searchParams.get('season');

  async function initSeasonContext(API, token) {
    try{
      if (urlSeason) {
        ACTIVE_SEASON = urlSeason;
      } else {
        const r = await fetch(`${API}/season/current`, { headers: { Authorization:`Bearer ${token}` }});
        const d = await r.json();
        ACTIVE_SEASON = d.name;
      }
      const spot = document.querySelector('.top .nav');
      if (spot && ACTIVE_SEASON) {
        const b = document.createElement('span');
        b.style.cssText='margin-left:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.9rem;background:rgba(34,197,94,.12);color:#22c55e';
        b.textContent = `Saison: ${ACTIVE_SEASON}`;
        spot.appendChild(b);
      }
    }catch(_){}
  }

  (function patchFetch(){
    const _fetch = window.fetch;
    window.fetch = function(url, opt){
      try{
        const api = (localStorage.getItem('efoot.api') || (location.protocol + '//' + location.hostname + ':3000')).replace(/\/+$/,'');
        let u = (typeof url === 'string') ? url : (url && url.url) || '';
        if (ACTIVE_SEASON && String(u).startsWith(api)) {
          const ru = new URL(u);
          if (!ru.searchParams.has('season')) {
            ru.searchParams.set('season', ACTIVE_SEASON);
            u = ru.toString();
          }
          return _fetch(u, opt);
        }
      }catch(_){}
      return _fetch(url, opt);
    };
  })();

  // Montrer "Mon profil" en premier pour les membres
(function(){
  const r = (localStorage.getItem('efoot.role')||'member').toLowerCase();
  const b = document.getElementById('btnProfile');
  if(b && r !== 'admin'){ b.style.display='inline-flex'; b.parentNode.insertBefore(b, b.parentNode.firstChild); }
})();

// PING pr√©sence pour les membres
(function(){
  const r = (localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!token || r==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:`Bearer ${token}`}})
                    .catch(()=>{});
  ping();
  setInterval(ping, 15000);
})();


</script>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
      <h1 style="margin:0;font-size:16px">GOUZEPE GAMING CLUB <br>Championnat eFootball</h1>
      <span id="season-badge" class="season-badge blink-slow" style="display:none">Saison : <span id="season-text"></span></span>
    </div>
    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" id="btnProfile" href="Panel-Membre.html" style="display:none">üë§ Mon profil</a>
      <a class="btn" href="Classement-general.html" title="Voir le classement g√©n√©ral de la saison">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Admin-Joueurs</a>
      <a class="btn adminOnly" href="Admin-Utilisateurs.html">üõ°Ô∏è Admin-Utilisateurs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <div class="row toolbar" style="margin:12px 0 8px">
    <div class="pill">
      <span>Samedi :</span>
      <input id="samediSelect" type="date" />
    </div>
    <button id="newDay" class="btn warn adminOnly" style="margin-bottom: 8px;">Nouveau (vierge)</button>
    <span style="opacity:.4">|</span>
    <button id="saveBtn" class="btn strong adminOnly" style="margin-bottom: 8px;">Enregistrer & Terminer</button>
    <button id="saveEditBtn" class="btn strong adminOnly" style="display:none">Enregistrer les modifications</button>
  </div>


  <div class="row cards3">
    <section id="d1" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:6px 0">Division 1 ‚Äî Confrontations & Classement</h3>
        <div class="row">
          <button type="button" class="btn primary adminOnly" style="width: 120px; height: 45px;" data-add="d1">+ Match</button>
          <button type="button" class="btn danger adminOnly" style="width: 120px; height: 45px;" data-clear="d1">Effacer scores</button>
        </div>
      </div>
      <div class="muted"  style="font-size: medium;">Confrontations</div>
      <div class="table-wrap">
      <table id="d1_matches" class="compactScores">
        <thead>
          <tr>
            <th>Joueur 1 (ID)</th>
            <th class="mid">Match 1<br><span class="muted" style="font-weight:400">Match 2</span></th>
            <th>Joueur 2 (ID)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <h4 style="margin:14px 0 6px">Classement D1</h4>
      <div class="table-wrap">

      <table id="d1_tab">
        <thead>
          <tr><th>Joueur</th><th>J</th><th>V</th><th>N</th><th>D</th><th>BM</th><th>BC</th><th>Diff</th><th>PTS</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
    </section>

    <section id="d2" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:6px 0">Division 2 ‚Äî Confrontations & Classement</h3>
        <div class="row">
          <button type="button" class="btn primary adminOnly" style="width: 120px; height: 45px;" data-add="d2">+ Match</button>
          <button type="button" class="btn danger adminOnly" style="width: 120px; height: 45px;" data-clear="d2">Effacer scores</button>
        </div>
      </div>
      <div class="muted" style="font-size: medium;">Confrontations</div>
      <div class="table-wrap">
      <table id="d2_matches" class="compactScores">
        <thead>
          <tr>
            <th>Joueur 1 (ID)</th>
            <th class="mid">Match 1<br><span class="muted" style="font-weight:400">Match 2</span></th>
            <th>Joueur 2 (ID)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <h4 style="margin:14px 0 6px">Classement D2</h4>
      <div class="table-wrap">
      <table id="d2_tab">
        <thead>
          <tr><th>Joueur</th><th>J</th><th>V</th><th>N</th><th>D</th><th>BM</th><th>BC</th><th>Diff</th><th>PTS</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
    </section>
  </div>

<section class="card row">
  <h3 style="margin:6px 0">Barrage D2 ‚Üî D1 (Best of 3)</h3>
  <div class="muted">R√®gle : <b>2·µâ D2 (MEMBRE)</b> vs <b>avant-dernier D1 (MEMBRE)</b>. Les INVIT√âS sont exclus.</div>

  <div class="row" style="margin:8px 0">
    <label>Affiche (auto)</label>
    <input id="barrage_ids" list="players" placeholder="ID_D1 (D1) ‚Äì ID_D2 (D2)" style="flex-wrap: wrap;" />
    <button id="b_auto" class="btn adminOnly">‚Ü∫ Proposer</button>
  </div>

  <div class="row" style="grid-template-columns:repeat(3,minmax(100px,1fr));gap:10px">
    <div>
      <div class="muted">Match 1</div>
      <div class="score">
        <input id="b1_a" inputmode="numeric" maxlength="2" />
        <span class="dash">‚Äì</span>
        <input id="b1_b" inputmode="numeric" maxlength="2" />
      </div>
    </div>
    <div>
      <div class="muted">Match 2</div>
      <div class="score">
        <input id="b2_a" inputmode="numeric" maxlength="2" />
        <span class="dash">‚Äì</span>
        <input id="b2_b" inputmode="numeric" maxlength="2" />
      </div>
    </div>
    <div>
      <div class="muted">Match 3</div>
      <div class="score">
        <input id="b3_a" inputmode="numeric" maxlength="2" />
        <span class="dash">‚Äì</span>
        <input id="b3_b" inputmode="numeric" maxlength="2" />
      </div>
    </div>
  </div>

  <div id="b_label" class="muted" style="margin-top:8px">‚Äî</div>

  <div class="row" style="margin-top:10px">
    <label>Notes / commentaires</label>
    <textarea id="notes" style="width:100%;min-height:90px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1020;color:var(--text)"></textarea>
  </div>
</section>

  <datalist id="players"></datalist>
  <div class="foot"><span id="status" class="muted"></span></div>

  <!-- CONFIRM JOURN√âE -->
  <dialog id="confirm">
    <div style="padding:16px;border-bottom:1px solid var(--border);font-weight:700">Confirmer la journ√©e</div>
    <div style="padding:16px">
      <div class="muted" id="c_date"></div>
      <div class="grid two" style="margin-top:8px">
        <div>
          <div><b>Champion D1 :</b> <span id="c_d1">‚Äî</span></div>
          <div class="row" style="margin-top:6px">
            <label style="min-width:80px">√âquipe D1 :</label>
            <input id="t_d1" placeholder="ex: BARCELONE (6 lettres lues)" />
          </div>
        </div>
        <div>
          <div><b>Champion D2 :</b> <span id="c_d2">‚Äî</span></div>
          <div class="row" style="margin-top:6px">
            <label style="min-width:80px">√âquipe D2 :</label>
            <input id="t_d2" placeholder="ex: JUVENTUS (6 lettres lues)" />
          </div>
        </div>
      </div>
      <div style="margin-top:10px"><b>Barrage :</b> <span id="c_bar">‚Äî</span></div>
      <div id="c_err" style="color:#ef4444;margin-top:6px"></div>
    </div>
    <div style="padding:14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" id="c_cancel">Annuler</button>
      <button class="btn strong" id="c_ok">Valider & Enregistrer</button>
    </div>
  </dialog>

  <!-- ADMIN GATE -->
  <dialog id="adminGate">
    <div style="padding:16px;border-bottom:1px solid var(--border);font-weight:700">Validation admin</div>
    <form id="gateForm" style="padding:16px;display:grid;gap:10px">
      <div class="muted">Pour enregistrer la journ√©e, entrez un compte admin.</div>
      <input id="gateEmail" type="email" placeholder="admin@gz.local" required />
      <input id="gatePwd" type="password" placeholder="Mot de passe" required />
      <div id="gateErr" style="color:#ef4444"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:12px">
        <button type="button" class="btn" onclick="document.getElementById('adminGate').close()">Annuler</button>
        <button type="submit" class="btn strong">Valider</button>
      </div>
    </form>
  </dialog>

</div>

<script>
/* ===== helpers / auth ===== */
const $=s=>document.querySelector(s);
const DEF_API=()=>`${location.protocol.startsWith('http')?location.protocol:'http:'}//${location.hostname}:3000`;
const API=(localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const token=localStorage.getItem('efoot.token');
const role =(localStorage.getItem('efoot.role')||'member').toLowerCase();
const expAt=+localStorage.getItem('efoot.expAt')||0;
const __params = new URLSearchParams(location.search);
const EDIT_MODE  = __params.get('edit') === '1';
const DATE_PARAM = __params.get('date');
const IS_ADMIN = (role === 'admin');
window.EDIT_SEASON_ID = (() => {
  const sid = __params.get('sid');
  const n = +sid;
  return Number.isFinite(n) && n > 0 ? n : null;
})();


(function guard(){
  const here = (location.pathname.split('/').pop()||'').toLowerCase();
  const isLogin = here === '' || here === 'login.html';
  if (isLogin) return;
  if (!token || Date.now() >= expAt) {
    location.replace('login.html');
  }
})();
document.querySelectorAll('.adminOnly').forEach(el=>el.style.display=(role==='admin')?'inline-flex':'none');

/* th√®me */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* menu mobile */
(function(){
  const menu=$('#menu'), toggle=$('#menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',()=>open(!menu.classList.contains('open')));
  document.addEventListener('click',(e)=>{
    if(!menu.classList.contains('open'))return;
    if(e.target===toggle||menu.contains(e.target))return;
    open(false);
  },true);
})();

/* logout */
$('#logoutBtn')?.addEventListener('click',()=>{
  if(!confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) return;
  ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
  location.href='login.html';
});

/* ====== √©tat app ====== */
const S={players:{},d1:[],d2:[],barr:{ids:'',m1:{},m2:{},m3:{},label:'‚Äî',notes:''}};
let confirmedDaysList = [];
let CURRENT_CONFIRMED = false;

const getDateKey=()=>($('#samediSelect').value||'').slice(0,10);
const lsKey=()=>`efoot.draft.${getDateKey()}`;
function toast(m){const s=$('#status'); if(!s){console.log(m);return} s.textContent=m; s.style.opacity=1; setTimeout(()=>s.style.opacity=.75,1200)}

/* d√©sactiver/activer la saisie (option: silent pour ne pas montrer de bandeau) */
function setInputsDisabled(disabled, silent=false) {
  const elements = document.querySelectorAll(
    '#d1 input, #d2 input, #barrage_ids, .score input, #notes, textarea, [data-add], [data-clear], #b_auto'
  );
  elements.forEach(el => el.disabled = disabled);

  if (silent) {
    const lockMsg = document.getElementById('lockMessage');
    if (lockMsg) lockMsg.style.display = 'none';
    return;
  }
  let lockMsg = document.getElementById('lockMessage');
  if (!lockMsg) {
    lockMsg = document.createElement('div');
    lockMsg.id = 'lockMessage';
    lockMsg.style.cssText = 'padding:12px; background:var(--warnbg); border:1px solid var(--warn); color:var(--text); border-radius:12px; margin:12px 0; text-align:center; font-weight:bold;';
    const anchor = document.getElementById('ruleLine');
    (anchor?anchor:document.body).insertAdjacentElement(anchor?'beforebegin':'afterbegin', lockMsg);
  }
  lockMsg.style.display = disabled ? 'block' : 'none';
  lockMsg.textContent = disabled ? 'Cette journ√©e est verrouill√©e.' : '';
}

/* Lecture seule stricte pour les MEMBRES (non-admins) ‚Äî sans bandeau */
function enforceReadOnlyForMembers(){
  if (IS_ADMIN) return;
  const selectors = [
    '#d1_matches input', '#d2_matches input',
    '#barrage_ids', '#b1_a', '#b1_b', '#b2_a', '#b2_b', '#b3_a', '#b3_b',
    '#notes',
    '[data-add]', '[data-clear]', '#b_auto',
    '#saveBtn', '#saveEditBtn', '#newDay'
  ];
  document.querySelectorAll(selectors.join(',')).forEach(el => { el.disabled = true; });
  document.querySelectorAll('.adminOnly').forEach(el => { el.style.display = 'none'; });
}

/* maj des boutons selon r√¥le/√©tat */
function updateButtons(){
  const saveBtn     = document.getElementById('saveBtn');
  const saveEditBtn = document.getElementById('saveEditBtn');
  const newDayBtn   = document.getElementById('newDay');

  if (!IS_ADMIN){
    setInputsDisabled(true, /*silent=*/true);
    document.querySelectorAll('.adminOnly').forEach(el=> el.style.display='none');
    if (saveBtn)     saveBtn.style.display='none';
    if (saveEditBtn) saveEditBtn.style.display='none';
    if (newDayBtn)   newDayBtn.style.display='none';
    return;
  }

  if (EDIT_MODE){
    setInputsDisabled(false);
    if (saveBtn)     saveBtn.style.display='none';
    if (saveEditBtn) saveEditBtn.style.display='inline-flex';
    if (newDayBtn)   newDayBtn.style.display='inline-flex';
  } else if (CURRENT_CONFIRMED){
    setInputsDisabled(true);
    if (saveEditBtn) saveEditBtn.style.display='none';
    if (saveBtn){
      saveBtn.style.display='inline-flex';
      saveBtn.textContent='Modifier cette journ√©e';
      saveBtn.onclick = () => {
        const d = getDateKey();
        if (!d) { alert('Date invalide'); return; }
        location.href = 'Accueil.html?date='+encodeURIComponent(d)+'&edit=1';
      };
    }
    if (newDayBtn) newDayBtn.style.display='inline-flex';
  } else {
    setInputsDisabled(false);
    if (saveEditBtn) saveEditBtn.style.display='none';
    if (saveBtn){
      saveBtn.style.display='inline-flex';
      saveBtn.textContent='Enregistrer & Terminer';
      saveBtn.onclick = handleSaveClick;
    }
    if (newDayBtn) newDayBtn.style.display='inline-flex';
  }
}

async function checkDayStatusAndLock() {
  if (confirmedDaysList.length === 0) {
    try {
      const r = await fetch(`${API}/matchdays`, { headers: { 'Authorization': `Bearer ${token}` } });
      const d = await r.json();
      confirmedDaysList = d.days || [];
    } catch (_) {}
  }

  const currentDate = getDateKey();
  const isConfirmed = confirmedDaysList.includes(currentDate);
  CURRENT_CONFIRMED = isConfirmed;

  if (isConfirmed) {
    try {
      const r = await fetch(`${API}/matchdays/${currentDate}`, { headers: { Authorization: `Bearer ${token}` }});
      if (r.ok) {
        const payload = await r.json();
        S.d1 = payload.d1 || [];
        S.d2 = payload.d2 || [];
        S.barr = payload.barrage || S.barr;
        document.getElementById('t_d1').value = (payload.champions?.d1?.team || '').toUpperCase().slice(0,6);
        document.getElementById('t_d2').value = (payload.champions?.d2?.team || '').toUpperCase().slice(0,6);
        rebuild('d1'); rebuild('d2'); computeBarrageLabel(); validateCross();
      }
    } catch(_) {}
  }

  updateButtons();
  enforceReadOnlyForMembers();
}

/* joueurs */
(async ()=>{
  await initSeasonContext(API, token);
  try{
    const r=await fetch(`${API}/players`,{headers:{'Authorization':`Bearer ${token}`}});
    const d=await r.json();
    const dl=$('#players');dl.innerHTML='';
    (d.players||[]).forEach(p=>{
      S.players[p.player_id]={name:p.name,role:p.role};
      const o=document.createElement('option');o.value=p.player_id;o.label=`${p.player_id} ‚Äî ${p.name}`;dl.appendChild(o);
    });
  }catch(_){}
})();

/* calculs */
function addAgg(agg,A,B,ga,gb){
  if(ga==null||gb==null)return;
  if(!agg[A])agg[A]={J:0,V:0,N:0,D:0,BP:0,BC:0};
  if(!agg[B])agg[B]={J:0,V:0,N:0,D:0,BP:0,BC:0};
  agg[A].J++;agg[B].J++;agg[A].BP+=ga;agg[A].BC+=gb;agg[B].BP+=gb;agg[B].BC+=ga;
  if(ga>gb){agg[A].V++;agg[B].D++}else if(ga<gb){agg[B].V++;agg[A].D++}else{agg[A].N++;agg[B].N++}
}
function standings(div){
  const agg={};
  (S[div]||[]).forEach(m=>{
    if(!m.p1||!m.p2) return;
    if(m.a1!=null&&m.a2!=null) addAgg(agg,m.p1,m.p2,m.a1,m.a2);
    if(m.r1!=null&&m.r2!=null) addAgg(agg,m.p2,m.p1,m.r2,m.r1);
  });
  return Object.entries(agg).map(([id,x])=>{
    const PTS=x.V*3+x.N, DIFF=x.BP-x.BC, role=S.players[id]?.role||'MEMBRE';
    return {id,...x,PTS,DIFF,role}
  }).filter(r=>r.role!=='INVITE')
    .sort((a,b)=>b.PTS-a.PTS||b.DIFF-a.DIFF||b.BP-a.BP||a.id.localeCompare(b.id));
}
function renderTable(div){
  const tb=$(`#${div}_tab tbody`);tb.innerHTML='';
  standings(div).forEach(r=>{
    const nm=S.players[r.id]?.name||r.id;
    tb.insertAdjacentHTML('beforeend',`<tr><td>${nm}</td><td>${r.J}</td><td>${r.V}</td><td>${r.N}</td><td>${r.D}</td><td>${r.BP}</td><td>${r.BC}</td><td>${r.DIFF}</td><td>${r.PTS}</td></tr>`);
  });
}
function calculateAndRender(){ renderTable('d1'); renderTable('d2'); autoFillBarrage(true); }

/* UI lignes */
function toInt(v){v=(v??'').toString().trim(); return v===''?null:parseInt(v,10)}
function row(div, m={}){
  const tr=document.createElement('tr');
  tr.innerHTML = `
    <td><input list="players" class="p1" placeholder="ID" value="${m.p1||''}"></td>
    <td class="scoresCell">
      <div class="score">
        <input class="a1" inputmode="numeric" maxlength="2" value="${m.a1??''}">
        <span class="dash">‚Äì</span>
        <input class="a2" inputmode="numeric" maxlength="2" value="${m.a2??''}">
      </div>
      <div class="score">
        <input class="r1" inputmode="numeric" maxlength="2" value="${m.r1??''}">
        <span class="dash">‚Äì</span>
        <input class="r2" inputmode="numeric" maxlength="2" value="${m.r2??''}">
      </div>
    <td><input list="players" class="p2" placeholder="ID" value="${m.p2||''}"></td>
    <td><button type="button" class="btn danger del adminOnly" style="width: 32px; height: 32px; padding: 0;">üóëÔ∏è</button></td>

    </td>
    `;

  document.querySelector(`#${div}_matches tbody`).appendChild(tr);
}

function rebuild(div){
  const tb=$(`#${div}_matches tbody`);tb.innerHTML='';
  (S[div]||[]).forEach(m=>row(div,m));
  if((S[div]||[]).length===0) row(div,{});
  calculateAndRender();

  enforceReadOnlyForMembers();   // IMPORTANT pour emp√™cher la r√©-√©dition apr√®s reconstruction
}
function readFromDOM(div){
  const out=[];
  $(`#${div}_matches tbody`).querySelectorAll('tr').forEach(tr=>{
    const g=s=>tr.querySelector(s);
    out.push({
      p1:g('.p1')?.value.trim()||'', p2:g('.p2')?.value.trim()||'',
      a1:toInt(g('.a1')?.value), a2:toInt(g('.a2')?.value),
      r1:toInt(g('.r1')?.value), r2:toInt(g('.r2')?.value),
      el:tr
    });
  });
  out.forEach(m=>{
    const bad = m.p1 && m.p2 && m.p1===m.p2;
    m.el.classList.toggle('bad',bad);
    if(bad){ m.a1=m.a2=m.r1=m.r2=null; }
  });
  S[div]=out.map(({el,...rest})=>rest);
}

/* d√©l√©gu√©s (inputs + delete) */
function onInput(e){
  if (!IS_ADMIN) return;   // blocage pour les membres
  const t=e.target; 
  const div=t.closest('#d1_matches')?'d1':t.closest('#d2_matches')?'d2':null;
  if(!div) return;
  readFromDOM(div); calculateAndRender(); autoSaveDebounced(); validateCross();
}
function onClick(e){
  if (!IS_ADMIN) return;   // blocage pour les membres
  const del=e.target.closest('.del'); 
  if(del){
    if(!confirm('Supprimer cette ligne de match ?')) return;
    const div=del.closest('#d1_matches')?'d1':'d2';
    del.closest('tr').remove(); readFromDOM(div); calculateAndRender(); autoSaveDebounced(); validateCross(); 
  }
}
document.addEventListener('input',onInput,true);
document.addEventListener('click',onClick,true);

document.querySelectorAll('[data-add]').forEach(b => b.onclick = () => {
  if (!IS_ADMIN) return;
  const div = b.dataset.add;
  row(div, {});
  readFromDOM(div);
  autoSaveDebounced();
});
document.querySelectorAll('[data-clear]').forEach(b=>b.onclick=()=>{ 
  if(!IS_ADMIN){ alert('R√©serv√© admin'); return; }
  if(!confirm('Effacer tous les scores de cette division ?')) return; 
  $(`#${b.dataset.clear}_matches tbody`).querySelectorAll('input').forEach(i=>{if(!i.classList.contains('p1')&&!i.classList.contains('p2')) i.value=''}); 
  readFromDOM(b.dataset.clear); calculateAndRender(); autoSaveDebounced(); 
});

/* barrage */
function autoFillBarrage(force){
  const fld=$('#barrage_ids');
  if(!force && (fld.value||'').trim()) return;
  const d2=standings('d2'), d1=standings('d1');
  const d2second=d2[1]?.id, d1avant=d1.length>=2?d1[d1.length-2].id:null;
  if(d1avant&&d2second) fld.value=`${d1avant} ‚Äì ${d2second}`;
  computeBarrageLabel();
}
function toIntInput(a,b){const A=toInt($(a).value),B=toInt($(b).value);return (A!=null&&B!=null)?{A,B}:null}
function computeBarrageLabel(){
  const [id1,id2]=($('#barrage_ids').value||'').split(/[-‚Äì]/).map(s=>s.trim());
  const m1=toIntInput('#b1_a','#b1_b'),m2=toIntInput('#b2_a','#b2_b'),m3=toIntInput('#b3_a','#b3_b');
  let wD1=0,wD2=0;const add=m=>{if(!m)return;if(m.A>m.B)wD1++;else if(m.A<m.B)wD2++};
  add(m1);add(m2);add(m3);
  let label='‚Äî';
  if(id1&&id2){
    if(wD1>=2) label=`${id1} se maintient en D1 ¬∑ ${id2} reste en D2`;
    else if(wD2>=2) label=`${id2} monte en D1 ¬∑ ${id1} est rel√©gu√© en D2`;
    else label=`Affiche : ${id1} ‚Äì ${id2}`;
  }
  S.barr={ids:($('#barrage_ids').value||'').trim(),m1:m1||{},m2:m2||{},m3:m3||{},label,notes:$('#notes').value||''};
  $('#b_label').textContent=label;
}
['#barrage_ids','#b1_a','#b1_b','#b2_a','#b2_b','#b3_a','#b3_b','#notes'].forEach(sel=>$(sel).addEventListener('input',()=>{
  if (!IS_ADMIN) return;
  computeBarrageLabel();autoSaveDebounced()
}));
$('#b_auto').onclick=()=>{ if(!IS_ADMIN) return; autoFillBarrage(true);autoSaveDebounced() };

/* cross-division */
function validateCross(){
  const d1IDs=new Set(), d2IDs=new Set();
  S.d1.forEach(m=>{ if(m.p1) d1IDs.add(m.p1); if(m.p2) d1IDs.add(m.p2); });
  S.d2.forEach(m=>{ if(m.p1) d2IDs.add(m.p1); if(m.p2) d2IDs.add(m.p2); });
  const both=[...d1IDs].filter(x=>d2IDs.has(x));
  const rl = $('#ruleLine');
  if (rl){
    rl.innerHTML = both.length
      ? `<span style="color:#fca5a5"><b>Conflit :</b> ${both.join(', ')} est √† la fois en D1 et en D2.</span>`
      : `Saisis les affiches avec les <b>ID joueurs</b>. Classements D1/D2 se recalculent (3 pts V, 1 N). <b>Les INVIT√âS ne sont pas class√©s</b> mais leurs matchs comptent pour l‚Äôadversaire.`;
  }
  return both;
}

/* util : lignes incompl√®tes */
function findIncompleteRows(div){
  const rows = S[div]||[];
  const bad = [];
  rows.forEach((m,i)=>{
    const hasPlayers = (m.p1||'').trim() || (m.p2||'').trim();
    const filledPlayers = (m.p1||'').trim() && (m.p2||'').trim();
    const anyScore = [m.a1,m.a2,m.r1,m.r2].some(v=>v!=null);
    const allScores = [m.a1,m.a2,m.r1,m.r2].every(v=>v!=null);
    const something = hasPlayers || anyScore;
    if (something && !(filledPlayers && allScores)) bad.push(i+1);
  });
  return bad;
}

/* bouton principal : ouvrir la modale */
function handleSaveClick(){
  if (!IS_ADMIN) return;
  readFromDOM('d1'); readFromDOM('d2');

  const allEmpty = (S.d1.concat(S.d2)).every(m => !m.p1 && !m.p2 && m.a1==null && m.a2==null && m.r1==null && m.r2==null);
  if (allEmpty){ alert('Veuillez remplir la journ√©e avant d‚Äôenregistrer.'); return; }

  const incD1 = findIncompleteRows('d1');
  const incD2 = findIncompleteRows('d2');
  if (incD1.length || incD2.length){
    let msg = 'Merci de compl√©ter toutes les cases :\n';
    if (incD1.length) msg += `- D1, lignes : ${incD1.join(', ')}\n`;
    if (incD2.length) msg += `- D2, lignes : ${incD2.join(', ')}`;
    alert(msg); return;
  }

  const conflicts=validateCross();
  if(conflicts.length){ alert('Conflit D1/D2 : ' + conflicts.join(', ')); return; }

  calculateAndRender();
  const st1=standings('d1'), st2=standings('d2');
  $('#c_d1').textContent = st1[0]?.id || '‚Äî';
  $('#c_d2').textContent = st2[0]?.id || '‚Äî';
  $('#c_date').textContent = `Samedi : ${new Date(getDateKey()).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})}`;
  $('#c_bar').textContent = S.barr.label || '‚Äî';
  $('#c_err').textContent = '';
  $('#confirm').showModal();
}

/* valider dans la modale */
$('#c_cancel').onclick=()=>$('#confirm').close();
$('#c_ok').onclick=async ()=>{
  try{
    if (!IS_ADMIN) return;
    if (EDIT_MODE){ $('#c_err').textContent='√âcrasement en cours‚Ä¶'; }
    const adminJwt = token; // admin d√©j√† logg√©
    await persistDay(adminJwt);
    $('#confirm').close();
    toast('Journ√©e enregistr√©e');

    confirmedDaysList.push(getDateKey());
    CURRENT_CONFIRMED = true;
    updateButtons();

    await clearDraftRemote();
    localStorage.removeItem(lsKey());
  } catch(e) {
    $('#c_err').textContent = e.message || 'Erreur';
  }
};

/* bouton √©dition : √©crasement direct */
document.getElementById('saveEditBtn')?.addEventListener('click', async ()=>{
  if (!IS_ADMIN) return;
  readFromDOM('d1'); readFromDOM('d2');
  const conflicts = validateCross();
  if (conflicts.length){ alert('Conflit D1/D2 : ' + conflicts.join(', ')); return; }
  const date = getDateKey(); if (!date){ alert('Date invalide'); return; }
  if (!confirm(`√âcraser la journ√©e du ${new Date(date).toLocaleDateString('fr-FR')} ?`)) return;
  try{
    const adminJwt = token;
    await persistDay(adminJwt);
    toast('Modifications enregistr√©es (journ√©e √©cras√©e)');
    confirmedDaysList = Array.from(new Set([...(confirmedDaysList||[]), date]));
    await clearDraftRemote();
    localStorage.removeItem(lsKey());
  }catch(e){ alert(`√âchec de l'√©crasement : ${e.message || 'Erreur'}`); }
});

/* admin gate (garde pour compat si jamais tu veux autoriser non-admin √† valider via gate) */
async function askAdminToken(){ return null; }

/* autosave + synchro */
const debounce=(fn,ms=2000)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function snapshot(){
  return {
    date:getDateKey(),
    d1:S.d1,d2:S.d2,
    barrage:{...S.barr},
    champions:{
      d1:{team:($('#t_d1').value||'').slice(0,6).toUpperCase()},
      d2:{team:($('#t_d2').value||'').slice(0,6).toUpperCase()}
    }
  }
}
const autoSaveDebounced=debounce(autoSave,2000);
async function autoSave(){
  if (!IS_ADMIN) return;
  const data=snapshot();
  if(!data.date) return;
  localStorage.setItem(lsKey(),JSON.stringify(data));
  try{
    let r=await fetch(`${API}/matchdays/draft/${data.date}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(data)});
    if(!r.ok) throw new Error();
    if(window.socketIO){ window.socketIO.emit('draft:update',{date:data.date}); }
  }catch(_){}
}
async function clearDraftRemote(){
  try{await fetch(`${API}/matchdays/draft/${getDateKey()}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}})}catch(_){}
}

/* polling 3s */
let lastRev='';
async function pollDraft(){
  const day=getDateKey(); if(!day) return;
  try{
    const r=await fetch(`${API}/matchdays/draft/${day}`,{headers:{'Authorization':`Bearer ${token}`}});
    if(!r.ok) return;
    const data=await r.json();
    const rev = JSON.stringify(data.payload||{});
    if(rev!==lastRev){
      lastRev=rev;
      const d=data.payload||{};
      S.d1=d.d1||[]; S.d2=d.d2||[]; S.barr=d.barrage||S.barr;
      rebuild('d1'); rebuild('d2'); computeBarrageLabel(); validateCross();
      enforceReadOnlyForMembers(); // IMPORTANT apr√®s synchro
    }
  }catch(_){}
}

/* socket client lazy */
(function loadIO(){
  const s=document.createElement('script');
  s.src=`${API}/socket.io/socket.io.js`; s.async=true;
  s.onload=setupSocket;
  document.head.appendChild(s);
})();
function setupSocket(){
  if(!window.io) return;
  try{
    const socket = window.io(API, { transports:['websocket','polling'] });
    window.socketIO = socket;
    const join = ()=> socket.emit('join',{ room:`draft:${getDateKey()}` });
    socket.on('connect', join);
    document.getElementById('samediSelect').addEventListener('change', ()=>{ join(); pollDraft(); });
    socket.on('draft:update', payload=>{ if(!payload || payload.date!==getDateKey()) return; lastRev=''; pollDraft(); });
    ['day:confirmed','day:deleted','season:changed','season:closed','season:opened'].forEach(evt=>{
      socket.on(evt, ()=>{ confirmedDaysList = []; checkDayStatusAndLock(); });
    });
  }catch(_){}
}

/* persist final */
async function persistDay(adminJwt){
  const st1=standings('d1'), st2=standings('d2');
  const payload=snapshot();
  payload.champions.d1.id=st1[0]?.id||null;
  payload.champions.d2.id=st2[0]?.id||null;
  const [id1,id2]=($('#barrage_ids').value||'').split(/[-‚Äì]/).map(s=>s.trim());
  payload.champions.barrage={label:S.barr.label,ids:{d1:id1||null,d2:id2||null},matches:[S.barr.m1,S.barr.m2,S.barr.m3]};
  const r=await fetch(`${API}/matchdays/confirm`,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminJwt}`},
body: JSON.stringify({
  ...payload,
  date: getDateKey(),
  ...(window.EDIT_SEASON_ID ? { season_id: window.EDIT_SEASON_ID } : {})
})
  });
  const d=await r.json().catch(()=>({})); 
  if(!r.ok) throw new Error(d.error||`${r.status} ${r.statusText}`);
  return d;
}

/* nouveau (vierge) */
$('#newDay').onclick=async ()=>{
  if(!IS_ADMIN){ alert('R√©serv√© admin'); return; }
  if(!confirm('Cr√©er une page VIERGE pour ce samedi ? (efface brouillons local + serveur)')) return;
  S.d1=[]; S.d2=[]; $('#barrage_ids').value=''; ['b1_','b2_','b3_'].forEach(p=>{ $(`#${p}a`).value=''; $(`#${p}b`).value='' }); $('#notes').value='';
  rebuild('d1'); rebuild('d2'); computeBarrageLabel(); validateCross();
  await clearDraftRemote(); localStorage.removeItem(lsKey());
  autoSaveDebounced();
};

/* init */
(async function init(){
  const url=new URL(location.href);
  const qd=url.searchParams.get('date');
  if(qd){ $('#samediSelect').value=qd; }
  else {
    const t=new Date(), d=new Date(t); const w=t.getDay(); d.setDate(t.getDate()+((6-w+7)%7)); $('#samediSelect').value=d.toISOString().slice(0,10);
  }

  try{
    const txt=localStorage.getItem(lsKey());
    if(txt){
      const data=JSON.parse(txt);
      S.d1=data.d1||[]; S.d2=data.d2||[]; S.barr=data.barrage||S.barr;
    }
  }catch(_){}
  rebuild('d1'); rebuild('d2'); computeBarrageLabel(); validateCross();

  if (EDIT_MODE && IS_ADMIN && DATE_PARAM) {
    const d = DATE_PARAM.slice(0,10);
    $('#samediSelect').value = d;
    try {
      const r = await fetch(`${API}/matchdays/${d}`, { headers: { Authorization: `Bearer ${token}` }});
      if (r.ok) {
        const payload = await r.json();
        S.d1 = payload.d1 || [];
        S.d2 = payload.d2 || [];
        S.barr = payload.barrage || S.barr;
        if (payload.champions) {
          document.getElementById('t_d1').value = (payload.champions.d1?.team||'').toUpperCase().slice(0,6);
          document.getElementById('t_d2').value = (payload.champions.d2?.team||'').toUpperCase().slice(0,6);
        }
        rebuild('d1'); rebuild('d2'); computeBarrageLabel(); validateCross();
      }
    } catch(_){}
  }

  await checkDayStatusAndLock();
  $('#samediSelect').addEventListener('change', checkDayStatusAndLock);

  pollDraft(); setInterval(pollDraft,3000);

  // lecture seule imm√©diate pour membres
  enforceReadOnlyForMembers();
})();

(function(){
  const role = (localStorage.getItem('efoot.role') || 'member').toLowerCase();
  const btn = document.getElementById('btnProfile');
  const lm  = document.getElementById('linkMembers');
  const menu = document.getElementById('menu');

  if (role === 'admin') {
    if (btn) btn.style.display = 'none';
    if (lm)  lm.textContent = 'üë• Admin-Joueurs';
  } else {
    if (btn) {
      btn.style.display = 'inline-flex';
      btn.href = 'Panel-Membre.html';
      // le mettre en premier dans le menu
      if (menu && btn.parentNode === menu) menu.insertBefore(btn, menu.firstChild);
    }
    if (lm) {
      lm.textContent = 'üë• Liste des membres';
      lm.href = 'Admin-Joueurs.html'; // m√™me page, mais en lecture seule c√¥t√© membre
    }
  }
})();

window.addEventListener('pageshow', checkDayStatusAndLock);
</script>
<script>
  (function showSeasonBadge(){
    const season = (window.ACTIVE_SEASON || localStorage.getItem('ACTIVE_SEASON') || window.currentSeason || '').toString().trim();
    const badge = document.getElementById('season-badge');
    const text = document.getElementById('season-text');
    if (season && badge && text){
      text.textContent = season;
      badge.style.display = 'inline-flex';
    }
  })();
</script>
<footer style="text-align: center; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

</body>
</html>
