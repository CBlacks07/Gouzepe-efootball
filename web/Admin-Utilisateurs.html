<!-- Admin-Utilisateurs.html -->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>GOUZEPE eFOOTBALL ‚Äî Admin Utilisateurs</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="mobile.css">
<link rel="stylesheet" href="common.css">
<meta name="color-scheme" content="dark light">
<script src="common.js"></script>


<style>
  :root{
    --bg:#0b1220;--panel:#0f1627;--card:#0c1426;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
    --accent:#2563eb; --ok:#14532d;--okbg:#0b1610;--warn:#7c2d12;--warnbg:#1a120b;--danger:#7f1d1d;--brand:#16a34a;
    --pad:clamp(12px,2.5vw,22px);
  }
  :root.light{--bg:#f4f6fb;--panel:#ffffff;--card:#ffffff;--text:#0f172a;--muted:#475569;--border:#e2e8f0;--accent:#2563eb;--brand:#16a34a}

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Trebuchet MS",sans-serif;
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.12), transparent 40%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.10), transparent 40%),
      linear-gradient(180deg, rgba(7,10,22,.94), rgba(15,23,42,.96)),
      url('assets/icons/apple-touch-icon.png') center/cover fixed no-repeat;
  }
  html.light body{
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.18), transparent 42%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.16), transparent 42%),
      linear-gradient(180deg, rgba(255,255,255,.86), rgba(245,247,251,.92)),
      url('assets/icons/apple-touch-icon.png') center/cover fixed no-repeat;
  }

  .wrap{max-width:1100px;margin:auto;padding:12px}

  /* ===== TOP ===== */
  .top{
    position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:12px;
    padding:10px var(--pad);background:rgba(10,14,22,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)
  }
  html.light .top{background:rgba(255,255,255,.75)}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;user-select:none}
  .logo{width:42px;height:42px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#0d1420}
  .brand-title{display:flex;flex-direction:column;line-height:1.1}
  .brand-title h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:800}
  .season-sub{margin:0;color:var(--muted);font-size:12px}
  #menuToggle{display:none;flex:0 0 auto;appearance:none;border:1px solid var(--border);background:transparent;color:inherit;border-radius:10px;padding:8px 10px;align-items:center;gap:8px}
  .nav{display:flex;align-items:center;gap:8px;overflow-x:auto;padding:4px 0;scrollbar-width:thin;-webkit-overflow-scrolling:touch}
  #menu{display:flex;gap:8px}
  .spacer{flex:1 1 auto} .tiny{font-size:12px;opacity:.8}
  @media (max-width: 900px){
    #menuToggle{display:inline-flex}
    .nav{display:none}
    .top.nav-open .nav{display:flex}
  }

  /* === Menu Mobile Moderne === */
  #mobileMenu{
    position:fixed; inset:0; z-index:60;
    background:rgba(0,0,0,.65); backdrop-filter:blur(4px);
    display:flex; align-items:flex-start; justify-content:center;
    padding:0; opacity:0; pointer-events:none;
    transition:opacity .25s ease;
  }
  #mobileMenu:not([hidden]){ opacity:1; pointer-events:auto; }
  #mobileMenu[hidden]{ display:none }

  .mm-panel{
    width:min(94vw,400px); margin-top:0;
    background:var(--panel); color:var(--text);
    border:none; border-bottom-left-radius:16px; border-bottom-right-radius:16px;
    box-shadow:0 8px 32px rgba(0,0,0,.4);
    padding:0; max-height:90vh; overflow-y:auto;
    transform:translateY(-100%); transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #mobileMenu:not([hidden]) .mm-panel{ transform:translateY(0); }

  .mm-title{
    font-weight:800; text-align:center; padding:16px;
    border-bottom:1px solid var(--border); margin:0;
    position:sticky; top:0; background:var(--panel); z-index:1;
  }
  .mm-list{display:flex; flex-direction:column; gap:0; padding:8px;}
  .mm-btn{
    display:flex; align-items:center; justify-content:flex-start; gap:12px;
    padding:14px 16px; border-radius:12px; border:none;
    background:transparent; color:inherit; text-decoration:none; font-weight:600;
    transition:background .2s ease;
  }
  .mm-btn:hover, .mm-btn:active{ background:rgba(255,255,255,.06); }
  .mm-theme{display:flex; justify-content:center; padding:8px 16px; border-top:1px solid var(--border);}
  .mm-logout{display:flex; justify-content:center; padding:12px 16px; border-top:1px solid var(--border);}
  .mm-logout .btn{background:rgba(239,68,68,.12);border-color:#7f1d1d;color:#fca5a5; width:100%;}
  @media (min-width:841px){ #mobileMenu{ display:none !important } .menu-toggle{ display:none; } }

  @media (min-width: 900px){
    .menu-toggle{display:none !important}
    .nav-desktop{display:flex !important}
  }

  /* ===== Boutons boost (sombre & clair) ===== */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:600;border:1px solid var(--border);background:transparent;color:inherit;text-decoration:none;line-height:1;white-space:nowrap;transition:filter .15s,transform .02s}
  .btn:hover{filter:brightness(1.1)} .btn:active{transform:translateY(1px)}
  .btn.primary{background:rgba(22,163,74,.15);border-color:#1e3a2f}
  .btn.info{background:rgba(59,130,246,.14);border-color:#1e3a8a}
  .btn.warn{background:rgba(245,158,11,.14);border-color:#7c2d12}
  .btn.ghost{background:transparent}
  .btn.danger{background:#2a0c0c;border-color:var(--danger);color:#fecaca}
  html.light .btn.primary{background:#16a34a;border-color:#15803d;color:#fff}
  html.light .btn.danger{background:#dc2626;border-color:#b91c1c;color:#fff}

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.24)}
  html.light .card{box-shadow:0 8px 24px rgba(2,6,23,.08)}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px dashed var(--border);border-radius:999px;font-weight:600;opacity:.9}
  .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
  .badge-top{display:none}
  select,input{border:1.5px solid var(--border);border-radius:12px;padding:10px 12px;background:#0b1020;color:var(--text)}
  html.light select,html.light input{background:#fff;border-color:#cbd5e1}

  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  th{color:var(--muted)}
  html.light th{background:#f1f5f9;border-bottom:1px solid #e2e8f0}
  html.light td{border-bottom:1px solid #eef2f7}

  dialog{border:none;border-radius:14px;max-width:520px;width:min(92vw,520px);padding:0;background:var(--panel);color:var(--text)}
  dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}

  .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  #status{transition:opacity .25s}
</style>
</head>
<body class="container">
<div class="wrap">

  <!-- ===== TOP ===== -->
  <header class="top" id="topbar">
    <a class="brand" href="./Accueil.html" aria-label="Accueil GOUZEPE">
      <img id="clubLogo" class="logo" src="assets/icons/apple-touch-icon.png" alt="Logo">
      <div class="brand-title">
        <h1>GOUZEPE eFOOTBALL</h1>
        <div class="season-sub"><span id="season-text" style="color: #16a34a; font-weight: bold;">Saison</span></div>
      </div>
    </a>

    <button id="menuToggle" class="btn ghost" aria-controls="menu" aria-expanded="false" title="Ouvrir le menu de navigation">‚ò∞ Menu</button>
    <nav class="nav" aria-label="Navigation principale">
      <div id="menu">
        <a class="btn ghost" href="./Duel.html">üí™üèΩ Duel</a>
        <a class="btn ghost" href="./Classement-general.html">üìä Classements</a>
        <a class="btn ghost" href="./Tournois.html">üèÜ Tournois</a>
        <a class="btn ghost" href="./Panel-Membre.html">üë§ Mon espace</a>
        <a class="btn ghost adminNav" href="./Admin-Joueurs.html" style="display:none">üë• Admin-Joueurs</a>
        <a class="btn ghost adminNav" href="./Admin-Utilisateurs.html" style="display:none">üõ°Ô∏è Admin Utilisateurs</a>
        <button id="logoutBtn" class="btn ghost danger" type="button" title="Se d√©connecter de votre compte">D√©connexion</button>
      </div>
    </nav>

    <div class="spacer"></div>
    <div id="season-badge" class="badge badge-top"><span class="dot"></span><span id="season-top">Saison</span></div>

    <button id="theme" class="btn ghost" title="Th√®me clair/sombre">‚òÄÔ∏è/üåô</button>

    <!-- Menu Mobile Moderne -->
<div id="mobileMenu" hidden>
  <div class="mm-panel" role="dialog" aria-modal="true" aria-labelledby="mmTitle">
    <div id="mmTitle" class="mm-title">
      <span>Menu</span>
      <button id="mmClose" class="btn ghost" style="position:absolute;right:12px;top:12px;padding:6px 10px;font-size:18px;line-height:1" aria-label="Fermer" title="Fermer le menu">‚úï</button>
    </div>
    <div class="mm-list">
      <a class="mm-btn" href="./Duel.html">üí™üèΩ Duel</a>
      <a class="mm-btn" href="./Classement-general.html">üìä Classements</a>
      <a class="mm-btn" href="./Tournois.html">üèÜ Tournois</a>
      <a class="mm-btn" href="./Panel-Membre.html">üë§ Mon espace</a>
      <a class="mm-btn adminOnly" id="mmAdminPlayers" href="./Admin-Joueurs.html" style="display:none">üë• Admin-Joueurs</a>
    </div>
    <div class="mm-theme"><button id="mmTheme" class="btn ghost" title="Basculer entre th√®me clair et sombre">‚òÄÔ∏è / üåô Th√®me</button></div>
    <div class="mm-logout"><button id="mmLogout" class="btn danger" title="Se d√©connecter de votre compte">D√©connexion</button></div>
  </div>
</div>

  </header>

  <!-- Cr√©ation -->
  <section class="card" style="margin-top:12px">
    <h3 style="margin:6px 0">Cr√©er un utilisateur</h3>
    <div class="row">
      <input id="emailNew" placeholder="email (ex: admin@gz ou user)" style="min-width:220px;flex:1">
      <input id="pwdNew" type="password" placeholder="mot de passe" style="min-width:180px">
      <select id="roleNew">
        <option value="member">member</option>
        <option value="admin">admin</option>
      </select>
      <button id="addBtn" class="btn primary" title="Cr√©er un nouvel utilisateur">Ajouter</button>
    </div>
    <div class="muted" style="margin-top:6px">Astuce : si vous ne mettez pas de domaine, <code>@gz.local</code> sera ajout√© automatiquement.</div>
  </section>

  <!-- Liste + outils -->
  <section class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:6px 0">Utilisateurs enregistr√©s</h3>
      <div class="row">
        <input id="search" placeholder="Rechercher (email)‚Ä¶" style="min-width:220px">
        <button id="refresh" class="btn" title="Recharger la liste des utilisateurs depuis le serveur">Rafra√Æchir</button>
      </div>
    </div>

    <div class="table-wrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch">
      <table id="tbl">
        <thead>
          <tr>
            <th>Email</th>
            <th>R√¥le</th>
            <th>Player ID</th>
            <th>Cr√©√©</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="foot"><span id="status" class="muted"></span></div>
  </section>

  <!-- Modal √©dition -->
  <dialog id="editDlg">
    <div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700">Modifier l'utilisateur</div>
    <form id="editForm" style="padding:14px;display:grid;gap:10px">
      <input type="hidden" id="editId">
      <label>Email
        <input id="editEmail" required>
      </label>
      <label>R√¥le
        <select id="editRole">
          <option value="member">member</option>
          <option value="admin">admin</option>
        </select>
      </label>
      <label>Player ID (optionnel)
        <input id="editPlayerId" placeholder="Exemple: GPG-001">
      </label>
      <label>Nouveau mot de passe (optionnel)
        <input id="editPwd" type="password" placeholder="laisser vide pour ne pas changer">
      </label>
      <div id="editErr" style="color:#ef4444"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:12px">
        <button type="button" class="btn" onclick="document.getElementById('editDlg').close()" title="Annuler et fermer sans enregistrer">Annuler</button>
        <button type="submit" class="btn primary" title="Enregistrer les modifications de l'utilisateur">Enregistrer</button>
      </div>
    </form>
  </dialog>

</div>

<script>
/* ===== Bootstrap minimal si common.js absent ===== */
(function boot(){
  window.$ = (s)=>document.querySelector(s);
  const DEF_API = ()=> `${location.protocol.startsWith('http')?location.protocol:'http:'}//${location.hostname}:3005`;
  window.API   = window.API   || (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
  window.token = window.token || localStorage.getItem('efoot.token');
  window.role  = window.role  || (localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!window.token){ location.href='login.html'; }
})();

/* ===== Th√®me + menu + d√©connexion (fallback robuste) ===== */
(function themeAndMenu(){
  // th√®me
  const k='efoot.theme';
  const btn = document.getElementById('theme');
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);if(btn) btn.textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  btn?.addEventListener('click',()=>apply(document.documentElement.classList.contains('light')?'dark':'light'));

  // Menu Mobile Moderne
  const sheet = document.getElementById('mobileMenu');
  const toggleBtn = document.getElementById('menuToggle');
  const closeBtn = document.getElementById('mmClose');
  if(sheet && toggleBtn){
    const open = ()=>{ sheet.hidden=false; document.body.style.overflow='hidden'; };
    const close= ()=>{ sheet.hidden=true;  document.body.style.overflow=''; };

    toggleBtn.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
    closeBtn?.addEventListener('click', close);
    sheet.addEventListener('click', (e)=>{ if(e.target===sheet) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !sheet.hidden) close(); });

    // Synchronise avec les contr√¥les existants
    document.getElementById('mmTheme').onclick = ()=> document.getElementById('theme').click();
    document.getElementById('mmLogout').onclick = ()=> document.getElementById('logoutBtn').click();
  }

  // logout (confirm)
  document.getElementById('logoutBtn')?.addEventListener('click',()=>{
    if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
      ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
      location.href='login.html';
    }
  });
})();

/* ===== Helpers locaux ===== */
const EMAIL_DOMAIN = localStorage.getItem('efoot.emailDomain') || 'gz.local';
function toast(m){ const s=$('#status'); if(!s){ console.log(m); return; } s.textContent=m; s.style.opacity=1; setTimeout(()=>s.style.opacity=.75,1200); }
function normEmail(x){ x=(x||'').trim(); if(!x) return x; if(x.includes('@')) return x.toLowerCase(); return (x+'@'+EMAIL_DOMAIN).toLowerCase(); }
function fmtDate(s){ try{ const d=new Date(s); return d.toLocaleString('fr-FR'); } catch(_){ return s||''; } }
function escapeHtml(t){ return String(t??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===== CRUD Users ===== */
let USERS=[];
async function loadUsers(){
  try{
    const r=await fetch(`${API}/admin/users`,{headers:{'Authorization':`Bearer ${token}`}});
    const d=await r.json();
    USERS = d.users||[];
    renderUsers();
  }catch(_){ toast('Chargement √©chou√©'); }
}
function renderUsers(){
  const q=($('#search').value||'').toLowerCase();
  const rows = USERS.filter(u=>(u.email||'').toLowerCase().includes(q));
  const tb=$('#tbl tbody'); tb.innerHTML='';
  rows.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      `<td>${escapeHtml(u.email||'')}</td>
       <td>${escapeHtml(u.role||'')}</td>
       <td>${escapeHtml(u.player_id||'‚Äî')}</td>
       <td class="muted">${escapeHtml(fmtDate(u.created_at||u.createdAt||''))}</td>
       <td>
         <button class="btn primary" data-edit="${u.id}">Modifier</button>
         <button class="btn danger" data-del="${u.id}">Supprimer</button>
       </td>`;
    tb.appendChild(tr);
  });
}

/* list actions */
document.getElementById('refresh').addEventListener('click', loadUsers);
document.getElementById('search').addEventListener('input', renderUsers);

/* add */
document.getElementById('addBtn').onclick=async ()=>{
  const email = normEmail($('#emailNew').value);
  const password = ($('#pwdNew').value||'').trim();
  const role = $('#roleNew').value;
  if(!email || !password){ return toast('Email et mot de passe requis'); }
  const btn=$('#addBtn'); btn.disabled=true; btn.textContent='Ajout‚Ä¶';
  try{
    const r=await fetch(`${API}/admin/users`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body:JSON.stringify({email,password,role})
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d.error||`Erreur ${r.status}`);
    $('#emailNew').value=''; $('#pwdNew').value='';
    toast('Utilisateur ajout√©'); await loadUsers();
  }catch(e){ toast(e.message||'Erreur'); }
  finally{ btn.disabled=false; btn.textContent='Ajouter'; }
};

/* edit open */
document.addEventListener('click', e=>{
  const id = e.target?.dataset?.edit;
  if(id){
    const u = USERS.find(x=>String(x.id)===String(id));
    if(!u) return;
    $('#editId').value = u.id;
    $('#editEmail').value = u.email||'';
    $('#editRole').value = (u.role||'member');
    $('#editPlayerId').value = u.player_id||'';
    $('#editPwd').value = '';
    $('#editErr').textContent='';
    $('#editDlg').showModal();
  }
});

/* edit submit */
document.getElementById('editForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = $('#editId').value;
  const email = normEmail($('#editEmail').value);
  const role  = $('#editRole').value;
  const playerId = $('#editPlayerId').value.trim();
  const pwd   = $('#editPwd').value.trim();
  const body = { email, role };
  if(playerId) body.player_id = playerId;
  if(pwd) body.password = pwd;
  try{
    const r=await fetch(`${API}/admin/users/${encodeURIComponent(id)}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body:JSON.stringify(body)
    });
    const d=await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d.error||'√âchec modification');
    $('#editDlg').close(); toast('Utilisateur modifi√©'); await loadUsers();
  }catch(err){ $('#editErr').textContent = err.message||'Erreur'; }
});

/* delete */
document.addEventListener('click', async e=>{
  const id = e.target?.dataset?.del;
  if(!id) return;
  if(!confirm('Supprimer cet utilisateur ?')) return;
  try{
    const r=await fetch(`${API}/admin/users/${encodeURIComponent(id)}`,{
      method:'DELETE', headers:{'Authorization':`Bearer ${token}`}
    });
    if(!r.ok){
      const d=await r.json().catch(()=>({}));
      throw new Error(d.error||'√âchec suppression');
    }
    toast('Utilisateur supprim√©'); await loadUsers();
  }catch(err){ toast(err.message||'Erreur'); }
});

/* sockets (auto-refresh) */
(function setupSocket(){
  try{
    const s=document.createElement('script'); s.src=`${API}/socket.io/socket.io.js`;
    s.onload=()=>{
      const u=new URL(API); const ws=`${u.protocol}//${u.hostname}:${u.port||'3000'}`;
      const socket=window.io(ws,{transports:['websocket','polling']});
      socket.on('users:changed', ()=>loadUsers());
    };
    document.head.appendChild(s);
  }catch(_){}
})();

/* init */
(async function init(){ await loadUsers(); })();
</script>

<footer style="text-align:center;font-family:'Gill Sans','Gill Sans MT',Calibri,'Trebuchet MS',sans-serif;">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

<!-- === GOUZEPE additive patch (non-destructif) === -->
<script>
(function(){
  try{
    const isPrivateNet=(h)=>/^(localhost|127\.0\.0\.1|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[01])\.\d+\.\d+)$/.test(h||'');
    const DEF_API=()=>{
      const host=location.hostname||'localhost';
      return (location.protocol.startsWith('http')?location.protocol:'http:')+'//'+host+':3005';
    };
    if(!window.API){ window.API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,''); }
    // Auth guard
    (function(){
      const here=(location.pathname.split('/').pop()||'').toLowerCase();
      if(here==='login.html') return;
      const tok=localStorage.getItem('efoot.token')||'';
      const exp=+localStorage.getItem('efoot.expAt')||0;
      if(!tok || Date.now()>=exp){ location.href='login.html'; return; }
      const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
      const isAdminPage = /^admin-/.test(here) || here==='admin-joueurs.html' || here==='admin-utilisateurs.html';
      if(isAdminPage && role!=='admin'){ location.href='Accueil.html'; }
    })();
    // .adminOnly helper
    document.querySelectorAll('.adminOnly').forEach(el=>{
      const r=(localStorage.getItem('efoot.role')||'member').toLowerCase();
      el.style.display = r==='admin' ? '' : 'none';
    });
  }catch(e){ console.warn('additive patch error', e); }
})();
</script>

</body>
</html>
