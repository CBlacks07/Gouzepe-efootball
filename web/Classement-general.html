<!-- Classement-general.html -->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>GOUZEPE eFOOTBALL ‚Äî Classement G√©n√©ral</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="theme.css">
<script>window.EFOOT_API='https://gouzepe-efootball.onrender.com';</script>

<style>
  :root{
    --bg:#0b1220;--panel:#0f1627;--card:#0c1426;--text:#e5e7eb;--muted:#94a3b8;--border:#1f2937;
    --accent:#2563eb; --champ:#ef4444;
  }
  :root.light{--bg:#f4f6fb;--panel:#ffffff;--card:#ffffff;--text:#0f172a;--muted:#475569;--border:#e5e7eb;--accent:#1d4ed8}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Trebuchet MS",sans-serif;
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.12), transparent 40%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.10), transparent 40%),
      linear-gradient(180deg, rgba(7,10,22,.94), rgba(15,23,42,.96)),
      url('assets/fond.png') center/cover fixed no-repeat;
  }
  html.light body{
    background:
      radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.18), transparent 42%),
      radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.16), transparent 42%),
      linear-gradient(180deg, rgba(255,255,255,.86), rgba(245,247,251,.92)),
      url('assets/fond.png') center/cover fixed no-repeat;
  }
  .wrap{max-width:1200px;margin:auto;padding:12px}

  .top{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 6px;background:rgba(12,18,32,.55);backdrop-filter:blur(6px);border-radius:14px}
  html.light .top{background:rgba(255,255,255,.7)}
  .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .logo{width:52px;height:52px;border-radius:14px;background:url('assets/fond.png') center/cover no-repeat;pointer-events:none}
  .menu-toggle{display:none}
  .menu{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  @media (max-width: 840px){
    .menu-toggle{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
    html.light .menu-toggle{background:#fff}
    .menu{
      position:fixed; right:12px; top:64px; z-index:1000; display:none;
      flex-direction:column; gap:10px; width:min(88vw,340px); padding:12px;
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.35)
    }
    .menu.open{display:flex}
  }

  .btn{border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
  html.light .btn{background:#fff}
  .btn.primary{background:#0b1b0f;border-color:#14532d;color:#d1fae5}
  .btn.danger{background:#2a0c0c;border-color:#7f1d1d;color:#fecaca}
  select,input{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#0b1020;color:var(--text)}
  html.light select,html.light input{background:#fff}
  .muted{color:var(--muted)}

  /* puces de tri */
  .chip{border:1px solid var(--border);background:transparent;border-radius:999px;padding:8px 12px;cursor:pointer}
  .chip[aria-pressed="true"]{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.18) inset}

  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
  th{color:var(--muted);position:sticky;top:0;background:var(--card)}
  .cards{display:none}
  @media (max-width: 700px){
    table{display:none}
    .cards{display:grid;gap:10px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  }

  dialog{border:none;border-radius:14px;max-width:1000px;width:min(95vw,1000px);padding:0;background:var(--panel);color:var(--text)}
  dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}
  .tbl{width:100%;border-collapse:collapse;border:1px solid #444}
  .tbl th,.tbl td{border:1px solid #444;padding:6px 8px;text-align:center}
  .tbl thead th{background:#efefef}
  .champ{margin:10px 0 14px;font-weight:900;color:var(--champ);font-size:18px;text-align:center}
  .verdict{margin-top:8px;font-weight:800;color:var(--accent);text-align:center;font-size:16px}
  .sectionTitle{font-size:16px;margin:12px 0 8px;font-weight:700}
  .sepRow td{background:#1112;border-top:2px solid #666;font-style:italic}
</style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
      <h1 style="margin:0;font-size:16px">GOUZEPE GAMING CLUB <br>Championnat eFootball</h1>
      <span id="season-badge" class="season-badge blink-slow" style="display:none">Saison : <span id="season-text"></span></span>
    </div>
    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" id="btnProfile" href="Panel-Membre.html" style="display:none">üë§ Mon profil</a>
      <a class="btn" href="Classement-general.html" title="Voir le classement g√©n√©ral de la saison">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Admin-Joueurs</a>
      <a class="btn adminOnly" href="Admin-Utilisateurs.html">üõ°Ô∏è Admin-Utilisateurs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <!-- FILTRE & ACTIONS -->
  <div class="row" style="margin:12px 0; display:flex; gap:10px; flex-wrap:wrap; align-items:center">
    <label class="muted">Saison :</label>
    <select id="seasonSelect" style="min-width:220px"></select>
    <button id="newSeason" class="btn adminOnly">Cr√©er saison</button>

    <input id="search" placeholder="Rechercher joueur (nom ou ID)‚Ä¶" style="flex:1;min-width:220px">

    <!-- ‚ñº ajout tri + CSV -->
    <span class="muted">Tri :</span>
    <button id="triMoy" class="chip" aria-pressed="true" title="Trier par moyenne">Moyenne</button>
    <button id="triPts" class="chip" aria-pressed="false" title="Trier par points">Points</button>
    <button id="csvBtn" class="btn" title="Exporter CSV">‚¨áÔ∏è CSV</button>
    <!-- ‚ñ≤ -->

    <button id="printSeason" class="btn">Imprimer la saison</button>
    <button id="refresh" class="btn">Rafra√Æchir</button>
  </div>

  <div class="row" style="margin:0 0 10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
    <div class="muted">Journ√©e confirm√©e :</div>
    <select id="daySelect" style="min-width:220px"></select>
    <button id="viewDay" class="btn">Afficher</button>
    <button id="editDay" class="btn primary adminOnly" disabled>Modifier (admin)</button>
    <button id="printDay" class="btn" disabled>Imprimer cette journ√©e</button>
    <button id="deleteDay" class="btn danger adminOnly" disabled>Supprimer cette journ√©e</button>
  </div>

  <table id="seasonTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Nom</th>
        <th class="hid-m">ID</th>
        <th>Total pts</th>
        <th>Participations</th>
        <th>Moy</th>
        <th>Gagn√©s D1</th>
        <th>Gagn√©s D2</th>
        <th>√âquipes diff.</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="cards" id="seasonCards"></div>

  <dialog id="dayModal" class="day">
    <div class="day-head" style="padding:14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
      <div id="dayTitle" style="font-weight:700">Journ√©e</div>
      <button class="btn" onclick="document.getElementById('dayModal').close()">Fermer</button>
    </div>
    <div id="day-body" style="padding:12px"></div>
  </dialog>

</div>

<script>
/* ===== utils & state ===== */
const $=s=>document.querySelector(s);
const DEF_API=()=>`${location.protocol.startsWith('http')?location.protocol:'http:'}//${location.hostname}:3000`;
const API=(localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const token=localStorage.getItem('efoot.token');
const role =(localStorage.getItem('efoot.role')||'member').toLowerCase();
const expAt=+localStorage.getItem('efoot.expAt')||0;
if(!token||Date.now()>=expAt){location.href='login.html'}

document.querySelectorAll('.adminOnly').forEach(el=>el.style.display=(role==='admin')?'inline-flex':'none');

/* th√®me + menu + logout */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();
(function(){
  const menu=$('#menu'), toggle=$('#menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',()=>open(!menu.classList.contains('open')));
  document.addEventListener('click',(e)=>{
    if(!menu.classList.contains('open'))return;
    if(e.target===toggle||menu.contains(e.target))return;
    open(false);
  },true);
})();
$('#logoutBtn')?.addEventListener('click',()=>{
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
    location.href='login.html';
  }
});

/* ===== joueurs (noms/roles) ===== */
const NAME_BY_ID = new Map();
const ROLE_BY_ID = new Map(); // MEMBRE | INVITE
async function loadPlayers(){
  if(NAME_BY_ID.size>0) return;
  try{
    const r=await fetch(`${API}/players`,{headers:{'Authorization':`Bearer ${token}`}});
    const d=await r.json();
    (d.players||[]).forEach(p=>{
      NAME_BY_ID.set(p.player_id, p.name||p.player_id);
      ROLE_BY_ID.set(p.player_id, (p.role||'MEMBRE').toUpperCase());
    });
  }catch(_){}
}
function nameOf(id){ return NAME_BY_ID.get(id)||id||''; }
function roleOf(id){ return (ROLE_BY_ID.get(id)||'MEMBRE').toUpperCase(); }

/* ===== helpers : tri ===== */
function sortByMoyenne(list){
  return [...(list||[])].sort((a,b)=>{
    const am=+a.moyenne||0, bm=+b.moyenne||0;
    if(bm!==am) return bm-am;                    // 1) moyenne
    const at=+a.total||0, bt=+b.total||0;
    if(bt!==at) return bt-at;                    // 2) total
    return (a.name||a.id||'').localeCompare(b.name||b.id||''); // 3) nom
  });
}
function sortByPoints(list){
  return [...(list||[])].sort((a,b)=>{
    const at=+a.total||0, bt=+b.total||0;
    if(bt!==at) return bt-at;                    // 1) total
    const am=+a.moyenne||0, bm=+b.moyenne||0;
    if(bm!==am) return bm-am;                    // 2) moyenne (backup)
    return (a.name||a.id||'').localeCompare(b.name||b.id||''); // 3) nom
  });
}
function esc(t){return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}

/* ===== √©tat classement ===== */
let BASE_DATA=[];   // brut API
let VIEW_DATA=[];   // tri√© + _rank
let SORT_MODE='moyenne'; // 'moyenne' | 'points'

/* ===== chargement saisons (liste) ===== */
async function loadSeasons(){
  const r = await fetch(`${API}/seasons`, { headers:{Authorization:`Bearer ${token}`} });
  const d = await r.json();
  const sel = document.getElementById('seasonSelect');
  sel.innerHTML = '';
  (d.seasons || []).forEach(s=>{
    const o = document.createElement('option');
    o.value = s.id;
    o.textContent = `${s.name}${s.is_closed ? ' (cl√¥tur√©e)' : ''}`;
    sel.appendChild(o);
  });
  return d.seasons || [];
}

/* ===== standings de la saison s√©lectionn√©e ===== */
async function loadSeason(){
  const sid = +document.getElementById('seasonSelect').value;
  const r = await fetch(`${API}/seasons/${sid}/standings`,{headers:{Authorization:`Bearer ${token}`}});
  const d = await r.json();

  // calcule moyenne si absente (s√©curit√©)
  BASE_DATA = (d.standings||[]).map(p=>{
    const part = +p.participations||0;
    const moy = (p.moyenne!=null) ? +p.moyenne : (part ? (+p.total||0)/part : 0);
    return {...p, moyenne: +moy};
  });
  applySort();

  // journ√©es de la saison
  const r2 = await fetch(`${API}/seasons/${sid}/matchdays`,{headers:{Authorization:`Bearer ${token}`}});
  const d2 = await r2.json();
  const selDay = document.getElementById('daySelect'); selDay.innerHTML='';
  (d2.days||[]).forEach(dt=>{
    const o=document.createElement('option'); o.value=dt; o.textContent=dt; selDay.appendChild(o);
  });
  const has=!!selDay.value;
  document.getElementById('editDay').disabled=(role!=='admin')||!has;
  document.getElementById('printDay').disabled=!has;
  document.getElementById('deleteDay').disabled=(role!=='admin')||!has;
}

/* ===== applique tri courant et rend ===== */
function applySort(){
  const sorted = (SORT_MODE==='points') ? sortByPoints(BASE_DATA) : sortByMoyenne(BASE_DATA);
  VIEW_DATA = sorted.map((p,i)=> ({...p, _rank:i+1}));
  renderSeason();
}

/* ===== rendu ===== */
function renderSeason(){
  const q=($('#search').value||'').toLowerCase();
  const data = VIEW_DATA.filter(x=>(x.name||'').toLowerCase().includes(q) || (x.id||'').toLowerCase().includes(q));

  const tb=$('#seasonTable tbody'); tb.innerHTML='';
  data.forEach((p)=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
        '<td>'+(p._rank||'')+'</td>'
      + '<td>'+esc(p.name||p.id||'')+'</td>'
      + '<td class="hid-m">'+esc(p.id||'')+'</td>'
      + '<td>'+(p.total??0)+'</td>'
      + '<td>'+(p.participations??0)+'</td>'
      + '<td>'+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</td>'
      + '<td>'+(p.won_d1??0)+'</td>'
      + '<td>'+(p.won_d2??0)+'</td>'
      + '<td>'+(p.teams_used??0)+'</td>';
    tb.appendChild(tr);
  });

  const cards=$('#seasonCards'); cards.innerHTML='';
  data.forEach((p)=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML='<div style="font-weight:700;margin-bottom:4px">'+(p._rank||'')+'. '+esc(p.name||p.id||'')+'</div>'
      + '<div class="grid2">'
      + '<div><span class="muted">ID:</span> '+esc(p.id||'')+'</div>'
      + '<div><span class="muted">Total:</span> '+(p.total??0)+'</div>'
      + '<div><span class="muted">Part.:</span> '+(p.participations??0)+'</div>'
      + '<div><span class="muted">Moy.:</span> '+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</div>'
      + '<div><span class="muted">D1 gagn√©s:</span> '+(p.won_d1??0)+'</div>'
      + '<div><span class="muted">D2 gagn√©s:</span> '+(p.won_d2??0)+'</div>'
      + '<div><span class="muted">√âquipes diff.:</span> '+(p.teams_used??0)+'</div>'
      + '</div>';
    cards.appendChild(div);
  });
}

/* ===== Liste des journ√©es + affichage ===== */
async function loadDays(){
  const r=await fetch(`${API}/matchdays`,{headers:{'Authorization':`Bearer ${token}`}});
  const d=await r.json();
  const sel=$('#daySelect'); sel.innerHTML='';
  (d.days||[]).forEach(dt=>{
    const o=document.createElement('option'); o.value=dt; o.textContent=dt; sel.appendChild(o);
  });
  const has=!!sel.value;
  $('#editDay').disabled = !has || role!=='admin';
  $('#printDay').disabled=!has;
  $('#deleteDay').disabled = !has || role!=='admin';
}
async function viewSelectedDay(openModal=true){
  await loadPlayers();
  const day=$('#daySelect').value;
  if(!day){ alert('Choisis une date'); return; }
  const r=await fetch(`${API}/matchdays/${day}`,{headers:{'Authorization':`Bearer ${token}`}}); if(!r.ok){ alert('Journ√©e introuvable'); return; }
  const payload=await r.json();

  if(openModal){
    $('#dayTitle').textContent='Journ√©e du '+new Date(day).toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    $('#day-body').innerHTML = renderDayContent(payload);
    $('#dayModal').showModal();
  }
  return payload;
}

/* ===== calculs pour l'affichage d'une journ√©e ===== */
function computeStandings(rows){
  const agg={};
  function add(A,B,ga,gb){
    if(ga==null||gb==null) return;
    if(!agg[A]) agg[A]={J:0,V:0,N:0,D:0,BP:0,BC:0};
    if(!agg[B]) agg[B]={J:0,V:0,N:0,D:0,BP:0,BC:0};
    agg[A].J++; agg[B].J++;
    agg[A].BP+=ga; agg[A].BC+=gb;
    agg[B].BP+=gb; agg[B].BC+=ga;
    if(ga>gb){ agg[A].V++; agg[B].D++; }
    else if(ga<gb){ agg[B].V++; agg[A].D++; }
    else { agg[A].N++; agg[B].N++; }
  }
  (rows||[]).forEach(m=>{
    if(!m.p1||!m.p2) return;
    if(m.a1!=null&&m.a2!=null) add(m.p1,m.p2,m.a1,m.a2);
    if(m.r1!=null&&m.r2!=null) add(m.p2,m.p1,m.r2,m.r1);
  });
  const arr = Object.entries(agg).map(([id,x])=>({id,...x,PTS:x.V*3+x.N,DIFF:x.BP-x.BC,role:roleOf(id)}));
  arr.sort((a,b)=> b.PTS-a.PTS || b.DIFF-a.DIFF || b.BP-a.BP || a.id.localeCompare(b.id));
  return arr;
}
function splitAndRankDaily(st){
  const main = st.filter(x=>x.role!=='INVITE');
  const inv  = st.filter(x=>x.role==='INVITE');
  main.forEach((r,idx)=> r.RANK = idx+1);
  inv.forEach(r=> r.RANK='‚Äî');
  return {main,inv};
}
function standingsTableHTML(title, rowsMain, rowsInv){
  const head='<table class="tbl"><thead><tr><th>Rang</th><th>Nom</th><th>ID</th><th>J</th><th>V</th><th>N</th><th>D</th><th>BM</th><th>BC</th><th>Diff</th><th>PTS</th></tr></thead><tbody>';
  const row = (r)=> `<tr><td>${r.RANK}</td><td>${esc(nameOf(r.id))}</td><td>${esc(r.id)}</td><td>${r.J}</td><td>${r.V}</td><td>${r.N}</td><td>${r.D}</td><td>${r.BP}</td><td>${r.BC}</td><td>${r.DIFF}</td><td>${r.PTS}</td></tr>`;
  let body=''; rowsMain.forEach(r=> body+=row(r));
  if(rowsInv.length){ body+=`<tr class="sepRow"><td colspan="11">Invit√©s (non class√©s)</td></tr>`; rowsInv.forEach(r=> body+=row(r)); }
  return `<div class="sectionTitle">${title}</div>${head}${body}</tbody></table>`;
}
function renderMatchesTable(rows){
  let h='<table class="tbl"><thead><tr><th>Domicile</th><th>Ext√©rieur</th><th>Aller</th><th>Retour</th></tr></thead><tbody>';
  (rows||[]).forEach(m=>{
    const a=(m.a1!=null||m.a2!=null)?((m.a1??'')+' - '+(m.a2??'')):''; const r=(m.r1!=null||m.r2!=null)?((m.r1??'')+' - '+(m.r2??'')):''; 
    h+= `<tr><td>${esc(m.p1||'')}</td><td>${esc(m.p2||'')}</td><td>${esc(a)}</td><td>${esc(r)}</td></tr>`;
  });
  h+='</tbody></table>';
  return h;
}
function renderDayContent(payload){
  const st1 = computeStandings(payload.d1||[]);
  const st2 = computeStandings(payload.d2||[]);
  const {main:main1,inv:inv1} = splitAndRankDaily(st1);
  const {main:main2,inv:inv2} = splitAndRankDaily(st2);
  const c1 = payload?.champions?.d1||{}, c2 = payload?.champions?.d2||{};
  const barr = payload?.champions?.barrage||{};
  const team1=(c1.team||'').toUpperCase()||'‚Äî';
  const team2=(c2.team||'').toUpperCase()||'‚Äî';
  const mg = o => (o && o.A!=null && o.B!=null) ? (o.A+' - '+o.B) : '';

  let html = '';
  html += '<div class="sectionTitle">SCORES D1</div>'+renderMatchesTable(payload.d1||[]);
  html += `<div class="champ">üèÜ${esc(c1.id||'‚Äî')} ‚Äî CHAMPION avec ${esc(team1)}</div>`;
  html += standingsTableHTML('CLASSEMENT D1', main1, inv1);

  html += '<div class="sectionTitle" style="margin-top:16px">SCORES D2</div>'+renderMatchesTable(payload.d2||[]);
  html += `<div class="champ">üèÜ${esc(c2.id||'‚Äî')} ‚Äî CHAMPION avec ${esc(team2)}</div>`;
  html += standingsTableHTML('CLASSEMENT D2', main2, inv2);

  html += '<div class="sectionTitle" style="margin-top:16px">BARRAGES</div>';
  html += '<table class="tbl"><thead><tr><th>Affiche</th><th>Aller</th><th>Retour</th><th>Match 3</th></tr></thead><tbody>';
  html += `<tr><td>${esc((barr.ids?.d1||'‚Äî')+' - '+(barr.ids?.d2||'‚Äî'))}</td><td>${esc(mg((payload.barrage||{}).m1||{}))}</td><td>${esc(mg((payload.barrage||{}).m2||{}))}</td><td>${esc(mg((payload.barrage||{}).m3||{}))}</td></tr>`;
  html += '</tbody></table>';
  html += `<div class="verdict">*** ${esc((payload.barrage?.label)||'‚Äî')}</div>`;
  if(payload.barrage?.notes){
    html += '<div style="margin-top:10px"><span class="muted">Notes :</span><br>'+esc(payload.barrage.notes).replace(/\r?\n/g,'<br>')+'</div>';
  }
  return html;
}

/* ===== Impression classement ===== */
async function logoDataURL(){
  const tryFetch = async (path)=>{
    try{
      const r=await fetch(path,{cache:'no-store'}); if(!r.ok) return null;
      const b=await r.blob();
      return await new Promise(res=>{
        const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b);
      });
    }catch(_){ return null; }
  };
  return (await tryFetch('assets/logo.png')) || (await tryFetch('assets/fond.png'));
}
async function printSeason(){
  const rows = VIEW_DATA.slice();
  const css='@page{size:A4;margin:12mm;}body{font:12px/1.35 Segoe UI,Roboto,Arial,sans-serif;color:#111;}h1{font-size:18px;margin:0 0 8px;display:flex;align-items:center;gap:8px}h1 img{height:26px}table{width:100%;border-collapse:collapse;border:1px solid #444}th,td{border:1px solid #444;padding:4px 6px;text-align:center}thead th{background:#efefef}';
  const logo = await logoDataURL();
  let html='<!doctype html><html><head><meta charset="utf-8"><title>Classement Saison</title><style>'+css+'</style></head><body onload="window.print()">';
  html+='<h1>'+(logo?`<img src="${logo}" alt="logo">`:'')+'Classement G√©n√©ral ‚Äî Tri : '+(SORT_MODE==='points'?'Points':'Moyenne')+'</h1>';
  html+='<table><thead><tr><th>#</th><th>Nom</th><th>ID</th><th>Total</th><th>Part.</th><th>Moy.</th><th>Gagn√©s D1</th><th>Gagn√©s D2</th><th>√âquipes diff.</th></tr></thead><tbody>';
  rows.forEach((p)=>{
    html+='<tr><td>'+(p._rank||'')+'</td><td>'+esc(p.name||p.id||'')+'</td><td>'+esc(p.id||'')+'</td><td>'+(p.total??0)+'</td><td>'+(p.participations??0)+'</td><td>'+((p.moyenne??0).toFixed ? (p.moyenne||0).toFixed(2):(p.moyenne??0))+'</td><td>'+(p.won_d1??0)+'</td><td>'+(p.won_d2??0)+'</td><td>'+(p.teams_used??0)+'</td></tr>';
  });
  html+='</tbody></table></body></html>';
  const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close(); w.focus();
}

/* ===== Impression journ√©e ===== */
async function printSelectedDay(){
  await loadPlayers();
  const day=$('#daySelect').value; if(!day) return;
  const payload = await viewSelectedDay(false);
  if(!payload) return;

  const st1 = computeStandings(payload.d1||[]);
  const st2 = computeStandings(payload.d2||[]);
  const {main:main1,inv:inv1} = splitAndRankDaily(st1);
  const {main:main2,inv:inv2} = splitAndRankDaily(st2);

  const css='@page{size:A4;margin:12mm;}body{font:12px/1.35 "Segoe UI",Roboto,Arial,sans-serif;color:#111;}h1{font-size:18px;margin:0 0 8px;display:flex;align-items:center;gap:8px}h1 img{height:28px} h2{font-size:14px;margin:10px 0 6px;} .tbl{width:100%;border-collapse:collapse;border:1px solid #444;} .tbl th,.tbl td{border:1px solid #444;padding:4px 6px;text-align:center} .tbl thead th{background:#efefef;} .champ{text-align:center;margin:6px 0 10px;font-weight:900;color:#cc0000;font-size:17px;} .verdict{margin-top:8px;font-weight:800;color:#1d4ed8;text-align:center;font-size:15px;} .sepRow td{background:#f7f7f7;font-style:italic}';
  const escHtml = (t)=>String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  const mg=o=> (o && o.A!=null && o.B!=null) ? (o.A+' - '+o.B) : '';
  const tblMatches = (rows)=>{
    let h='<table class="tbl"><thead><tr><th>Domicile</th><th>Ext√©rieur</th><th>Aller</th><th>Retour</th></tr></thead><tbody>';
    (rows||[]).forEach(m=>{
      const a=(m.a1!=null||m.a2!=null)?((m.a1??'')+' - '+(m.a2??'')):''; const r=(m.r1!=null||m.r2!=null)?((m.r1??'')+' - '+(m.r2??'')):''; 
      h+= `<tr><td>${escHtml(m.p1||'')}</td><td>${escHtml(m.p2||'')}</td><td>${escHtml(a)}</td><td>${escHtml(r)}</td></tr>`;
    });
    return h+'</tbody></table>';
  };
  const tblStand = (title, main, inv)=>{
    let h = `<h2>${escHtml(title)}</h2><table class="tbl"><thead><tr><th>Rang</th><th>Nom</th><th>ID</th><th>J</th><th>V</th><th>N</th><th>D</th><th>BM</th><th>BC</th><th>Diff</th><th>PTS</th></tr></thead><tbody>`;
    const row = (r)=> `<tr><td>${r.RANK}</td><td>${escHtml(nameOf(r.id))}</td><td>${escHtml(r.id)}</td><td>${r.J}</td><td>${r.V}</td><td>${r.N}</td><td>${r.D}</td><td>${r.BP}</td><td>${r.BC}</td><td>${r.DIFF}</td><td>${r.PTS}</td></tr>`;
    main.forEach(r=>h+=row(r));
    if(inv.length){ h+=`<tr class="sepRow"><td colspan="11">Invit√©s (non class√©s)</td></tr>`; inv.forEach(r=>h+=row(r)); }
    return h+'</tbody></table>';
  };
  const c1 = payload?.champions?.d1||{}, c2 = payload?.champions?.d2||{}, barr = payload?.champions?.barrage||{};
  const team1=(c1.team||'').toUpperCase()||'‚Äî'; const team2=(c2.team||'').toUpperCase()||'‚Äî';
  const logo = await logoDataURL();
  let html='<!doctype html><html lang="fr"><head><meta charset="utf-8"/><title>R√©sultats ‚Äî '+day+'</title><style>'+css+'</style></head><body onload="window.print()">';
  html+= `<h1>${logo?`<img src="${logo}" alt="logo">`:''}GOUZEPE GAMING CLUB ‚Äî Journ√©e du ${new Date(day).toLocaleDateString('fr-FR')}</h1>`;

  html+= '<h2>SCORES D1</h2>'+tblMatches(payload.d1||[]);
  html+= `<div class="champ">üèÜ${escHtml(c1.id||'‚Äî')} ‚Äî CHAMPION avec ${escHtml(team1)}</div>`;
  html+= tblStand('CLASSEMENT D1', main1, inv1);

  html+= '<h2>SCORES D2</h2>'+tblMatches(payload.d2||[]);
  html+= `<div class="champ">üèÜ${escHtml(c2.id||'‚Äî')} ‚Äî CHAMPION avec ${escHtml(team2)}</div>`;
  html+= tblStand('CLASSEMENT D2', main2, inv2);

  html+= '<h2>BARRAGES</h2><table class="tbl"><thead><tr><th>Affiche</th><th>Aller</th><th>Retour</th><th>Match 3</th></tr></thead><tbody>';
  html+= `<tr><td>${escHtml((barr.ids?.d1||'‚Äî')+' - '+(barr.ids?.d2||'‚Äî'))}</td><td>${escHtml(mg((payload.barrage||{}).m1||{}))}</td><td>${escHtml(mg((payload.barrage||{}).m2||{}))}</td><td>${escHtml(mg((payload.barrage||{}).m3||{}))}</td></tr></tbody></table>`;
  html+= `<div class="verdict">*** ${escHtml((payload.barrage?.label)||'‚Äî')}</div>`;
  if(payload.barrage?.notes){
    html+= '<div style="margin-top:8px"><b>Notes :</b><br>'+escHtml(payload.barrage.notes).replace(/\r?\n/g,'<br>')+'</div>';
  }
  html+='</body></html>';

  const w=window.open('','_blank'); w.document.open(); w.document.write(html); w.document.close(); w.focus();
}

/* ===== Export CSV ===== */
function exportCSV(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const data = VIEW_DATA.filter(p => (p.name||'').toLowerCase().includes(q) || (p.id||'').toLowerCase().includes(q));
  const rows = [['Rang','#ID','Nom','Total','Participations','Moyenne','Gagn√©s D1','Gagn√©s D2','√âquipes diff.'],
                ...data.map(p=>[p._rank,p.id||'',p.name||p.id||'',p.total||0,p.participations||0,(+p.moyenne||0).toFixed(2),p.won_d1||0,p.won_d2||0,p.teams_used||0])];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a'); a.download='classement_'+(SORT_MODE==='points'?'points':'moyenne')+'.csv';
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.click(); URL.revokeObjectURL(a.href);
}

/* ===== Events & init ===== */
document.getElementById('search').addEventListener('input', renderSeason);
document.getElementById('refresh').onclick=()=>{ loadPlayers().then(()=>{ loadSeason(); }); };
document.getElementById('printSeason').onclick=printSeason;
document.getElementById('csvBtn').onclick=exportCSV;
document.getElementById('triMoy').onclick=()=>{ SORT_MODE='moyenne'; document.getElementById('triMoy').setAttribute('aria-pressed','true'); document.getElementById('triPts').setAttribute('aria-pressed','false'); applySort(); };
document.getElementById('triPts').onclick=()=>{ SORT_MODE='points';  document.getElementById('triMoy').setAttribute('aria-pressed','false'); document.getElementById('triPts').setAttribute('aria-pressed','true');  applySort(); };

document.getElementById('viewDay').onclick=()=>viewSelectedDay(true);
document.getElementById('daySelect').addEventListener('change',()=>{
  const has=!!document.getElementById('daySelect').value;
  document.getElementById('editDay').disabled=(role!=='admin')||!has;
  document.getElementById('printDay').disabled=!has;
  document.getElementById('deleteDay').disabled=(role!=='admin')||!has;
});
document.getElementById('printDay').onclick=printSelectedDay;

document.getElementById('editDay').onclick=()=>{ const d=document.getElementById('daySelect').value; if(d) location.href='Accueil.html?date='+encodeURIComponent(d)+'&edit=1'; };
document.getElementById('deleteDay')?.addEventListener('click', async ()=>{
  const day = document.getElementById('daySelect').value;
  if(!day) return;
  const txt = `Supprimer d√©finitivement la journ√©e du ${new Date(day).toLocaleDateString('fr-FR')} ?`;
  if(!confirm(txt)) return;
  try{
    const r = await fetch(`${API}/matchdays/${encodeURIComponent(day)}`,{ method:'DELETE', headers:{'Authorization':`Bearer ${token}`}} );
    if(!r.ok){ const e=await r.json().catch(()=>({})); alert('√âchec suppression : ' + (e.error || r.status)); return; }
    alert('Journ√©e supprim√©e.');
    await loadSeason(); // recharge standings
    await loadDays();   // recharge dates
    try{ document.getElementById('dayModal')?.close?.(); }catch(_){}
  }catch(err){ console.error(err); alert('Erreur r√©seau lors de la suppression.'); }
});

// init
(async function init(){
  await loadPlayers();
  await loadSeasons();
  // s√©lection auto : on choisit la premi√®re saison si aucune info
  if (!document.getElementById('seasonSelect').value && document.getElementById('seasonSelect').options.length){
    document.getElementById('seasonSelect').selectedIndex = 0;
  }
  await loadSeason();
  // socket
  try{
    const s=document.createElement('script'); s.src=`${API}/socket.io/socket.io.js`; s.onload=()=>{
      const u=new URL(API); const ws=`${u.protocol}//${u.hostname}:${u.port||'3000'}`;
      const socket=window.io(ws,{transports:['websocket','polling']});
      socket.on('season:updated', ()=>{ loadSeasons().then(loadSeason); });
      socket.on('day:confirmed', ()=>{ loadSeason(); loadDays(); });
      socket.on('day:deleted',  ()=>{ loadSeason(); loadDays(); });
    }; document.head.appendChild(s);
  }catch(_){}
})();

// quand on change de saison => standings + jours
document.getElementById('seasonSelect').addEventListener('change', async ()=>{ await loadSeason(); });

/* ===== PING pr√©sence pour membres ===== */
(function(){
  const r = (localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!token || r==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:`Bearer ${token}`}}).catch(()=>{});
  ping(); setInterval(ping, 15000);
})();

/* ===== Ajustements de menu selon r√¥le ===== */
(function(){
  const r = (localStorage.getItem('efoot.role') || 'member').toLowerCase();
  const btn = document.getElementById('btnProfile');
  const lm  = document.getElementById('linkMembers');
  const menu = document.getElementById('menu');
  if (r === 'admin') {
    if (btn) btn.style.display = 'none';
    if (lm)  lm.textContent = 'üë• Admin-Joueurs';
  } else {
    if (btn) {
      btn.style.display = 'inline-flex';
      btn.href = 'Panel-Membre.html';
      if (menu && btn.parentNode === menu) menu.insertBefore(btn, menu.firstChild);
    }
    if (lm) {
      lm.textContent = 'üë• Liste des membres';
      lm.href = 'Admin-Joueurs.html';
    }
  }
})();
</script>

<footer style="text-align: center; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>
</body>
</html>
