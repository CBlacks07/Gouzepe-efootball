<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Duel ‚Äî GOUZEPE eFOOTBALL</title>
  <link rel="stylesheet" href="theme.css"/>

  <style>
    :root{
      --gap: 12px;
    }
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .grid2{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width: 960px){ .grid2{grid-template-columns:1fr 1fr} }

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{min-width:0}
    .w-100{width:100%}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}

    .score{display:flex;gap:8px;align-items:center}
    .score input{width:68px;text-align:center;font-weight:800}

    .tableWrap{overflow:auto}
    table.tbl{min-width:740px}

    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:4px 10px}
    .pill.win{background:#064e3b;color:#b7fbdc}
    .pill.draw{background:#1f2937;color:#e5e7eb}
    .pill.lose{background:#5b0b0b;color:#fed7d7}
    .leader{font-weight:800}

    .danger-link{background:transparent;border:1px solid var(--border);border-radius:10px;padding:6px 10px;cursor:pointer}
    .danger-link:hover{border-color:#7f1d1d;background:#2a0c0c;color:#fecaca}

    /* visuels boutons en clair */
    html.light .btn.primary{background:#0b5; color:#fff; border-color:#0a4}
    html.light .btn{background:#fff; color:#0f172a}
    html.light .btn.danger{background:#c62828;color:#fff;border-color:#b71c1c}

    /* inputs plus compacts pour IDs */
    .id-select{min-width:220px}
    .id-compact select{min-width:180px}
    .score-compact input{width:56px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- NAV -->
  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
    </div>
          <h1 style="margin:0;font-size:18px">‚öîÔ∏è Gestion des duels</h1>

    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" href="Accueil.html">üè† Accueil</a>
      <a class="btn" href="Classement-general.html">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Admin-Joueurs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <main style="margin-top:12px">

    <div class="grid2">
      <!-- NOUVEAU DUEL -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:6px 0">Nouveau duel</h3>
          <small class="muted">Enregistre un duel amical hors journ√©e du samedi</small>
        </div>

        <div class="row id-compact" style="margin-top:8px">
          <label class="muted">Joueur A</label>
          <select id="p1" class="id-select grow"></select>
        </div>

        <div class="row id-compact" style="margin-top:6px">
          <label class="muted">Joueur B</label>
          <select id="p2" class="id-select grow"></select>
        </div>

        <div class="row score-compact" style="margin-top:8px">
          <label class="muted">Score</label>
          <div class="score">
            <input id="sa" type="number" inputmode="numeric" min="0" max="99" placeholder="A" />
            <span class="muted">‚Äì</span>
            <input id="sb" type="number" inputmode="numeric" min="0" max="99" placeholder="B" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="muted">Date/Heure</label>
          <input id="dt" type="datetime-local"/>
          <span class="hint">Par d√©faut : maintenant</span>
        </div>

        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button id="save" class="btn primary" type="button">Enregistrer</button>
        </div>

        <div id="saveMsg" class="tiny muted" style="margin-top:6px"></div>
      </section>

      <!-- FACE-√Ä-FACE RAPIDE -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:6px 0">Face-√†-face rapide</h3>
          <small class="muted">Comparaison sur la base des duels enregistr√©s</small>
        </div>

        <div class="row id-compact" style="margin-top:8px">
          <label class="muted">Joueur A</label>
          <select id="cA" class="id-select grow"></select>
        </div>

        <div class="row id-compact" style="margin-top:6px">
          <label class="muted">Joueur B</label>
          <select id="cB" class="id-select grow"></select>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="muted">P√©riode</label>
          <input id="from" type="date"/>
          <span class="muted">‚Üí</span>
          <input id="to" type="date"/>
          <div class="grow"></div>
          <button id="compare" class="btn" type="button">Comparer</button>
        </div>

        <div id="cmpOut" style="margin-top:10px">
          <div class="muted tiny">S√©lectionne deux joueurs pour voir qui m√®ne.</div>
        </div>
      </section>
    </div>

    <!-- 5 DERNIERS DUELS -->
    <section class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:6px 0">Derniers duels</h3>
        <div class="row">
          <label class="muted">Afficher</label>
          <select id="limit"><option value="5" selected>5</option><option value="10">10</option><option value="25">25</option><option value="50">50</option></select>
          <button id="refresh" class="btn" type="button">Rafra√Æchir</button>
        </div>
      </div>
      <div class="tableWrap" style="margin-top:8px">
        <table class="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>Joueur A</th>
              <th>Score</th>
              <th>Joueur B</th>
              <th>Vainqueur</th>
              <th class="adminOnly">Actions</th>
            </tr>
          </thead>
          <tbody id="list"></tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<script>
/* ===== Utils/API ===== */
const $ = s => document.querySelector(s);
const DEF_API = () => (location.protocol.startsWith('http')?location.protocol:'http:') + '//' + location.hostname + ':3000';
const API  = (localStorage.getItem('efoot.api') || DEF_API()).replace(/\/+$/,'');
const TOK  = localStorage.getItem('efoot.token') || '';
const ROLE = (localStorage.getItem('efoot.role') || 'member').toLowerCase();

// Auth guard
(function(){
  const expAt=+localStorage.getItem('efoot.expAt')||0;
  if(!TOK || Date.now()>=expAt){ location.href='login.html'; }
})();

// Theme
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

// Menu
(function(){
  const menu=$('#menu'), toggle=$('#menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',(e)=>{e.stopPropagation();open(!menu.classList.contains('open'));});
  document.addEventListener('click',(e)=>{ if(!menu.classList.contains('open'))return; if(e.target===toggle||menu.contains(e.target))return; open(false); },true);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') open(false); });
})();

// Logout
$('#logoutBtn')?.addEventListener('click',()=>{
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
    location.href='login.html';
  }
});

// Helpers
function esc(t){return String(t??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
async function safeFetch(url,opt={},ms=15000){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms);
  try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t); }
}
function toISO(dtLocalValue){
  if(!dtLocalValue) return null;
  const d=new Date(dtLocalValue);
  return Number.isNaN(+d)? null : d.toISOString();
}
function isIntLike(v){
  if(v===null || v===undefined || v==='') return false;
  const n=Number(v); return Number.isFinite(n) && Math.floor(n)===n && n>=0 && n<=99;
}

/* ===== Remplir la liste des joueurs ===== */
const NAME_BY_ID=new Map();
async function loadPlayers(){
  const r=await safeFetch(API+'/players',{headers:{Authorization:'Bearer '+TOK}});
  const d=await r.json();
  const opts = (d.players||[])
    .sort((a,b)=> (a.name||a.player_id).localeCompare(b.name||b.player_id,'fr'))
    .map(p=>{
      NAME_BY_ID.set(p.player_id, p.name||p.player_id);
      return `<option value="${esc(p.player_id)}">${esc(p.name||p.player_id)} ‚Äî ${esc(p.player_id)}</option>`;
    }).join('');
  ['p1','p2','cA','cB'].forEach(id=>{ const sel=$( '#'+id ); if(sel) sel.innerHTML = '<option value="">Choisir‚Ä¶</option>'+opts; });
}

/* ===== ENREGISTRER UN DUEL ===== */
async function onSave(){
  const btn = $('#save');
  const msg = $('#saveMsg');
  msg.textContent='';
  btn.disabled=true;

  try{
    const p1 = $('#p1').value.trim();
    const p2 = $('#p2').value.trim();
    const sa = $('#sa').value !== '' ? Number($('#sa').value) : null;
    const sb = $('#sb').value !== '' ? Number($('#sb').value) : null;
    const dt = toISO($('#dt').value);

    if(!p1 || !p2) throw new Error('S√©lectionne les deux joueurs.');
    if(p1 === p2)  throw new Error('Choisir deux joueurs diff√©rents.');
    if(!isIntLike(sa) || !isIntLike(sb)) throw new Error('Score incorrect. Utilise des entiers entre 0 et 99.');

    const body = { p1, p2, score_a: sa, score_b: sb };
    if(dt) body.played_at = dt;

    const r = await safeFetch(API+'/duels', {
      method:'POST',
      headers:{'Content-Type':'application/json', Authorization:'Bearer '+TOK},
      body: JSON.stringify(body)
    });
    const d = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d.error||('HTTP '+r.status));

    msg.textContent = '‚úÖ Duel enregistr√©.';
    // reset scores seulement
    $('#sa').value=''; $('#sb').value='';
    // rafra√Æchir recents + (si m√™me paire s√©lectionn√©e) la comparaison
    await refreshRecent();
    const cA=$('#cA').value, cB=$('#cB').value;
    if((cA && cB) && ((cA===p1 && cB===p2) || (cA===p2 && cB===p1))){
      await onCompare();
    }
  }catch(e){
    msg.textContent = '‚ùå ' + (e.message||'Erreur inconnue');
  }finally{
    btn.disabled=false;
  }
}

/* ===== FACE-√Ä-FACE ===== */
function totBadge(w,d,l,gf,ga){
  let cls='draw', lab='√âgalit√©';
  if(w>l){ cls='win'; lab='Leader'; }
  else if(l>w){ cls='lose'; lab='Men√©'; }
  const txt = `${gf}-${ga}`;
  return `<span class="pill ${cls}"><strong>${lab}</strong> ‚Ä¢ ${txt}</span>`;
}
async function onCompare(){
  const A=$('#cA').value.trim();
  const B=$('#cB').value.trim();
  const F=$('#from').value.trim();
  const T=$('#to').value.trim();
  const out=$('#cmpOut');
  out.innerHTML='';

  if(!A || !B) { out.innerHTML='<div class="muted tiny">Choisis deux joueurs.</div>'; return; }
  if(A===B)    { out.innerHTML='<div class="muted tiny">Les joueurs doivent √™tre diff√©rents.</div>'; return; }

  const params = new URLSearchParams();
  params.set('p1',A); params.set('p2',B);
  if(F) params.set('from',F);
  if(T) params.set('to',T);

  const r = await safeFetch(API+'/duels/compare?'+params.toString(), { headers:{Authorization:'Bearer '+TOK}});
  const d = await r.json().catch(()=>({}));
  if(!r.ok){ out.innerHTML = `<div class="muted tiny">Erreur: ${esc(d.error||('HTTP '+r.status))}</div>`; return; }

  const nA = d.p1?.name || NAME_BY_ID.get(A) || A;
  const nB = d.p2?.name || NAME_BY_ID.get(B) || B;
  const t  = d.totals || {wins:0,draws:0,losses:0,gf:0,ga:0,legs:0};

  // d√©terminer le leader par nom r√©el
  let leader = '√âgalit√©';
  if(t.wins > t.losses) leader = nA;
  else if(t.losses > t.wins) leader = nB;

  out.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <div><strong>${esc(nA)}</strong> vs <strong>${esc(nB)}</strong> ‚Ä¢ ${t.legs||0} manche(s)</div>
      <div>${totBadge(t.wins,t.draws,t.losses,t.gf,t.ga)}</div>
    </div>
    <div class="hint">Leader : <span class="leader">${esc(leader)}</span></div>
    <div class="tableWrap" style="margin-top:8px">
      <table class="tbl">
        <thead><tr><th>Date</th><th>${esc(nA)}</th><th>Score</th><th>${esc(nB)}</th></tr></thead>
        <tbody>
          ${(d.duels||[]).map(row=>{
            // R√©orienter pour afficher A √† gauche
            let a=row.score_a, b=row.score_b, left=row.p1_name||row.p1_id, right=row.p2_name||row.p2_id;
            if(row.p1_id !== A){ a=row.score_b; b=row.score_a; left=row.p2_name||row.p2_id; right=row.p1_name||row.p1_id; }
            const cls = a>b?'win':(a<b?'lose':'draw');
            return `<tr>
              <td>${new Date(row.played_at).toLocaleString('fr-FR')}</td>
              <td>${esc(left)}</td>
              <td><span class="pill ${cls}">${a} ‚Äì ${b}</span></td>
              <td>${esc(right)}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

/* ===== DERNIERS DUELS ===== */
async function refreshRecent(){
  const L = parseInt($('#limit').value||'5',10);
  const r = await safeFetch(API+'/duels/recent?limit='+encodeURIComponent(L), { headers:{Authorization:'Bearer '+TOK}});
  const d = await r.json().catch(()=>({duels:[]}));
  const tb = $('#list'); tb.innerHTML='';

  (d.duels||[]).forEach(row=>{
    const a = `${row.score_a}`, b = `${row.score_b}`;
    const cls = (+a>+b)?'win':(+a<+b?'lose':'draw');
    // Leader r√©el
    let leader = '√âgalit√©';
    if(+a>+b) leader = row.p1_name || row.p1_id;
    else if(+b>+a) leader = row.p2_name || row.p2_id;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(row.played_at).toLocaleString('fr-FR')}</td>
      <td>${esc(row.p1_name||row.p1_id)}</td>
      <td><span class="pill ${cls}">${a} ‚Äì ${b}</span></td>
      <td>${esc(row.p2_name||row.p2_id)}</td>
      <td>${esc(leader)}</td>
      <td class="adminOnly">${ROLE==='admin'
        ? `<button class="danger-link" data-del="${row.id}">Supprimer</button>`
        : ''}</td>
    `;
    tb.appendChild(tr);
  });
}

// suppression admin
$('#list').addEventListener('click', async (e)=>{
  const id = e.target?.dataset?.del;
  if(!id) return;
  if(ROLE!=='admin') return alert('R√©serv√© aux administrateurs.');
  if(!confirm('Supprimer ce duel ?')) return;
  const r = await safeFetch(API+'/duels/'+encodeURIComponent(id), {
    method:'DELETE', headers:{Authorization:'Bearer '+TOK}
  });
  const d = await r.json().catch(()=>({}));
  if(!r.ok){ alert(d.error||('HTTP '+r.status)); return; }
  await refreshRecent();
});

/* ===== INIT ===== */
(function init(){
  // champs scores numeric only
  ['sa','sb'].forEach(id=>{
    const el=$('#'+id);
    el.addEventListener('input',()=>{
      el.value = el.value.replace(/[^\d]/g,'').slice(0,2);
    });
  });

  // date par d√©faut = maintenant local (arrondi minutes)
  const now = new Date();
  now.setSeconds(0,0);
  const pad = n=> String(n).padStart(2,'0');
  const v = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
  $('#dt').value = v;

  // bind boutons
  $('#save').addEventListener('click', onSave);       // <<< important: type="button" + event JS
  $('#compare').addEventListener('click', onCompare);
  $('#refresh').addEventListener('click', refreshRecent);
  $('#limit').addEventListener('change', refreshRecent);

  // adminOnly visibilit√©
  document.querySelectorAll('.adminOnly').forEach(el=>{
    el.style.display = (ROLE==='admin') ? '' : 'none';
  });

  // charger donn√©es
  loadPlayers().then(()=>{
    // Optionnel: si tu veux auto-pr√©-remplir comparaison quand on vient de saisir un duel
  });
  refreshRecent();
})();
</script>
</body>
</html>

