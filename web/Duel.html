<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Duels ‚Äî GOUZEPE</title>
  <link rel="stylesheet" href="theme.css"/>
  <style>
    :root{
      --ui: system-ui,-apple-system,Segoe UI,Inter,Roboto,Ubuntu,"Trebuchet MS",sans-serif;
    }
    html,body{font-family:var(--ui)}
    .wrap{max-width:1100px;margin:auto;padding:12px}

    /* ===== AppBar ===== */
    .appbar{
      position:sticky; top:0; z-index:40;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; margin:-12px -12px 12px -12px;
      background:linear-gradient(to bottom, color-mix(in oklab, var(--panel) 92%, transparent), var(--panel));
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0}
    .brand img{width:28px;height:28px;border-radius:6px;border:1px solid var(--border);object-fit:cover}
    .brand h1{font-size:18px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .icon-btn{
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      border-radius:12px; padding:8px 10px; font-weight:700; cursor:pointer;
    }

    /* ===== Drawer (menu) ===== */
    .scrim{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:.2s opacity; z-index:48;
    }
    .scrim.open{opacity:1; pointer-events:auto}
    .drawer{
      position:fixed; right:0; top:0; height:100%; width:min(88vw,360px);
      background:var(--panel); border-left:1px solid var(--border);
      box-shadow: -20px 0 40px rgba(0,0,0,.35);
      transform:translateX(100%); transition:.25s transform cubic-bezier(.2,.65,.2,1);
      z-index:49; display:flex; flex-direction:column; gap:10px; padding:14px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer a, .drawer button{width:100%}

    /* ===== Sections / cards ===== */
    .section{margin-top:12px}
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .muted{color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}

    /* ===== Form fields compacts (anti-zoom iOS => font 16px) ===== */
    .grid{display:grid;gap:10px}
    .grid2{grid-template-columns:1fr}
    @media(min-width:480px){ .grid2{grid-template-columns:1fr 1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;letter-spacing:.02em;opacity:.8}
    .field input,.field select{
      font-size:16px; /* IMPORTANT mobile */
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:var(--panel); color:var(--text); width:100%;
    }
    /* number spinners off (webkit) */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type=number]{ -moz-appearance: textfield; }

    /* ===== Table ===== */
    .tableWrap{overflow:auto; -webkit-overflow-scrolling:touch}
    .tbl{min-width:740px}
    .tbl th,.tbl td{white-space:nowrap}

    .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:800}
    .win{background:#064e3b;color:#b7fbdc}
    .draw{background:#374151;color:#e5e7eb}
    .lose{background:#5b0b0b;color:#fed7d7}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-weight:700}

    /* ===== Toast ===== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%) translateY(20px);
      bottom:14px; background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; box-shadow:0 10px 25px rgba(0,0,0,.25);
      opacity:0; pointer-events:none; transition:.25s opacity, .25s transform; z-index:50;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
<div class="wrap">

  <!-- AppBar -->
  <header class="appbar">
    <div class="brand">
      <img src="assets/fond.png" alt="">
      <h1>‚öîÔ∏è Duels (hors saison)</h1>
    </div>
    <button id="burger" class="icon-btn" aria-label="Ouvrir le menu" aria-expanded="false">‚ò∞</button>
  </header>

  <!-- Drawer + Scrim -->
  <div id="scrim" class="scrim"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <a class="btn" href="Accueil.html">üè† Accueil</a>
    <a class="btn" href="Panel-Membre.html">üë§ Panel</a>
    <a class="btn" href="Classement-general.html">üìä Classements</a>
    <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
    <button id="logoutBtn" class="btn danger">D√©connexion</button>
  </aside>

  <main>

    <!-- Cr√©ation -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Nouveau duel</h3>
        <button class="btn" id="reduceCreate" aria-expanded="true" aria-controls="createBody">R√©duire</button>
      </div>

      <div id="createBody" class="grid grid2">
        <div class="card">
          <div class="grid grid2">
            <div class="field">
              <label for="pA">Joueur A</label>
              <select id="pA"></select>
            </div>
            <div class="field">
              <label for="pB">Joueur B</label>
              <select id="pB"></select>
            </div>

            <div class="field">
              <label for="sA">Score A</label>
              <input id="sA" type="number" inputmode="numeric" min="0" value="0">
            </div>
            <div class="field">
              <label for="sB">Score B</label>
              <input id="sB" type="number" inputmode="numeric" min="0" value="0">
            </div>

            <div class="field">
              <label for="dt">Date & heure</label>
              <input id="dt" type="datetime-local">
            </div>
            <div class="field">
              <label for="note">Note (facultatif)</label>
              <input id="note" placeholder="ex: terrain, mode, etc.">
            </div>
          </div>

          <div class="right" style="margin-top:8px">
            <button id="save" class="btn">Enregistrer</button>
          </div>
          <div id="saveMsg" class="muted" style="margin-top:6px">‚Äî</div>
        </div>

        <div class="card">
          <h4 style="margin:0 0 6px">Face-√†-face rapide (duels)</h4>
          <div class="grid grid2">
            <div class="field">
              <label for="foA">Joueur A</label>
              <select id="foA"></select>
            </div>
            <div class="field">
              <label for="foB">Joueur B</label>
              <select id="foB"></select>
            </div>
            <div class="field">
              <label for="foFrom">Du</label>
              <input id="foFrom" type="date">
            </div>
            <div class="field">
              <label for="foTo">Au</label>
              <input id="foTo" type="date">
            </div>
          </div>
          <div class="right" style="margin-top:8px">
            <button class="btn" id="foRun">Analyser</button>
          </div>
          <div id="foOut" class="muted" style="margin-top:8px">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- Liste -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Historique des duels</h3>
        <div class="right">
          <div class="field" style="min-width:140px">
            <label for="fFrom">Du</label>
            <input id="fFrom" type="date">
          </div>
          <div class="field" style="min-width:140px">
            <label for="fTo">Au</label>
            <input id="fTo" type="date">
          </div>
          <div class="field" style="min-width:180px">
            <label for="fPlayer">Joueur</label>
            <select id="fPlayer"><option value="">(Tous)</option></select>
          </div>
          <button id="reload" class="btn">Rafra√Æchir</button>
          <button class="btn" id="reduceList" aria-expanded="true" aria-controls="listBody">R√©duire</button>
        </div>
      </div>

      <div id="listBody">
        <div class="tableWrap">
          <table class="tbl">
            <thead>
              <tr><th>Date</th><th>Joueur A</th><th>Score</th><th>Joueur B</th><th>Note</th><th></th></tr>
            </thead>
            <tbody id="duelTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Toast -->
<div id="toast" class="toast">Duel enregistr√© ‚úî</div>

<script>
/* ========= helpers / API ========= */
const $  = s => document.querySelector(s);
const API=(localStorage.getItem('efoot.api')||((location.protocol.startsWith('http')?location.protocol:'http:')+'//'+location.hostname+':3000')).replace(/\/+$/,'');
const TOKEN=localStorage.getItem('efoot.token'); const ROLE=(localStorage.getItem('efoot.role')||'member').toLowerCase();
if(!TOKEN){ location.href='login.html'; }

/* ========= Th√®me ========= */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  $('#theme') && apply(localStorage.getItem(k)||'dark');
  $('#theme')?.addEventListener('click',()=>apply(document.documentElement.classList.contains('light')?'dark':'light'));
})();

/* ========= Drawer ========= */
(function(){
  const btn=$('#burger'), dr=$('#drawer'), scr=$('#scrim');
  function open(v){
    dr.classList.toggle('open',v); scr.classList.toggle('open',v);
    btn.setAttribute('aria-expanded', v?'true':'false');
    dr.setAttribute('aria-hidden', v?'false':'true');
  }
  btn.addEventListener('click',()=>open(!dr.classList.contains('open')));
  scr.addEventListener('click',()=>open(false));
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') open(false); });
})();

/* ========= Logout ========= */
$('#logoutBtn')?.addEventListener('click',()=>{
  if(confirm('D√©connexion ?')){ ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k)); location.href='login.html'; }
});

/* ========= fetch prot√©g√© ========= */
async function safeFetch(u,o={},ms=12000){const c=new AbortController();const t=setTimeout(()=>c.abort(),ms);try{return await fetch(u,{signal:c.signal,...o});}finally{clearTimeout(t);}}

/* ========= Players ========= */
const NAME=new Map();
async function loadPlayers(){
  const r=await safeFetch(API+'/players',{headers:{Authorization:'Bearer '+TOKEN}});
  const d=await r.json();
  NAME.clear();
  (d.players||[]).forEach(p=> NAME.set(p.player_id, p.name||p.player_id));
  const opts=[...NAME].map(([id,n])=>`<option value="${id}">${n} ‚Äî ${id}</option>`).join('');
  const fills=(id,withAny)=>{ const el=$('#'+id); if(!el) return; el.innerHTML = (withAny?'<option value="">(Tous)</option>':'<option value="">Choisir‚Ä¶</option>')+opts; };
  fills('pA'); fills('pB'); fills('foA'); fills('foB'); fills('fPlayer', true);
}
function pad2(n){return String(n).padStart(2,'0')}
function nowLocal(){const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;}
$('#dt').value = nowLocal();

/* ========= UI helpers ========= */
function toast(msg='OK'){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1800); }
function fmtDate(x){ return new Date(x).toLocaleString('fr-FR',{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function badge(gf,ga){ return gf>ga?'win':(gf<ga?'lose':'draw'); }

/* ========= Create duel ========= */
$('#save').addEventListener('click', async ()=>{
  const pA=$('#pA').value, pB=$('#pB').value; const sA=+$('#sA').value, sB=+$('#sB').value;
  const played_at=$('#dt').value; const note=($('#note').value||'').trim();
  if(!pA||!pB||pA===pB) return alert('Choisir deux joueurs diff√©rents');
  if(Number.isNaN(sA)||sA<0||Number.isNaN(sB)||sB<0) return alert('Scores invalides');
  const r=await safeFetch(API+'/duels',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({played_at,p1:pA,p2:pB,s1:sA,s2:sB,note})});
  const d=await r.json().catch(()=>({}));
  if(!r.ok){ $('#saveMsg').textContent=d.error||'Erreur'; return; }
  $('#saveMsg').textContent='Duel enregistr√© ‚úî'; toast('Duel enregistr√© ‚úî');
  $('#note').value=''; loadList();
});

/* ========= List duels ========= */
async function loadList(){
  const from=$('#fFrom').value, to=$('#fTo').value, player=$('#fPlayer').value;
  const qs=new URLSearchParams(); if(from) qs.set('from',from); if(to) qs.set('to',to); if(player) qs.set('player',player);
  const r=await safeFetch(API+'/duels?'+qs.toString(),{headers:{Authorization:'Bearer '+TOKEN}});
  const d=await r.json(); const tb=$('#duelTbody'); tb.innerHTML='';
  (d.duels||[]).forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      `<td>${fmtDate(m.played_at)}</td>
       <td>${NAME.get(m.p1)||m.p1}</td>
       <td><span class="score-pill ${badge(m.s1,m.s2)}">${m.s1}&nbsp;‚Äì&nbsp;${m.s2}</span></td>
       <td>${NAME.get(m.p2)||m.p2}</td>
       <td>${m.note||''}</td>
       <td class="right"></td>`;
    if(ROLE==='admin'){
      const b=document.createElement('button'); b.className='btn danger'; b.textContent='Supprimer';
      b.onclick=async()=>{ if(!confirm('Supprimer ce duel ?')) return; const rr=await safeFetch(API+'/duels/'+m.id,{method:'DELETE',headers:{Authorization:'Bearer '+TOKEN}}); if(rr.ok) tr.remove(); };
      tr.lastElementChild.appendChild(b);
    }
    tb.appendChild(tr);
  });
}
$('#reload').addEventListener('click', loadList);

/* ========= Face-off (duels) ========= */
$('#foRun').addEventListener('click', async ()=>{
  const a=$('#foA').value,b=$('#foB').value; if(!a||!b||a===b) return alert('Choisir deux joueurs diff√©rents');
  const qs=new URLSearchParams(); if($('#foFrom').value) qs.set('from',$('#foFrom').value); if($('#foTo').value) qs.set('to',$('#foTo').value);
  const r=await safeFetch(API+`/duels/faceoff/${encodeURIComponent(a)}/${encodeURIComponent(b)}?`+qs.toString(),{headers:{Authorization:'Bearer '+TOKEN}});
  const d=await r.json(); if(!r.ok){ $('#foOut').textContent=d.error||'Erreur'; return; }
  const nA=NAME.get(a)||a, nB=NAME.get(b)||b; const t=d.totals||{legs:0,wins:0,draws:0,losses:0,gf:0,ga:0};
  let html = `<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <b>${nA}</b> vs <b>${nB}</b>
              <span class="badge">Manches ${t.legs}</span>
              <span class="badge win">V ${t.wins}</span>
              <span class="badge draw">N ${t.draws}</span>
              <span class="badge lose">D ${t.losses}</span>
              <span class="badge">${t.gf}‚Äì${t.ga}</span></div>`;
  html += `<div class="tableWrap" style="margin-top:8px"><table class="tbl">
             <thead><tr><th>Date</th><th>Score</th></tr></thead><tbody>`;
  (d.legs||[]).forEach(L=>{
    html += `<tr><td>${fmtDate(L.date)}</td>
             <td><span class="score-pill ${badge(L.gf,L.ga)}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td></tr>`;
  });
  html += `</tbody></table></div>`;
  $('#foOut').innerHTML = html;
});

/* ========= Toggle sections ========= */
function bindToggle(btnId, bodyId){
  const btn=$('#'+btnId), body=$('#'+bodyId);
  btn.addEventListener('click', ()=>{
    const open=btn.getAttribute('aria-expanded')==='true';
    btn.setAttribute('aria-expanded', open?'false':'true');
    btn.textContent = open ? 'D√©velopper' : 'R√©duire';
    body.hidden = open;
  });
}
bindToggle('reduceCreate','createBody');
bindToggle('reduceList','listBody');

/* ========= Init ========= */
(async function init(){
  await loadPlayers();
  await loadList();
  // pr√©sence c√¥t√© membre
  if(ROLE!=='admin'){ const ping=()=>fetch(API+'/presence/ping',{method:'POST',headers:{Authorization:'Bearer '+TOKEN}}).catch(()=>{}); ping(); setInterval(ping,15000); }
})();
</script>
</body>
</html>
