<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Membre ‚Äî GOUZEPE</title>
  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="common.css"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&display=swap" rel="stylesheet">
  <style>
    :root{
      --font-ui:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
      --lh:1.45; --tracking:.01em;
      --bg:#0b1220; --panel:#0f1627; --card:#0c1426; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#2563eb;
    }
    :root.light{--bg:#f4f6fb; --panel:#fff; --card:#fff; --text:#0f172a; --muted:#475569; --border:#e5e7eb; --accent:#1d4ed8}
    html,body{font-family:var(--font-ui); line-height:var(--lh); letter-spacing:var(--tracking)}
    h1,h2,h3{letter-spacing:-.01em}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.12), transparent 40%),
        radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.10), transparent 40%),
        linear-gradient(180deg, rgba(7,10,22,.94), rgba(15,23,42,.96)),
        url('assets/fond.png') center/cover fixed no-repeat;
    }
    html.light body{
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(96,165,250,.18), transparent 42%),
        radial-gradient(900px 600px at 80% 100%, rgba(34,197,94,.16), transparent 42%),
        linear-gradient(180deg, rgba(255,255,255,.86), rgba(245,247,251,.92)),
        url('assets/fond.png') center/cover fixed no-repeat;
    }
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .top{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 6px;background:rgba(12,18,32,.55);backdrop-filter:blur(6px);border-radius:14px}
    html.light .top{background:rgba(255,255,255,.7)}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .logo{width:52px;height:52px;border-radius:14px;background:url('assets/fond.png') center/cover no-repeat;pointer-events:none}
    .menu-toggle{display:none}
    .menu{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    @media (max-width: 840px){
      .menu-toggle{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
      html.light .menu-toggle{background:#fff}
      .menu{
        position:fixed; right:12px; top:64px; z-index:1000; display:none;
        flex-direction:column; gap:10px; width:min(88vw,340px); padding:12px;
        background:var(--panel); border:1px solid var(--border); border-radius:14px;
        box-shadow:0 20px 40px rgba(0,0,0,.35)
      }
      .menu.open{display:flex}
    }
    .btn{border:1px solid var(--border);border-radius:12px;padding:10px 14px;background:#10192c;color:var(--text);cursor:pointer}
    html.light .btn{background:#fff}
    .btn.danger{background:#2a0c0c;border-color:#7f1d1d;color:#fecaca}
    .status{margin:8px 0;color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--panel)}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
    .tbl{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    .muted{opacity:.75}
    /* badges face-√†-face */
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;font-size:12px;font-weight:700}
    .badge.win{background:#064e3b;color:#a7f3d0}
    .badge.draw{background:#1f2937;color:#e5e7eb}
    .badge.lose{background:#5b0b0b;color:#fecaca}
    /* tables scrollables sur mobile */
    @media (max-width:480px){ .tableWrap{overflow:auto; max-height:55vh} .tbl{min-width:600px} }
    
     #h2hModal{max-width:980px;width:min(96vw,980px);border:none;border-radius:16px;padding:0;background:var(--panel);color:var(--text)}
  #h2hModal .h{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
  #h2hModal .b{padding:14px 16px;display:grid;gap:10px}
  #h2hModal .f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}

  /* Toolbar */
  .h2h-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:transparent;cursor:pointer}
  .chip[aria-pressed="true"]{background:rgba(37,99,235,.18);border-color:#2563eb}

  /* R√©sum√© header */
  .h2h-hero{display:flex;align-items:center;gap:14px;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
  .h2h-hero img{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
  .h2h-hero .wdl{display:flex;gap:8px;margin-left:auto}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600}
  .badge.win{background:#064e3b;color:#b7fbdc}
  .badge.draw{background:#1f2937;color:#e5e7eb}
  .badge.lose{background:#5b0b0b;color:#fed7d7}

  /* Tableau */
  .tableWrap{border-radius:14px;overflow:clip}
  #h2hTable{width:100%;border-collapse:separate;border-spacing:0}
  #h2hTable thead th{position:sticky;top:0;background:var(--panel);z-index:1}
  #h2hTable tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
  #h2hTable tbody tr:hover{background:rgba(37,99,235,.08)}
  #h2hTable th,#h2hTable td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}

  /* Score color√© */
  .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:700}
  .score-pill.win{background:#064e3b;color:#b7fbdc}
  .score-pill.draw{background:#1f2937;color:#e5e7eb}
  .score-pill.lose{background:#5b0b0b;color:#fed7d7}

  /* Timeline (mobile, d√©taill√©) */
  .timeline{display:none}
  .day-group{border:1px solid var(--border);border-radius:14px;padding:10px 12px}
  .day-head{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-weight:700}
  .leg-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;padding:8px;border-radius:10px}
  .leg-row + .leg-row{margin-top:6px}
  .me,.opp{display:flex;align-items:center;gap:6px;min-width:0}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  
  @media (max-width: 720px){
    .timeline{display:grid;gap:10px}
    .tableWrap{display:flex;overflow: auto;}
  }
  @media (max-width:480px){
    #h2hTable th,#h2hTable td{padding:10px 12px}
  }
  
  

  </style>

  
</head>
<body>
<div class="wrap">

  <!-- NAV -->
  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
      <h1 style="margin:0;font-size:20px">üë§ Panel Membre</h1>
    </div>
    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" href="Accueil.html">üè† Accueil</a>
      <a class="btn" href="Classement-general.html">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Admin-Joueurs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>
  

  <main style="margin-top:12px">
    <div id="status" class="status">‚Äî</div>

    <!-- Identit√© -->
    <section class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;gap:10px;align-items:center">
          <img id="avatar" src="" alt="photo" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:1px solid var(--border)">
          <div>
            <div class="muted">Connect√© en tant que</div>
            <div id="playerName" style="font-size:20px;font-weight:700">‚Äî</div>
            <div id="playerId" class="muted">‚Äî</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label>Saison :</label>
          <select id="seasonSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="card"><div class="muted">Matchs (aller/retour) jou√©s</div><div id="k_played" style="font-size:24px;font-weight:700">0</div></div>
      <div class="card"><div class="muted">Buts marqu√©s</div><div id="k_bm" style="font-size:24px;font-weight:700">0</div></div>
      <div class="card"><div class="muted">Buts encaiss√©s</div><div id="k_bc" style="font-size:24px;font-weight:700">0</div></div>
      <div class="card"><div class="muted">Rang g√©n√©ral</div><div id="k_rank" style="font-size:24px;font-weight:700">‚Äî</div></div>
      <div class="card"><div class="muted">Points saison</div><div id="k_pts" style="font-size:24px;font-weight:700">‚Äî</div></div>
      <div class="card"><div class="muted">Moyenne</div><div id="k_avg" style="font-size:24px;font-weight:700">‚Äî</div></div>
    </section>

    <!-- Mon profil -->
    <section class="card">
      <h3 style="margin:6px 0">Mon profil</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="nameInp" placeholder="Votre nom"/>
        <button id="saveName" class="btn">Enregistrer nom</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
        <input id="photoInp" type="file" accept="image/*">
        <button id="savePhoto" class="btn">Changer la photo</button>
      </div>
      <div style="margin-top:10px">
        <div class="muted">Changer le mot de passe</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="curPwd" type="password" placeholder="Mot de passe actuel (optionnel)">
          <input id="newPwd" type="password" placeholder="Nouveau mot de passe (min 6)">
          <button id="savePwd" class="btn">Mettre √† jour</button>
        </div>
      </div>
    </section>

    <!-- Mes confrontations (liste rapide + acc√®s H2H) -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:6px 0">Mes confrontations r√©centes</h3>
        <div style="display:flex;gap:6px;align-items:center">
          <label>Saison :</label>
          <select id="seasonConfSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <label>Limite</label>
          <select id="confLimit"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
        </div>
      </div>
      <div class="tableWrap">
        <table class="tbl">
          <thead><tr><th>Date</th><th>Division</th><th>Adversaire</th><th>Manche</th><th>Score</th><th></th></tr></thead>
          <tbody id="confTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Recherche & Profil joueur -->
    <section class="card">
      <h3 style="margin:6px 0">Rechercher un joueur</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="pSearch" placeholder="Nom ou ID‚Ä¶" style="min-width:220px">
        <button id="pSearchBtn" class="btn">Rechercher</button>
      </div>
      <div id="pResults" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px"></div>
    </section>

    <!-- Dialog Profil joueur -->
    <dialog id="pModal">
      <div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700" id="pmTitle">Profil joueur</div>
      <div style="padding:14px;display:grid;gap:10px">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="pmAvatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:1px solid var(--border)">
          <div>
            <div id="pmName" style="font-weight:700">‚Äî</div>
            <div id="pmId" class="muted">‚Äî</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <select id="pmSeason">
            <option value="current">Saison en cours</option>
            <option value="previous">Saison pr√©c√©dente</option>
          </select>
          <button id="pmH2hBtn" class="btn" type="button">Voir face-√†-face</button>
        </div>
        <div id="pmStats" class="muted">‚Äî</div>
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
            <tbody id="pmMatches"></tbody>
          </table>
        </div>
      </div>
      <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" onclick="document.getElementById('pModal').close()">Fermer</button>
      </div>
    </dialog>

    <!-- Dialog Face-√†-face -->
   <dialog id="h2hModal">
  <form method="dialog" style="margin:0">
    <div class="h">
      <div id="h2hTitle">Face-√†-face</div>
      <button class="iconbtn" value="close" aria-label="Fermer">‚úñ</button>
    </div>

    <div class="b">
      <!-- Toolbar -->
      <div class="h2h-toolbar">
        <select id="h2hSeason" title="Saison">
          <option value="current">Saison en cours</option>
          <option value="previous">Saison pr√©c√©dente</option>
        </select>

        <select id="h2hDay" title="Journ√©e">
          <option value="">Toutes journ√©es</option>
          <!-- rempli dynamiquement avec les dates -->
        </select>

        <span class="muted" style="margin-left:6px">Filtrer :</span>
        <button id="h2hD1" class="chip" type="button" aria-pressed="false">D1</button>
        <button id="h2hD2" class="chip" type="button" aria-pressed="false">D2</button>
        <button id="h2hAller"  class="chip" type="button" aria-pressed="false">Aller</button>
        <button id="h2hRetour" class="chip" type="button" aria-pressed="false">Retour</button>
      </div>

      <!-- R√©sum√© -->
      <div class="h2h-hero">
        <img id="h2hMePic"  src="assets/fond.png" alt="">
        <div id="h2hNames">Moi vs Adversaire</div>
        <div class="wdl">
          <span class="badge win"  id="h2hW">V 0</span>
          <span class="badge draw" id="h2hD">N 0</span>
          <span class="badge lose" id="h2hL">D 0</span>
          <span class="badge"      id="h2hGFGA">0-0</span>
        </div>
      </div>

      <!-- Timeline (mobile) -->
      <div class="timeline" id="h2hTimeline"></div>

      <!-- Tableau (desktop) -->
      <div class="tableWrap">
        <table class="tbl" id="h2hTable">
          <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
          <tbody id="h2hBody"></tbody>
        </table>
      </div>
    </div>

    <div class="f">
      <button class="btn" value="close">Fermer</button>
    </div>
  </form>
</dialog>
    <!-- Classement -->
  <section id="seasonBlock" class="card" style="margin-top:12px">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
    <h3 style="margin:6px 0">Classement ‚Äî Saison</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="search" placeholder="Rechercher joueur (nom ou ID)‚Ä¶" style="min-width:220px">
      <button id="seasonReload" class="btn" type="button">Rafra√Æchir</button>
    </div>
  </div>

  <div class="tableWrap">
    <table id="seasonTable" class="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Joueur</th>
          <th class="hid-m">ID</th>
          <th>Total</th>
          <th>Part.</th>
          <th>Moy.</th>
          <th>D1 gagn√©s</th>
          <th>D2 gagn√©s</th>
          <th>√âquipes diff.</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Cartes (mobile) -->
  <div id="seasonCards"></div>
</section>

  </main>

</div>

<script src="common.js"></script>
<script>
/* ===== Th√®me ===== */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);document.getElementById('theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  document.getElementById('theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== Menu mobile ===== */
(function(){
  const menu=document.getElementById('menu'), toggle=document.getElementById('menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',(e)=>{e.stopPropagation();open(!menu.classList.contains('open'));});
  document.addEventListener('click',(e)=>{
    if(!menu.classList.contains('open'))return;
    if(e.target===toggle||menu.contains(e.target))return;
    open(false);
  },true);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') open(false); });
})();

/* ===== Renommer Admin-Joueurs -> Liste des membres pour les membres ===== */
(function(){
  const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
  const lm=document.getElementById('linkMembers');
  if(lm) lm.textContent = (role==='admin') ? 'üë• Admin-Joueurs' : 'üë• Liste des membres';
})();

/* ===== Shim App si besoin ===== */
(function(){
  if(!window.App){
    const DEF_API = () => (location.protocol.startsWith('http') ? location.protocol : 'http:') + '//' + location.hostname + ':3000';
    window.App = {
      getAPI: ()=> (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,''),
      getToken: ()=> localStorage.getItem('efoot.token'),
      logout: ()=>{ localStorage.clear(); location.href='login.html'; },
      toast: (m)=>{ const s=document.getElementById('status'); if(s) s.textContent=m||''; },
      async safeFetch(url,opt={},ms=10000){ const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms); try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t);} }
    };
  }
})();

/* ===== D√©connexion ===== */
document.getElementById('logoutBtn').onclick=()=>{ localStorage.clear(); location.href='login.html'; };

/* ===== Chargement profil + matches + KPIs ===== */
(async function init(){
  const tok = App.getToken?.()||localStorage.getItem('efoot.token');
  const role = (localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!tok){ location.replace('login.html'); return; }
  if(role!=='member' && role!=='admin'){ location.replace('Accueil.html'); return; }

  try{
    const rp = await App.safeFetch(App.getAPI()+'/me/player', { headers:{Authorization:'Bearer '+tok} }, 8000);
    const dp = await rp.json();
    document.getElementById('playerName').textContent = dp.player?.name || '‚Äî';
    document.getElementById('playerId').textContent   = dp.player?.player_id || '‚Äî';
    document.getElementById('avatar').src = dp.player?.profile_pic_url ? (App.getAPI()+dp.player.profile_pic_url) : 'assets/fond.png';

    async function refresh(){
      const season = document.getElementById('seasonSel').value;
      const rs = await App.safeFetch(App.getAPI()+'/me/stats?season='+season, { headers:{Authorization:'Bearer '+tok} }, 10000);
      const ds = await rs.json();
      document.getElementById('k_played').textContent = ds.played_legs ?? 0;
      document.getElementById('k_bm').textContent     = ds.goals_for ?? 0;
      document.getElementById('k_bc').textContent     = ds.goals_against ?? 0;
      document.getElementById('k_rank').textContent   = ds.season_rank ?? '‚Äî';
      document.getElementById('k_pts').textContent    = ds.season_points ?? '‚Äî';
      document.getElementById('k_avg').textContent    = (ds.season_average ?? '‚Äî');

      const rm = await App.safeFetch(App.getAPI()+'/me/matches?season='+season, { headers:{Authorization:'Bearer '+tok} }, 10000);
      const dm = await rm.json();
      const tb = document.getElementById('confTbody'); tb.innerHTML='';
      (dm.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date))
        .slice(0, Number(document.getElementById('confLimit').value||15))
        .forEach(x=>{
          const add = (leg,sc) => `<tr>
              <td>${new Date(x.date).toLocaleDateString('fr-FR')}</td>
              <td>${x.division}</td>
              <td>${(x.opponent_name||x.opponent)}</td>
              <td>${leg}</td>
              <td>${sc}</td>
              <td><button class="btn" data-view="${x.opponent}">Voir</button></td>
            </tr>`;
          if(x.aller)  tb.insertAdjacentHTML('beforeend', add('Aller',  `${x.aller.gf}-${x.aller.ga}`));
          if(x.retour) tb.insertAdjacentHTML('beforeend', add('Retour', `${x.retour.gf}-${x.retour.ga}`));
        });
    }
    document.getElementById('seasonSel').onchange = refresh;
    document.getElementById('confLimit').onchange = refresh;
    document.getElementById('seasonConfSel').onchange = refresh;
    document.getElementById('confTbody').addEventListener('click',(e)=>{
      const pid=e.target?.dataset?.view; if(!pid) return; openPlayerPreview(pid);
    });
    await refresh();
  }catch(e){ App.toast('Erreur de chargement'); console.error(e); }
})();

/* ===== Profil : nom / mot de passe / photo ===== */
(function profile(){
  const API=App.getAPI(), tok=App.getToken?.()||localStorage.getItem('efoot.token');
  document.getElementById('saveName').onclick=async ()=>{
    const name = document.getElementById('nameInp').value.trim();
    if(name.length<2) return alert('Nom trop court');
    const r=await fetch(`${API}/me/name`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+tok},body:JSON.stringify({name})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
  document.getElementById('savePwd').onclick=async ()=>{
    const currentPassword = document.getElementById('curPwd').value;
    const newPassword = document.getElementById('newPwd').value;
    if(!newPassword || newPassword.length<6) return alert('Mot de passe trop court');
    const r=await fetch(`${API}/me/password`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+tok},body:JSON.stringify({currentPassword,newPassword})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    alert('Mot de passe mis √† jour'); document.getElementById('curPwd').value=''; document.getElementById('newPwd').value='';
  };
  document.getElementById('savePhoto').onclick=async ()=>{
    const f=document.getElementById('photoInp').files[0]; if(!f) return alert('Choisir une image');
    const fd=new FormData(); fd.append('photo', f);
    const r=await fetch(`${API}/me/photo`,{method:'POST',headers:{Authorization:'Bearer '+tok},body:fd});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
})();

/* ===== Recherche / Aper√ßu joueur / Face-√†-face ===== */
async function searchPlayers(){
  const q = document.getElementById('pSearch').value.trim();
  const box = document.getElementById('pResults'); box.innerHTML='';
  if(!q) return;

  const r = await fetch(App.getAPI()+'/players/search?q='+encodeURIComponent(q), {
    headers:{Authorization:'Bearer '+(App.getToken?.()||localStorage.getItem('efoot.token'))}
  });
  const d = await r.json();

  (d.players||[]).forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    const img = p.profile_pic_url ? (App.getAPI()+p.profile_pic_url) : 'assets/fond.png';
    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${img}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid var(--border)">
        <div><div style="font-weight:700">${p.name||p.player_id}</div><div class="muted">${p.player_id}</div></div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-preview="${p.player_id}">Aper√ßu</button>
          <button class="btn" data-h2h="${p.player_id}">Face-√†-face</button>
        </div>
      </div>`;
    card.querySelector('button[data-preview]').onclick = ()=> openPlayerPreview(p.player_id);
    card.querySelector('button[data-h2h]').onclick     = ()=> openH2H(p.player_id);
    box.appendChild(card);
  });
}
document.getElementById('pSearchBtn').onclick = searchPlayers;
async function openPlayerPreview(pid){
  const modal = document.getElementById('pModal');
  const seasonSel = document.getElementById('pmSeason');

  async function fill(){
    const pr = await fetch(App.getAPI()+`/players/${pid}`, { headers:{Authorization:'Bearer '+(App.getToken?.()||localStorage.getItem('efoot.token'))} });
    const pd = await pr.json();
    document.getElementById('pmName').textContent = pd.player?.name || '‚Äî';
    document.getElementById('pmId').textContent   = pd.player?.player_id || pid;
    document.getElementById('pmAvatar').src = pd.player?.profile_pic_url ? (App.getAPI()+pd.player.profile_pic_url) : 'assets/fond.png';

    const ss=seasonSel.value;
    const sr = await fetch(App.getAPI()+`/players/${pid}/summary?season=${ss}`, { headers:{Authorization:'Bearer '+(App.getToken?.()||localStorage.getItem('efoot.token'))} });
    const sd = await sr.json();
    document.getElementById('pmStats').textContent =
      `Rang ${sd.rank ?? '‚Äî'} ‚Ä¢ Points ${sd.points ?? '‚Äî'} ‚Ä¢ Moyenne ${sd.moyenne ?? '‚Äî'} ‚Ä¢ `+
      `Manches ${sd.legs ?? 0} ‚Ä¢ BM ${sd.goals_for ?? 0} ‚Ä¢ BC ${sd.goals_against ?? 0}` +
      (sd.best?.date ? ` ‚Ä¢ Best ${sd.best.gf}-${sd.best.ga} (${sd.best.leg}, ${sd.best.division})` : '');

    const mr = await fetch(App.getAPI()+`/players/${pid}/matches?season=${ss}`, { headers:{Authorization:'Bearer '+(App.getToken?.()||localStorage.getItem('efoot.token'))} });
    const md = await mr.json(); const tb=document.getElementById('pmMatches'); tb.innerHTML='';
    (md.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(x=>{
      const appendLeg = (leg, gf, ga)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${new Date(x.date).toLocaleDateString('fr-FR')}</td><td>${x.division}</td><td>${leg}</td><td>${gf}-${ga}</td>`; tb.appendChild(tr); };
      if(x.aller)  appendLeg('Aller',  x.aller.gf,  x.aller.ga);
      if(x.retour) appendLeg('Retour', x.retour.gf, x.retour.ga);
    });
  }
  seasonSel.onchange = fill;
  document.getElementById('pmH2hBtn').onclick = ()=> openH2H(pid);
  await fill(); modal.showModal();
}

async function openH2H(oppId){
  const modal = document.getElementById('h2hModal');
  try{
    const r = await fetch(App.getAPI()+`/faceoff/${encodeURIComponent(oppId)}`, { headers:{Authorization:'Bearer '+(App.getToken?.()||localStorage.getItem('efoot.token'))} });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error||('HTTP '+r.status));

    const title = `Face-√†-face : ${d.me?.name||'Moi'} vs ${d.opponent?.name||oppId}`;
    document.getElementById('h2hTitle').textContent = title;

    const t = d.totals || {legs:0,wins:0,draws:0,losses:0,gf:0,ga:0};
    const who = d.leader==='me' ? '<span class="badge win">Vous menez</span>' :
                d.leader==='opponent' ? '<span class="badge lose">Adversaire en t√™te</span>' :
                '<span class="badge draw">√âgalit√©</span>';

    const bestMe  = d.best_me  ? `${d.best_me.gf}-${d.best_me.ga} (${d.best_me.leg}, ${d.best_me.division}, ${new Date(d.best_me.date).toLocaleDateString('fr-FR')})` : '‚Äî';
    const bestOpp = d.best_opp ? `${d.best_opp.gf}-${d.best_opp.ga} (${d.best_opp.leg}, ${d.best_opp.division}, ${new Date(d.best_opp.date).toLocaleDateString('fr-FR')})` : '‚Äî';

    document.getElementById('h2hSummary').innerHTML =
      `${who} ‚Ä¢ Manches: <b>${t.legs}</b> ‚Ä¢ V: <b>${t.wins}</b> ‚Ä¢ `+
      `N: <b>${t.draws}</b> ‚Ä¢ D: <b>${t.losses}</b> ‚Ä¢ Buts: <b>${t.gf}</b>‚Äì<b>${t.ga}</b><br>`+
      `Meilleur score (vous): <b>${bestMe}</b> ‚Ä¢ Meilleur (${d.opponent?.name||'Adversaire'}): <b>${bestOpp}</b>`;

    const tb=document.getElementById('h2hBody'); tb.innerHTML='';
    (d.legs||[]).forEach(L=>{
      const badge = L.result==='W' ? 'win' : (L.result==='L' ? 'lose' : 'draw');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(L.date).toLocaleDateString('fr-FR')}</td><td>${L.division}</td><td>${L.leg}</td><td><span class="badge ${badge}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td>`;
      tb.appendChild(tr);
    });
    modal.showModal();
  }catch(e){
    console.error(e);
    document.getElementById('h2hSummary').textContent='Impossible de charger le face-√†-face.';
    document.getElementById('h2hBody').innerHTML='';
    modal.showModal();
  }
}

/* ===== Classement g√©n√©ral (bas de page) ===== */
const $ = (s)=>document.querySelector(s);

let seasonData=[];

async function loadSeason(){
  const API = (window.App?.getAPI?.()) || (localStorage.getItem('efoot.api') || ((location.protocol.startsWith('http')?location.protocol:'http:')+'//'+location.hostname+':3000')).replace(/\/+$/,'');
  const token = (window.App?.getToken?.()) || localStorage.getItem('efoot.token');
  try{
    const r=await fetch(`${API}/season/standings`,{headers:{'Authorization':`Bearer ${token}`}});
    const d=await r.json();
    seasonData = d.standings||[];
    renderSeason();
  }catch(e){
    console.error(e);
    seasonData = [];
    renderSeason();
  }
}

function escapeHtml(t){
  return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
}

function renderSeason(){
  const q = ($('#search')?.value||'').toLowerCase();
  const data = (seasonData||[]).filter(x=>(x.name||'').toLowerCase().includes(q) || (x.id||'').toLowerCase().includes(q));

  const tb = $('#seasonTable tbody'); if(tb) tb.innerHTML='';
  data.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      '<td>'+(i+1)+'</td>'
      + '<td>'+escapeHtml(p.name||p.id||'')+'</td>'
      + '<td class="hid-m">'+escapeHtml(p.id||'')+'</td>'
      + '<td>'+(p.total??0)+'</td>'
      + '<td>'+(p.participations??0)+'</td>'
      + '<td>'+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</td>'
      + '<td>'+(p.won_d1??0)+'</td>'
      + '<td>'+(p.won_d2??0)+'</td>'
      + '<td>'+(p.teams_used??0)+'</td>';
    tb.appendChild(tr);
  });

  const cards = $('#seasonCards'); if(cards) cards.innerHTML='';
  data.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML =
      '<div style="font-weight:700;margin-bottom:4px">'+(i+1)+'. '+escapeHtml(p.name||p.id||'')+'</div>'
      + '<div class="grid2">'
      + '<div><span class="muted">ID:</span> '+escapeHtml(p.id||'')+'</div>'
      + '<div><span class="muted">Total:</span> '+(p.total??0)+'</div>'
      + '<div><span class="muted">Part.:</span> '+(p.participations??0)+'</div>'
      + '<div><span class="muted">Moy.:</span> '+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</div>'
      + '<div><span class="muted">D1 gagn√©s:</span> '+(p.won_d1??0)+'</div>'
      + '<div><span class="muted">D2 gagn√©s:</span> '+(p.won_d2??0)+'</div>'
      + '<div><span class="muted">√âquipes diff.:</span> '+(p.teams_used??0)+'</div>'
      + '</div>';
    cards.appendChild(div);
  });
}

// interactions
document.getElementById('seasonReload')?.addEventListener('click', loadSeason);
document.getElementById('search')?.addEventListener('input', renderSeason);

// chargement initial
loadSeason();
/* ===== Ping pr√©sence (membres) ===== */
(function(){
  const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
  const token=App.getToken?.(); const API=App.getAPI?.();
  if(!token || role==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:`Bearer ${token}`}}).catch(()=>{});
  ping(); setInterval(ping, 15000);
})();
// === Menu mobile robuste (id: menuToggle OR menuBtn)
(function(){
  const menu = document.getElementById('menu');
  const toggle = document.getElementById('menuToggle') || document.getElementById('menuBtn');
  if(!menu || !toggle) return;
  function open(v){
    menu.classList.toggle('open', v);
    toggle.setAttribute('aria-expanded', v?'true':'false');
  }
  toggle.addEventListener('click', (e)=>{ e.stopPropagation(); open(!menu.classList.contains('open')); });
  document.addEventListener('click', (e)=>{
    if(!menu.classList.contains('open')) return;
    if(e.target===toggle || menu.contains(e.target)) return;
    open(false);
  }, true);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') open(false); });
})();

(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

(function(){
  const API = () => (window.App?.getAPI?.() || window.EFOOT_API || ((location.protocol.startsWith('http')?location.protocol:'http:')+'//'+location.hostname+':3000')).replace(/\/+$/,'');
  const TOK = () => (window.App?.getToken?.() || localStorage.getItem('efoot.token') || '');
  const $  = s => document.querySelector(s);
  const _pressed = el => el.getAttribute('aria-pressed')==='true';
  const _toggle  = el => el.setAttribute('aria-pressed', _pressed(el)?'false':'true');

  let ME = {name:'Moi', pic:'assets/fond.png'};
  let OPP = {name:'Adversaire'};
  let ALL = [];           // toutes les "legs" (aller/retour) brutes
  let GROUPS = {};        // par journ√©e (yyyy-mm-dd -> legs[])

  function fmtDate(d){ return new Date(d).toLocaleDateString('fr-FR'); }
  function legKey(date){ return new Date(date).toISOString().slice(0,10); } // yyyy-mm-dd

  function computeGroups(){
    GROUPS = {};
    ALL.forEach(L=>{
      const k = legKey(L.date);
      (GROUPS[k]||(GROUPS[k]=[])).push(L);
    });
  }

  function fillDaySelect(){
    const sel = $('#h2hDay');
    const keys = Object.keys(GROUPS).sort((a,b)=> b.localeCompare(a)); // desc
    sel.innerHTML = `<option value="">Toutes journ√©es</option>` +
      keys.map(k=>`<option value="${k}">${fmtDate(k)}</option>`).join('');
  }

  function applyFilters(){
    const wantD1 = _pressed($('#h2hD1')), wantD2 = _pressed($('#h2hD2'));
    const wantA  = _pressed($('#h2hAller')), wantR  = _pressed($('#h2hRetour'));
    const daySel = $('#h2hDay').value; // '' ou yyyy-mm-dd

    const keep = L=>{
      if (daySel && legKey(L.date)!==daySel) return false;
      if (wantD1 || wantD2){
        if (wantD1 && L.division==='D1') {} else if (wantD2 && L.division==='D2') {} else return false;
      }
      if (wantA || wantR){
        if (wantA && /Aller/i.test(L.leg)) {} else if (wantR && /Retour/i.test(L.leg)) {} else return false;
      }
      return true;
    };

    const rows = ALL.filter(keep).sort((a,b)=> new Date(b.date)-new Date(a.date));
    renderTable(rows);
    renderTimeline(rows);
    renderSummary(rows);
  }

  function renderSummary(rows){
    let w=0,d=0,l=0,gf=0,ga=0;
    rows.forEach(L=>{
      gf+=+L.gf; ga+=+L.ga;
      if(L.result==='W') w++; else if(L.result==='L') l++; else d++;
    });
    $('#h2hNames').textContent = `${ME.name} vs ${OPP.name}`;
    $('#h2hMePic').src = ME.pic || 'assets/fond.png';
    $('#h2hW').textContent = `V ${w}`;
    $('#h2hD').textContent = `N ${d}`;
    $('#h2hL').textContent = `D ${l}`;
    $('#h2hGFGA').textContent = `${gf}-${ga}`;
  }

  function renderTable(rows){
    const tb = $('#h2hBody'); tb.innerHTML='';
    rows.forEach(L=>{
      const k = L.result==='W'?'win':(L.result==='L'?'lose':'draw');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${fmtDate(L.date)}</td>
                      <td>${L.division||''}</td>
                      <td>${L.leg||''}</td>
                      <td><span class="score-pill ${k}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td>`;
      tb.appendChild(tr);
    });
  }

  function renderTimeline(rows){
    const host = $('#h2hTimeline'); host.innerHTML='';
    // groupe par journ√©e
    const G = {};
    rows.forEach(L=>{
      const k = legKey(L.date);
      (G[k]||(G[k]=[])).push(L);
    });
    Object.keys(G).sort((a,b)=> b.localeCompare(a)).forEach(k=>{
      const legs = G[k];
      const wrap = document.createElement('div');
      wrap.className='day-group';
      wrap.innerHTML = `<div class="day-head">${fmtDate(k)} ‚Ä¢ ${legs[0]?.division||''}</div>`;
      legs.sort((a,b)=> (a.leg>b.leg?1:-1)).forEach(L=>{
        const cls = L.result==='W'?'win':(L.result==='L'?'lose':'draw');
        wrap.insertAdjacentHTML('beforeend', `
          <div class="leg-row" style="background:${cls==='win'?'#062e24':cls==='lose'?'#2e0d0d':'#111827'}">
            <div class="me"><span class="name">${ME.name}</span></div>
            <div class="score-pill ${cls}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</div>
            <div class="opp" style="justify-content:flex-end"><span class="name">${OPP.name}</span></div>
          </div>`);
      });
      host.appendChild(wrap);
    });
  }

  async function load(oppId){
    const season = $('#h2hSeason').value || 'current';
    const r = await fetch(`${API()}/faceoff/${encodeURIComponent(oppId)}?season=${encodeURIComponent(season)}`, {
      headers:{Authorization:'Bearer '+TOK()}
    });
    const d = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(d.error||('HTTP '+r.status));

    // identit√©s
    ME  = { name: d.me?.name || 'Moi', pic: d.me?.profile_pic_url ? (API()+d.me.profile_pic_url) : 'assets/fond.png' };
    OPP = { name: d.opponent?.name || oppId };
    $('#h2hTitle').textContent = `Face-√†-face : ${ME.name} vs ${OPP.name}`;

    // Legs brutes + normalisation
    ALL = Array.isArray(d.legs) ? d.legs.map(L=>({
      date:L.date, division:L.division, leg:L.leg,
      gf:+L.gf, ga:+L.ga,
      result:(+L.gf > +L.ga) ? 'W' : (+L.gf < +L.ga ? 'L' : 'D')
    })) : [];

    computeGroups();
    fillDaySelect();
    applyFilters();
  }

  // Expose une fonction globale pour ouvrir la modale
  window.openH2H = function(oppId){
    const dlg = document.getElementById('h2hModal');
    if(!dlg._bound){
      $('#h2hSeason').addEventListener('change', ()=> load(dlg._oppId).catch(console.error));
      $('#h2hDay').addEventListener('change', applyFilters);
      ['h2hD1','h2hD2','h2hAller','h2hRetour'].forEach(id=>{
        document.getElementById(id).addEventListener('click', (e)=>{ _toggle(e.currentTarget); applyFilters(); });
      });
      dlg._bound = true;
    }
    dlg._oppId = oppId;
    dlg.showModal();
    load(oppId).catch(err=>{
      console.error(err);
      document.getElementById('h2hBody').innerHTML='';
      document.getElementById('h2hTimeline').innerHTML='';
    });
  };
})();

</script>

<footer style="text-align: center; font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>
</body>
</html>
