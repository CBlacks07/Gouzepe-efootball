<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Membre ‚Äî GOUZEPE</title>

  <!-- Styles globaux -->
  <link rel="stylesheet" href="theme.css"/>

  <!-- Styles sp√©cifiques -->
  <style>
    :root{
      --font-ui: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Trebuchet MS",sans-serif;
      --lh:1.45; --tracking:.01em;
    }
    html,body{font-family:var(--font-ui); line-height:var(--lh); letter-spacing:var(--tracking)}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .status{margin:8px 0;color:var(--muted)}

    /* Sections r√©tractables */
    .section{ margin-top:12px }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px;
    }
    .toggle-card{ display:inline-flex; align-items:center; gap:6px }
    .section-body[hidden]{ display:none !important }

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
    .kpi .big{font-size:24px;font-weight:800}

    /* table wrap */
    .tableWrap{overflow:auto}
    .tbl{min-width:700px}

    /* R√©sultats */
    .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:700}
    .score-pill.win{background:#064e3b;color:#b7fbdc}
    .score-pill.draw{background:#1f2937;color:#e5e7eb}
    .score-pill.lose{background:#5b0b0b;color:#fed7d7}

    /* Comparateur */
    .cmp-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 920px){ .cmp-grid{grid-template-columns:1fr 1fr} }
    .avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
    .cmp-card h4{margin:0 0 6px}
    .stat-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:transparent;cursor:pointer}
    .chip[aria-pressed="true"]{background:rgba(37,99,235,.18);border-color:#2563eb}
    .form5{display:flex;gap:6px}
    .form5 .dot{width:18px;height:18px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
    .form5 .W{background:#064e3b;color:#b7fbdc}
    .form5 .D{background:#1f2937;color:#e5e7eb}
    .form5 .L{background:#5b0b0b;color:#fed7d7}

    /* Modales */
    dialog{border:none;border-radius:14px;max-width:980px;width:min(96vw,980px);padding:0;background:var(--panel);color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}
    .h2h-h{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .h2h-b{padding:14px 16px;display:grid;gap:10px}
    .h2h-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .h2h-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .h2h-hero{display:flex;align-items:center;gap:14px;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .h2h-hero img{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .h2h-hero .wdl{display:flex;gap:8px;margin-left:auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .badge.win{background:#064e3b;color:#b7fbdc}
    .badge.draw{background:#1f2937;color:#e5e7eb}
    .badge.lose{background:#5b0b0b;color:#fed7d7}
    /* nouvel indicateur : qui m√®ne ? */
    .badge.lead{background:#1e3a8a;color:#dbeafe;border-color:#1e3a8a}
  </style>
</head>

<body>
<div class="wrap">

  <!-- NAV -->
  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
    </div>
          <h1 style="margin:0;font-size:22px">üë§ Panel Membre</h1>

    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" href="Accueil.html">üè† Accueil</a>
      <a class="btn" href="Duel.html">üí™üèΩ Duel</a>
      <a class="btn" href="Classement-general.html">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Membres Actifs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <main style="margin-top:12px">
    <div id="status" class="status">‚Äî</div>

    <!-- Identit√© -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon espace</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
        </div>
      </div>
      <div class="section-body">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center">
            <img id="avatar" src="" alt="photo" class="avatar" style="width:64px;height:64px;border-radius:50%">
            <div>
              <div class="muted">Connect√© en tant que</div>
              <div id="playerName" style="font-size:20px;font-weight:700">‚Äî</div>
              <div id="playerId" class="muted">‚Äî</div>
            </div>
          </div>
          <button id="toggleIdent" class="btn toggle-card" aria-expanded="true" aria-controls="identBody">R√©duire</button>
        </div>

        <div id="identBody" style="margin-top:10px">
          <div class="kpis">
            <div class="card kpi"><div class="muted">Manches jou√©es</div><div id="k_played" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts marqu√©s</div><div id="k_bm" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts encaiss√©s</div><div id="k_bc" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Rang g√©n√©ral</div><div id="k_rank" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Points</div><div id="k_pts" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Moyenne</div><div id="k_avg" class="big">‚Äî</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mon profil -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon profil</h3>
        <button class="btn toggle-card" aria-expanded="true" aria-controls="profilBody">R√©duire</button>
      </div>
      <div id="profilBody" class="section-body">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="nameInp" placeholder="Votre nom"/>
          <button id="saveName" class="btn">Enregistrer</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <input id="photoInp" type="file" accept="image/*">
          <button id="savePhoto" class="btn">Changer la photo</button>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Changer le mot de passe</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="curPwd" type="password" placeholder="Mot de passe actuel (optionnel)">
            <input id="newPwd" type="password" placeholder="Nouveau mot de passe (min 6)">
            <button id="savePwd" class="btn">Mettre √† jour</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes confrontations r√©centes -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mes confrontations r√©centes</h3>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonConfSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <label>Limite</label>
          <select id="confLimit"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="confBody">R√©duire</button>
        </div>
      </div>
      <div id="confBody" class="section-body">
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Division</th><th>Adversaire</th><th>Manche</th><th>Score</th><th></th></tr></thead>
            <tbody id="confTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Comparateur de joueurs -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Comparateur de joueurs</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="cmpSeason">
            <option value="current" selected>En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="cmpBody">R√©duire</button>
        </div>
      </div>
      <div id="cmpBody" class="section-body">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <select id="cmpA" style="min-width:220px"><option value="">Joueur A‚Ä¶</option></select>
          <select id="cmpB" style="min-width:220px"><option value="">Joueur B‚Ä¶</option></select>
          <button id="cmpRun" class="btn">Comparer</button>
          <button id="cmpSwap" class="btn">Inverser</button>
        </div>
        <div id="cmpOut" class="cmp-grid"></div>
      </div>
    </section>

    <!-- Recherche & Profil joueur -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Rechercher un joueur</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="pSearch" placeholder="Nom ou ID‚Ä¶" style="min-width:220px">
          <button id="pSearchBtn" class="btn">Rechercher</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="searchBody">R√©duire</button>
        </div>
      </div>
      <div id="searchBody" class="section-body">
        <div id="pResults" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px"></div>
      </div>
    </section>

    <!-- Classement rapide -->
    <section class="card section" id="seasonBlock">
      <div class="section-head">
        <h3 style="margin:6px 0">Classement ‚Äî Saison</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" placeholder="Rechercher joueur‚Ä¶" style="min-width:220px">
          <button id="seasonReload" class="btn" type="button">Rafra√Æchir</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="seasonBody">R√©duire</button>
        </div>
      </div>
      <div id="seasonBody" class="section-body">
        <div class="tableWrap">
          <table id="seasonTable" class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Joueur</th>
                <th class="hid-m">ID</th>
                <th>Total</th>
                <th>Part.</th>
                <th>Moy.</th>
                <th>D1 gagn√©s</th>
                <th>D2 gagn√©s</th>
                <th>√âquipes diff.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <!-- cartes mobiles -->
        <div id="seasonCards" style="margin-top:10px"></div>
      </div>
    </section>

  </main>
</div>

<!-- Modale Profil joueur -->
<dialog id="pModal">
  <div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700" id="pmTitle">Profil joueur</div>
  <div style="padding:14px;display:grid;gap:10px">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="pmAvatar" class="avatar" alt="">
      <div>
        <div id="pmName" style="font-weight:700">‚Äî</div>
        <div id="pmId" class="muted">‚Äî</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <select id="pmSeason">
        <option value="current">Saison en cours</option>
        <option value="previous">Saison pr√©c√©dente</option>
      </select>
      <button id="pmH2hBtn" class="btn" type="button">Voir face-√†-face</button>
    </div>
    <div id="pmStats" class="muted">‚Äî</div>
    <div class="tableWrap">
      <table class="tbl">
        <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
        <tbody id="pmMatches"></tbody>
      </table>
    </div>
  </div>
  <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
    <button class="btn" onclick="document.getElementById('pModal').close()">Fermer</button>
  </div>
</dialog>

<!-- Modale Face-√†-face -->
<dialog id="h2hModal">
  <form method="dialog" style="margin:0">
    <div class="h2h-h">
      <div id="h2hTitle">Face-√†-face</div>
      <button class="btn" value="close" aria-label="Fermer">‚úñ</button>
    </div>
    <div class="h2h-b">
      <div class="h2h-toolbar">
        <select id="h2hSeason" title="Saison">
          <option value="current">Saison en cours</option>
          <option value="previous">Saison pr√©c√©dente</option>
        </select>
        <select id="h2hDay" title="Journ√©e">
          <option value="">Toutes journ√©es</option>
        </select>
        <span class="muted" style="margin-left:6px">Filtrer :</span>
        <button id="h2hD1" class="chip" type="button" aria-pressed="false">D1</button>
        <button id="h2hD2" class="chip" type="button" aria-pressed="false">D2</button>
        <button id="h2hAller"  class="chip" type="button" aria-pressed="false">Aller</button>
        <button id="h2hRetour" class="chip" type="button" aria-pressed="false">Retour</button>
      </div>

      <div class="h2h-hero">
        <img id="h2hMePic" src="assets/fond.png" alt="">
        <div id="h2hNames">Moi vs Adversaire</div>
        <div class="wdl">
          <span class="badge win"  id="h2hW">V 0</span>
          <span class="badge draw" id="h2hD">N 0</span>
          <span class="badge lose" id="h2hL">D 0</span>
          <span class="badge"      id="h2hGFGA">0-0</span>
          <!-- inject√© dynamiquement si absent -->
        </div>
      </div>

      <div class="tableWrap">
        <table class="tbl" id="h2hTable">
          <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
          <tbody id="h2hBody"></tbody>
        </table>
      </div>
    </div>
    <div class="h2h-f">
      <button class="btn" value="close">Fermer</button>
    </div>
  </form>
</dialog>

<footer style="text-align:center;margin:14px 0;color:var(--muted)">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

<script>
/* ===== Utilitaires ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const DEF_API = ()=> (location.protocol.startsWith('http') ? location.protocol : 'http:') + '//' + location.hostname + ':3000';
const API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const TOKEN = localStorage.getItem('efoot.token');

/* ===== Auth guard ===== */
(function(){
  const expAt=+localStorage.getItem('efoot.expAt')||0;
  if(!TOKEN || Date.now()>=expAt){ location.href='login.html'; }
})();

/* ===== Th√®me ===== */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== Menu mobile ===== */
(function(){
  const menu=$('#menu'), toggle=$('#menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',(e)=>{e.stopPropagation();open(!menu.classList.contains('open'));});
  document.addEventListener('click',(e)=>{ if(!menu.classList.contains('open'))return; if(e.target===toggle||menu.contains(e.target))return; open(false); },true);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') open(false); });
})();

/* ===== D√©connexion ===== */
$('#logoutBtn').onclick=()=>{
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
    location.href='login.html';
  }
};

/* ===== fetch prot√©g√© ===== */
async function safeFetch(url,opt={},ms=12000){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms);
  try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t); }
}

/* ===== Donn√©es "moi" ===== */
(async function initMe(){
  // identit√© rapide
  try{
    const rp = await safeFetch(API+'/me/player', { headers:{Authorization:'Bearer '+TOKEN} }, 8000);
    const dp = await rp.json();
    $('#playerName').textContent = dp.player?.name || '‚Äî';
    $('#playerId').textContent   = dp.player?.player_id || '‚Äî';
    $('#avatar').src = dp.player?.profile_pic_url ? (API+dp.player.profile_pic_url) : 'assets/fond.png';
  }catch(e){ console.error(e); }

  async function refresh(){
    // üîß FIX: on prend la saison et la limite de CE bloc
    const season = ($('#seasonConfSel')?.value || $('#seasonSel')?.value || 'current');
    const limit  = Number($('#confLimit')?.value || 15);

    // KPIs (on s'aligne sur le m√™me param√®tre saison)
    const rs = await safeFetch(`${API}/me/stats?season=${season}`, {
      headers:{Authorization:'Bearer '+TOKEN}
    });
    const ds = await rs.json();
    $('#k_played').textContent = ds.played_legs ?? 0;
    $('#k_bm').textContent     = ds.goals_for ?? 0;
    $('#k_bc').textContent     = ds.goals_against ?? 0;
    $('#k_rank').textContent   = ds.season_rank ?? '‚Äî';
    $('#k_pts').textContent    = ds.season_points ?? '‚Äî';
    $('#k_avg').textContent    = (ds.season_average ?? '‚Äî');

    // Confrontations
    const rm = await safeFetch(`${API}/me/matches?season=${season}`, {
      headers:{Authorization:'Bearer '+TOKEN}
    });
    const dm = await rm.json();

    const tb = $('#confTbody');
    tb.innerHTML='';
    (dm.matches||[])
      .sort((a,b)=> new Date(b.date)-new Date(a.date))
      .slice(0, limit)
      .forEach(x=>{
        const add = (leg,sc,badge) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(x.date).toLocaleDateString('fr-FR')}</td>
            <td>${x.division}</td>
            <td>${x.opponent_name||x.opponent}</td>
            <td>${leg}</td>
            <td><span class="score-pill ${badge}">${sc}</span></td>
            <td><button class="btn" data-view="${x.opponent}">Face-√†-face</button></td>`;
          tb.appendChild(tr);
        };
        if(x.aller){
          const r = x.aller.gf>x.aller.ga?'win':x.aller.gf<x.aller.ga?'lose':'draw';
          add('Aller',  `${x.aller.gf}-${x.aller.ga}`,  r);
        }
        if(x.retour){
          const r = x.retour.gf>x.retour.ga?'win':x.retour.gf<x.retour.ga?'lose':'draw';
          add('Retour', `${x.retour.gf}-${x.retour.ga}`, r);
        }
      });
  }

  // üîß FIX: on relie bien les bons s√©lecteurs √† refresh()
  $('#seasonConfSel')?.addEventListener('change', refresh);
  $('#confLimit')?.addEventListener('change', refresh);

  // Optionnel : garder les deux s√©lecteurs de saison synchronis√©s
  $('#seasonConfSel')?.addEventListener('change', ()=>{
    if($('#seasonSel')) $('#seasonSel').value = $('#seasonConfSel').value;
  });

  // Et si la saison globale change (en haut), on peut relancer refresh
  $('#seasonSel')?.addEventListener('change', refresh);

  // bouton Face-√†-face
  $('#confTbody').addEventListener('click',(e)=>{
    const pid=e.target?.dataset?.view; if(!pid) return; openH2H(pid);
  });

  // premier rendu
  refresh();
})();
/* ===== Profil : nom / mot de passe / photo ===== */
(function profile(){
  $('#saveName').onclick=async ()=>{
    const name = $('#nameInp').value.trim();
    if(name.length<2) return alert('Nom trop court');
    const r=await fetch(`${API}/me/name`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({name})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
  $('#savePwd').onclick=async ()=>{
    const currentPassword=$('#curPwd').value;
    const newPassword=$('#newPwd').value;
    if(!newPassword || newPassword.length<6) return alert('Mot de passe trop court');
    const r=await fetch(`${API}/me/password`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({currentPassword,newPassword})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    alert('Mot de passe mis √† jour'); $('#curPwd').value=''; $('#newPwd').value='';
  };
  $('#savePhoto').onclick=async ()=>{
    const f=$('#photoInp').files[0]; if(!f) return alert('Choisir une image');
    const fd=new FormData(); fd.append('photo', f);
    const r=await fetch(`${API}/me/photo`,{method:'POST',headers:{Authorization:'Bearer '+TOKEN},body:fd});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
})();

/* ===== Recherche / aper√ßus ===== */
$('#pSearchBtn').onclick = searchPlayers;
async function searchPlayers(){
  const q = $('#pSearch').value.trim();
  const box = $('#pResults'); box.innerHTML='';
  if(!q) return;
  const r = await fetch(API+'/players/search?q='+encodeURIComponent(q), { headers:{Authorization:'Bearer '+TOKEN} });
  const d = await r.json();
  (d.players||[]).forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    const img = p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/fond.png';
    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${img}" style="width:48px;height:48px;border-radius:12px;object-fit:cover;border:1px solid var(--border)">
        <div><div style="font-weight:700">${p.name||p.player_id}</div><div class="muted">${p.player_id}</div></div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-preview="${p.player_id}">Aper√ßu</button>
          <button class="btn" data-h2h="${p.player_id}">Face-√†-face</button>
        </div>
      </div>`;
    card.querySelector('button[data-preview]').onclick = ()=> openPlayerPreview(p.player_id);
    card.querySelector('button[data-h2h]').onclick     = ()=> openH2H(p.player_id);
    box.appendChild(card);
  });
}
async function openPlayerPreview(pid){
  const modal = $('#pModal'), seasonSel = $('#pmSeason');
  async function fill(){
    const pr = await fetch(API+`/players/${pid}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const pd = await pr.json();
    $('#pmName').textContent = pd.player?.name || '‚Äî';
    $('#pmId').textContent   = pd.player?.player_id || pid;
    $('#pmAvatar').src = pd.player?.profile_pic_url ? (API+pd.player.profile_pic_url) : 'assets/fond.png';

    const ss=seasonSel.value;
    const sr = await fetch(API+`/players/${pid}/summary?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const sd = await sr.json();
    $('#pmStats').textContent =
      `Rang ${sd.rank ?? '‚Äî'} ‚Ä¢ Points ${sd.points ?? '‚Äî'} ‚Ä¢ Moyenne ${sd.moyenne ?? '‚Äî'} ‚Ä¢ `+
      `Manches ${sd.legs ?? 0} ‚Ä¢ BM ${sd.goals_for ?? 0} ‚Ä¢ BC ${sd.goals_against ?? 0}` +
      (sd.best?.date ? ` ‚Ä¢ Best ${sd.best.gf}-${sd.best.ga} (${sd.best.leg}, ${sd.best.division})` : '');

    const mr = await fetch(API+`/players/${pid}/matches?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const md = await mr.json(); const tb=$('#pmMatches'); tb.innerHTML='';
    (md.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(x=>{
      const add = (leg,gf,ga)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(x.date).toLocaleDateString('fr-FR')}</td><td>${x.division}</td><td>${leg}</td><td>${gf}-${ga}</td>`; tb.appendChild(tr); };
      if(x.aller)  add('Aller',  x.aller.gf,  x.aller.ga);
      if(x.retour) add('Retour', x.retour.gf, x.retour.ga);
    });
  }
  seasonSel.onchange = fill;
  $('#pmH2hBtn').onclick = ()=> openH2H(pid);
  await fill(); modal.showModal();
}

/* ===== Face-√†-face : filtres & qui m√®ne ===== */
function _pressed(el){ return el.getAttribute('aria-pressed')==='true'; }
function _toggle(el){ el.setAttribute('aria-pressed', _pressed(el)?'false':'true'); }

async function openH2H(oppId){
  const modal = document.getElementById('h2hModal');
  const selSeason = document.getElementById('h2hSeason');
  const selDay    = document.getElementById('h2hDay');
  const chipD1    = document.getElementById('h2hD1');
  const chipD2    = document.getElementById('h2hD2');
  const chipAller = document.getElementById('h2hAller');
  const chipRetour= document.getElementById('h2hRetour');
  const body      = document.getElementById('h2hBody');

  if(!document.getElementById('h2hLead')){
    const lead = document.createElement('span');
    lead.id='h2hLead'; lead.className='badge lead'; lead.style.marginLeft='6px';
    document.querySelector('.h2h-hero .wdl').appendChild(lead);
  }

  let rawLegs = [];
  let me = null, opp = null;

  async function fetchH2H(){
    const r = await fetch(API+`/faceoff/${encodeURIComponent(oppId)}?season=${encodeURIComponent(selSeason.value||'current')}`, {
      headers:{Authorization:`Bearer ${TOKEN}`}
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d.error||('HTTP '+r.status));
    me  = d.me; opp = d.opponent;

    rawLegs = (d.legs||[]).map(L=>({
      date: new Date(L.date),
      dateKey: new Date(L.date).toISOString().slice(0,10),
      division: (L.division||'').toUpperCase(),
      leg: (L.leg||''),
      gf: Number(L.gf||0),
      ga: Number(L.ga||0)
    })).sort((a,b)=> b.date - a.date);

    document.getElementById('h2hTitle').textContent =
      `Face-√†-face : ${(me?.name||'Moi')} vs ${(opp?.name||'Adversaire')}`;
    document.getElementById('h2hMePic').src =
      (me?.profile_pic_url ? (API+me.profile_pic_url) : 'assets/fond.png');

    const uniqDays = Array.from(new Set(rawLegs.map(x=>x.dateKey)));
    selDay.innerHTML = `<option value="">Toutes journ√©es</option>` +
       uniqDays.map(dk=>`<option value="${dk}">${new Date(dk).toLocaleDateString('fr-FR')}</option>`).join('');

    render();
  }

  function render(){
    const fD1     = _pressed(chipD1);
    const fD2     = _pressed(chipD2);
    const fAller  = _pressed(chipAller);
    const fRetour = _pressed(chipRetour);
    const pickDay = selDay.value;

    let rows = rawLegs.filter(L=>{
      if(pickDay && L.dateKey!==pickDay) return false;
      if(fD1||fD2){
        if(fD1 && L.division!=='D1') return false;
        if(fD2 && L.division!=='D2') return false;
      }
      if(fAller||fRetour){
        if(fAller  && L.leg!=='Aller')  return false;
        if(fRetour && L.leg!=='Retour') return false;
      }
      return true;
    });

    let W=0,D=0,Ls=0, GF=0, GA=0;
    body.innerHTML='';
    rows.forEach(L=>{
      const res = (L.gf>L.ga)?'win':(L.gf<L.ga?'lose':'draw');
      if(res==='win') W++; else if(res==='lose') Ls++; else D++;
      GF+=L.gf; GA+=L.ga;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${L.date.toLocaleDateString('fr-FR')}</td>
        <td>${L.division}</td>
        <td>${L.leg}</td>
        <td><span class="score-pill ${res}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td>`;
      body.appendChild(tr);
    });

    document.getElementById('h2hW').textContent = `V ${W}`;
    document.getElementById('h2hD').textContent = `N ${D}`;
    document.getElementById('h2hL').textContent = `D ${Ls}`;
    document.getElementById('h2hGFGA').textContent = `${GF}-${GA}`;

    const lead = document.getElementById('h2hLead');
    if(W>Ls)      lead.textContent = `Avantage : ${me?.name||'Moi'}`;
    else if(Ls>W) lead.textContent = `Avantage : ${opp?.name||'Adversaire'}`;
    else          lead.textContent = `Avantage : √©galit√©`;
  }

  if(!modal._bound){
    selSeason.addEventListener('change', fetchH2H);
    selDay.addEventListener('change', render);
    [chipD1,chipD2,chipAller,chipRetour].forEach(btn=>{
      btn.addEventListener('click', e=>{ _toggle(e.currentTarget); render(); });
    });
    modal._bound=true;
  }

  await fetchH2H();
  modal.showModal();
}

/* ===== Comparateur ===== */
const NAME_BY_ID = new Map();
const PIC_BY_ID  = new Map();
async function loadPlayersList(){
  if(NAME_BY_ID.size) return;
  const r=await fetch(API+'/players',{headers:{Authorization:'Bearer '+TOKEN}});
  const d=await r.json();
  (d.players||[]).forEach(p=>{
    NAME_BY_ID.set(p.player_id, p.name||p.player_id);
    PIC_BY_ID.set(p.player_id, p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/fond.png');
  });
}
function fillSelectOptions(sel){
  sel.innerHTML = '<option value="">Choisir‚Ä¶</option>' + [...NAME_BY_ID.keys()]
    .map(id=>`<option value="${id}">${NAME_BY_ID.get(id)} ‚Äî ${id}</option>`).join('');
}
function last5Form(matches){
  const arr = [];
  (matches||[]).forEach(x=>{
    if(x.aller){
      arr.push(x.aller.gf>x.aller.ga?'W':(x.aller.gf<x.aller.ga?'L':'D'));
    }
    if(x.retour){
      arr.push(x.retour.gf>x.retour.ga?'W':(x.retour.gf<x.retour.ga?'L':'D'));
    }
  });
  return arr.slice(-5);
}
function formDotsHTML(form){
  if(!form.length) return '<span class="muted">‚Äî</span>';
  return '<div class="form5">'+ form.map(c=>`<span class="dot ${c}">${c}</span>`).join('') + '</div>';
}
async function getSummary(pid, season){
  const rs = await fetch(API+`/players/${pid}/summary?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
  const sum = await rs.json();

  const rm = await fetch(API+`/players/${pid}/matches?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
  const mat = await rm.json();
  const matches = mat.matches || [];

  // fallback manches + BM/BC
  let calcLegs=0, calcGF=0, calcGA=0;
  matches.forEach(m=>{
    if(m.aller){ calcLegs++; calcGF+=Number(m.aller.gf||0);  calcGA+=Number(m.aller.ga||0); }
    if(m.retour){calcLegs++; calcGF+=Number(m.retour.gf||0); calcGA+=Number(m.retour.ga||0); }
  });
  if(typeof sum.legs        !== 'number') sum.legs        = calcLegs;
  if(typeof sum.goals_for   !== 'number') sum.goals_for   = calcGF;
  if(typeof sum.goals_against!== 'number') sum.goals_against = calcGA;

  // titres / rang / points / moyenne via standings si n√©cessaire
  if (typeof sum.won_d1 !== 'number' || typeof sum.won_d2 !== 'number' ||
      typeof sum.points !== 'number' || typeof sum.moyenne !== 'number' || typeof sum.rank !== 'number'){
    try{
      const r2 = await fetch(API+`/season/standings?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
      const d2 = await r2.json();
      const srow = (d2.standings||[]).find(x=>x.id===pid);
      if(srow){
        if(typeof sum.won_d1  !== 'number') sum.won_d1  = srow.won_d1 ?? 0;
        if(typeof sum.won_d2  !== 'number') sum.won_d2  = srow.won_d2 ?? 0;
        if(typeof sum.points  !== 'number') sum.points  = srow.total ?? 0;
        if(typeof sum.moyenne !== 'number') sum.moyenne = srow.moyenne ?? 0;
        if(typeof sum.rank    !== 'number') sum.rank    = (d2.standings||[]).findIndex(x=>x.id===pid)+1 || null;
      }
    }catch(_){}
  }

  return { sum, matches };
}
function buildCmpCard(pid, data){
  const name = NAME_BY_ID.get(pid)||pid;
  const pic  = PIC_BY_ID.get(pid)||'assets/fond.png';
  const s    = data.sum || {};
  const form = formDotsHTML( last5Form(data.matches||[]) );

  const wonD1 = (typeof s.won_d1 === 'number') ? s.won_d1 : '‚Äî';
  const wonD2 = (typeof s.won_d2 === 'number') ? s.won_d2 : '‚Äî';
  const legs  = (typeof s.legs    === 'number') ? s.legs    : 0;
  const bm    = (typeof s.goals_for === 'number') ? s.goals_for : 0;
  const bc    = (typeof s.goals_against === 'number') ? s.goals_against : 0;

  const block = document.createElement('div');
  block.className='card cmp-card';
  block.innerHTML = `
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${pic}" class="avatar" alt="">
      <div>
        <h4>${name}</h4>
        <div class="muted">${pid}</div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="stat-row"><span class="muted">Rang</span><b>${s.rank ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Points</span><b>${s.points ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Moyenne</span><b>${(s.moyenne ?? '‚Äî')}</b></div>
    <div class="stat-row"><span class="muted">Manches</span><b>${legs}</b></div>
    <div class="stat-row"><span class="muted">BM / BC</span><b>${bm} / ${bc}</b></div>
    <div class="stat-row"><span class="muted">Titres D1 / D2</span><b>${wonD1} / ${wonD2}</b></div>
    <div class="stat-row"><span class="muted">Forme (5)</span>${form}</div>
  `;
  return block;
}
(async function initComparator(){
  await loadPlayersList();
  fillSelectOptions($('#cmpA'));
  fillSelectOptions($('#cmpB'));

  $('#cmpSwap').onclick = ()=>{
    const a=$('#cmpA').value, b=$('#cmpB').value;
    $('#cmpA').value=b; $('#cmpB').value=a;
  };

  $('#cmpRun').onclick = async ()=>{
    const A=$('#cmpA').value, B=$('#cmpB').value, season=$('#cmpSeason').value;
    if(!A || !B || A===B) return alert('Choisir deux joueurs diff√©rents.');
    $('#cmpOut').innerHTML = '<div class="muted">Chargement‚Ä¶</div>';
    try{
      const [da, db] = await Promise.all([getSummary(A,season), getSummary(B,season)]);
      const host = $('#cmpOut'); host.innerHTML=''; host.appendChild(buildCmpCard(A,da)); host.appendChild(buildCmpCard(B,db));
    }catch(e){ console.error(e); $('#cmpOut').innerHTML='<div class="muted">Erreur de chargement</div>'; }
  };
})();

/* ===== Classement rapide ===== */
let seasonData=[];
async function loadSeason(){
  try{
    const r=await fetch(`${API}/season/standings`,{headers:{'Authorization':`Bearer ${TOKEN}`}});
    const d=await r.json();
    seasonData = d.standings||[];
    renderSeason();
  }catch(e){ console.error(e); seasonData=[]; renderSeason(); }
}
function escapeHtml(t){return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function renderSeason(){
  const q = ($('#search')?.value||'').toLowerCase();
  const data = (seasonData||[]).filter(x=>(x.name||'').toLowerCase().includes(q) || (x.id||'').toLowerCase().includes(q));

  const tb = $('#seasonTable tbody'); if(tb) tb.innerHTML='';
  data.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      '<td>'+(i+1)+'</td>'
      + '<td>'+escapeHtml(p.name||p.id||'')+'</td>'
      + '<td class="hid-m">'+escapeHtml(p.id||'')+'</td>'
      + '<td>'+(p.total??0)+'</td>'
      + '<td>'+(p.participations??0)+'</td>'
      + '<td>'+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</td>'
      + '<td>'+(p.won_d1??0)+'</td>'
      + '<td>'+(p.won_d2??0)+'</td>'
      + '<td>'+(p.teams_used??0)+'</td>';
    tb.appendChild(tr);
  });

  const cards = $('#seasonCards'); if(cards) cards.innerHTML='';
  data.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML =
      '<div style="font-weight:700;margin-bottom:4px">'+(i+1)+'. '+escapeHtml(p.name||p.id||'')+'</div>'
      + '<div class="grid2">'
      + '<div><span class="muted">ID:</span> '+escapeHtml(p.id||'')+'</div>'
      + '<div><span class="muted">Total:</span> '+(p.total??0)+'</div>'
      + '<div><span class="muted">Part.:</span> '+(p.participations??0)+'</div>'
      + '<div><span class="muted">Moy.:</span> '+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</div>'
      + '<div><span class="muted">D1 gagn√©s:</span> '+(p.won_d1??0)+'</div>'
      + '<div><span class="muted">D2 gagn√©s:</span> '+(p.won_d2??0)+'</div>'
      + '<div><span class="muted">√âquipes diff.:</span> '+(p.teams_used??0)+'</div>'
      + '</div>';
    cards.appendChild(div);
  });
}
$('#seasonReload')?.addEventListener('click', loadSeason);
$('#search')?.addEventListener('input', renderSeason);
loadSeason();

/* ===== Toggle sections ===== */
function bindToggles(){
  $$('.toggle-card').forEach(btn=>{
    const id = btn.getAttribute('aria-controls');
    const box = document.getElementById(id);
    if(!box) return;
    btn.addEventListener('click', ()=>{
      const open = btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded', open?'false':'true');
      btn.textContent = open ? 'D√©velopper' : 'R√©duire';
      box.hidden = open;
    });
  });
}
bindToggles();

/* ===== Ping pr√©sence ===== */
(function(){
  const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!TOKEN || role==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:`Bearer ${TOKEN}`}}).catch(()=>{});
  ping(); setInterval(ping, 15000);
})();
</script>
</body>
</html>
