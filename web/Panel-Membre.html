<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Panel Membre ‚Äî GOUZEPE</title>

  <!-- PWA Meta Tags -->
  <meta name="description" content="Mon espace membre - Statistiques et confrontations" />
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.json" />

  <!-- Styles globaux -->
  <link rel="stylesheet" href="theme.css"/>
  <link rel="stylesheet" href="mobile.css"/>

  <!-- Styles sp√©cifiques (l√©ger) -->
  <style>
    :root{
      --font-ui: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Trebuchet MS",sans-serif;
      --lh:1.45; --tracking:.01em;
      --pad:clamp(12px,2.5vw,22px);
    }
    html,body{font-family:var(--font-ui); line-height:var(--lh); letter-spacing:var(--tracking)}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .status{margin:8px 0;color:var(--muted)}

    /* ===== TOP ===== */
    .top{
      position:sticky;top:0;z-index:40;display:flex;align-items:center;gap:12px;
      padding:10px var(--pad);background:rgba(10,14,22,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)
    }
    html.light .top{background:rgba(255,255,255,.75)}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;user-select:none}
    .logo{width:42px;height:42px;border-radius:12px;object-fit:cover;border:1px solid var(--border);background:#0d1420}
    .brand-title{display:flex;flex-direction:column;line-height:1.1}
    .brand-title h1{margin:0;font-size:18px;letter-spacing:.3px;font-weight:800}
    .season-sub{margin:0;color:var(--muted);font-size:12px}
    #menuToggle{display:none;flex:0 0 auto;appearance:none;border:1px solid var(--border);background:transparent;color:inherit;border-radius:10px;padding:8px 10px;align-items:center;gap:8px}
    .nav{display:flex;align-items:center;gap:8px;overflow-x:auto;padding:4px 0;scrollbar-width:thin;-webkit-overflow-scrolling:touch}
    #menu{display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 12px;border-radius:999px;font-weight:600;border:1px solid var(--border);background:transparent;color:inherit;text-decoration:none;line-height:1;white-space:nowrap;transition:filter .15s,transform .02s}
    .btn:hover{filter:brightness(1.1)} .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(22,163,74,.15);border-color:#1e3a2f}
    .btn.info{background:rgba(59,130,246,.14);border-color:#1e3a8a}
    .btn.warn{background:rgba(245,158,11,.14);border-color:#7c2d12}
    .btn.ghost{background:transparent}
    .btn.danger{background:#2a0c0c;border-color:#7f1d1d;color:#fecaca}
    .spacer{flex:1 1 auto} .tiny{font-size:12px;opacity:.8}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border:1px dashed var(--border);border-radius:999px;font-weight:600;opacity:.9}
    .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .badge-top{display:none}
    @media (max-width: 900px){
      #menuToggle{display:inline-flex}
      .nav{display:none}
      .top.nav-open .nav{display:flex}
    }

    /* Sections r√©tractables */
    .section{ margin-top:12px }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px;
    }
    .toggle-card{ display:inline-flex; align-items:center; gap:6px }
    .section-body[hidden]{ display:none !important }

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
    .kpi .big{font-size:24px;font-weight:800}

    /* Table wrap mobile */
    .tableWrap{overflow:auto}
    .tbl{min-width:700px}

    /* R√©sultats (Mes confrontations) */
    .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:700}
    .score-pill.win{background:#064e3b;color:#b7fbdc}
    .score-pill.draw{background:#1f2937;color:#e5e7eb}
    .score-pill.lose{background:#5b0b0b;color:#fed7d7}

    /* Comparateur */
    .cmp-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 920px){ .cmp-grid{grid-template-columns:1fr 1fr} }
    .avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
    .cmp-card h4{margin:0 0 6px}
    .stat-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:transparent;cursor:pointer}
    .chip[aria-pressed="true"]{background:rgba(37,99,235,.18);border-color:#2563eb}
    .form5{display:flex;gap:6px}
    .form5 .dot{width:18px;height:18px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
    .form5 .W{background:#064e3b;color:#b7fbdc}
    .form5 .D{background:#1f2937;color:#e5e7eb}
    .form5 .L{background:#5b0b0b;color:#fed7d7}

    /* Modale Face-√†-face (d√©j√† en place, peaufin√©e) */
    dialog{border:none;border-radius:14px;max-width:980px;width:min(96vw,980px);padding:0;background:var(--panel);color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}
    .h2h-h{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .h2h-b{padding:14px 16px;display:grid;gap:10px}
    .h2h-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .h2h-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .h2h-hero{display:flex;align-items:center;gap:14px;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .h2h-hero img{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .h2h-hero .wdl{display:flex;gap:8px;margin-left:auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .badge.win{background:#064e3b;color:#b7fbdc}
    .badge.draw{background:#1f2937;color:#e5e7eb}
    .badge.lose{background:#5b0b0b;color:#fed7d7}

    /* === Menu Mobile Moderne === */
    #mobileMenu{
      position:fixed; inset:0; z-index:60;
      background:rgba(0,0,0,.65); backdrop-filter:blur(4px);
      display:flex; align-items:flex-start; justify-content:center;
      padding:0; opacity:0; pointer-events:none;
      transition:opacity .25s ease;
    }
    #mobileMenu:not([hidden]){ opacity:1; pointer-events:auto; }
    #mobileMenu[hidden]{ display:none }

    .mm-panel{
      width:min(94vw,400px); margin-top:0;
      background:var(--panel); color:var(--text);
      border:none; border-bottom-left-radius:16px; border-bottom-right-radius:16px;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      padding:0; max-height:90vh; overflow-y:auto;
      transform:translateY(-100%); transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #mobileMenu:not([hidden]) .mm-panel{ transform:translateY(0); }

    .mm-title{
      font-weight:800; text-align:center; padding:16px;
      border-bottom:1px solid var(--border); margin:0;
      position:sticky; top:0; background:var(--panel); z-index:1;
    }
    .mm-list{display:flex; flex-direction:column; gap:0; padding:8px;}
    .mm-btn{
      display:flex; align-items:center; justify-content:flex-start; gap:12px;
      padding:14px 16px; border-radius:12px; border:none;
      background:transparent; color:inherit; text-decoration:none; font-weight:600;
      transition:background .2s ease;
    }
    .mm-btn:hover, .mm-btn:active{ background:rgba(255,255,255,.06); }
    .mm-theme{display:flex; justify-content:center; padding:8px 16px; border-top:1px solid var(--border);}
    .mm-logout{display:flex; justify-content:center; padding:12px 16px; border-top:1px solid var(--border);}
    .mm-logout .btn{background:rgba(239,68,68,.12);border-color:#7f1d1d;color:#fca5a5; width:100%;}
    .menu-toggle{ display:inline-flex; }
    @media (min-width:841px){ #mobileMenu{ display:none !important } .menu-toggle{ display:none; } }
    @media (min-width: 900px){
      .menu-toggle{display:none !important}
      .nav-desktop{display:flex !important}
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===== TOP ===== -->
  <header class="top" id="topbar">
    <a class="brand" href="./Accueil.html" aria-label="Accueil GOUZEPE">
      <img id="clubLogo" class="logo" src="assets/icons/apple-touch-icon.png" alt="Logo">
      <div class="brand-title">
        <h1>GOUZEPE eFOOTBALL</h1>
        <div class="season-sub"><span id="season-text" style="color: #16a34a; font-weight: bold;">Saison</span></div>
      </div>
    </a>

    <button id="menuToggle" class="btn ghost" aria-controls="menu" aria-expanded="false" title="Ouvrir le menu de navigation">‚ò∞ Menu</button>
    <nav class="nav" aria-label="Navigation principale">
      <div id="menu">
        <a class="btn ghost" href="./Duel.html">üí™üèΩ Duel</a>
        <a class="btn ghost" href="./Classement-general.html">üìä Classements</a>
        <a class="btn ghost" href="./Tournois.html">üèÜ Tournois</a>
        <a class="btn ghost" href="./Panel-Membre.html">üë§ Mon espace</a>
        <a class="btn ghost adminNav" href="./Admin-Joueurs.html" style="display:none">üë• Admin-Joueurs</a>
        <a class="btn ghost adminNav" href="./Admin-Utilisateurs.html" style="display:none">üõ°Ô∏è Admin Utilisateurs</a>
        <button id="logoutBtn" class="btn ghost danger" type="button" title="Se d√©connecter de votre compte">D√©connexion</button>
      </div>
    </nav>

    <div class="spacer"></div>
    <div id="season-badge" class="badge badge-top"><span class="dot"></span><span id="season-top">Saison</span></div>

    <button id="theme" class="btn ghost" title="Th√®me clair/sombre">‚òÄÔ∏è/üåô</button>

    <!-- Menu Mobile Moderne -->
<div id="mobileMenu" hidden>
  <div class="mm-panel" role="dialog" aria-modal="true" aria-labelledby="mmTitle">
    <div id="mmTitle" class="mm-title">
      <span>Menu</span>
      <button id="mmClose" class="btn ghost" style="position:absolute;right:12px;top:12px;padding:6px 10px;font-size:18px;line-height:1" aria-label="Fermer" title="Fermer le menu">‚úï</button>
    </div>
    <div class="mm-list">
      <a class="mm-btn" href="./Duel.html">üí™üèΩ Duel</a>
      <a class="mm-btn" href="./Classement-general.html">üìä Classements</a>
      <a class="mm-btn" href="./Tournois.html">üèÜ Tournois</a>
      <a class="mm-btn" href="./Panel-Membre.html">üë§ Mon espace</a>
      <a class="mm-btn adminOnly" id="mmAdminPlayers" href="./Admin-Joueurs.html" style="display:none">üë• Admin-Joueurs</a>
    </div>
    <div class="mm-theme"><button id="mmTheme" class="btn ghost" title="Basculer entre th√®me clair et sombre">‚òÄÔ∏è / üåô Th√®me</button></div>
    <div class="mm-logout"><button id="mmLogout" class="btn danger" title="Se d√©connecter de votre compte">D√©connexion</button></div>
  </div>
</div>

  </header>

  <main style="margin-top:12px">
    <div id="status" class="status">‚Äî</div>

    <!-- Identit√© -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon espace</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
        </div>
      </div>
      <div class="section-body">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center">
            <img id="avatar" src="" alt="photo" class="avatar" style="width:64px;height:64px;border-radius:50%">
            <div>
              <div class="muted">Connect√© en tant que</div>
              <div id="playerName" style="font-size:20px;font-weight:700">‚Äî</div>
              <div id="playerId" class="muted">‚Äî</div>
            </div>
          </div>
          <button id="toggleIdent" class="btn toggle-card" aria-expanded="true" aria-controls="identBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
        </div>

        <div id="identBody" style="margin-top:10px">
          <div class="kpis">
            <div class="card kpi"><div class="muted">Manches jou√©es</div><div id="k_played" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Moy. buts marqu√©s</div><div id="k_bm" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Moy. buts encaiss√©s</div><div id="k_bc" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Rang g√©n√©ral</div><div id="k_rank" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Points</div><div id="k_pts" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Moyenne</div><div id="k_avg" class="big">‚Äî</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mon profil -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon profil</h3>
        <button class="btn toggle-card" aria-expanded="true" aria-controls="profilBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
      </div>
      <div id="profilBody" class="section-body">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="nameInp" placeholder="Votre nom"/>
          <button id="saveName" class="btn" title="Enregistrer votre nouveau nom">Enregistrer</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <input id="photoInp" type="file" accept="image/*">
          <button id="savePhoto" class="btn" title="T√©l√©charger et enregistrer votre nouvelle photo de profil">Changer la photo</button>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Changer le mot de passe</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="curPwd" type="password" placeholder="Mot de passe actuel (optionnel)">
            <input id="newPwd" type="password" placeholder="Nouveau mot de passe (min 6)">
            <button id="savePwd" class="btn" title="Mettre √† jour votre mot de passe">Mettre √† jour</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes confrontations r√©centes -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mes confrontations r√©centes</h3>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonConfSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <label>Limite</label>
          <select id="confLimit"><option>5</option><option selected>10</option><option>15</option><option value="all">Tous</option></select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="confBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
        </div>
      </div>
      <div id="confBody" class="section-body">
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Division</th><th>Adversaire</th><th>Manche</th><th>Score</th><th></th></tr></thead>
            <tbody id="confTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Comparateur de joueurs -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Comparateur de joueurs</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="cmpSeason">
            <option value="current" selected>En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="cmpBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
        </div>
      </div>
      <div id="cmpBody" class="section-body">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <select id="cmpA" style="min-width:220px"><option value="">Joueur A‚Ä¶</option></select>
          <select id="cmpB" style="min-width:220px"><option value="">Joueur B‚Ä¶</option></select>
          <button id="cmpRun" class="btn" title="Comparer les statistiques des deux joueurs">Comparer</button>
          <button id="cmpSwap" class="btn" title="Inverser la s√©lection des deux joueurs">Inverser</button>
        </div>
        <div id="cmpOut" class="cmp-grid"></div>
      </div>
    </section>

    <!-- Recherche & Profil joueur -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Rechercher un joueur</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="pSearch" placeholder="Nom ou ID‚Ä¶" style="min-width:220px">
          <button id="pSearchBtn" class="btn" title="Rechercher un joueur par nom ou ID">Rechercher</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="searchBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
        </div>
      </div>
      <div id="searchBody" class="section-body">
        <div id="pResults" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px"></div>
      </div>
    </section>

    <!-- Classement rapide -->
    <section class="card section" id="seasonBlock">
      <div class="section-head">
        <h3 style="margin:6px 0">Classement ‚Äî Saison</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" placeholder="Rechercher joueur‚Ä¶" style="min-width:220px">
          <button id="seasonReload" class="btn" type="button" title="Recharger le classement depuis le serveur">Rafra√Æchir</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="seasonBody" title="R√©duire ou d√©velopper cette section">R√©duire</button>
        </div>
      </div>
      <div id="seasonBody" class="section-body">
        <div class="tableWrap">
          <table id="seasonTable" class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Joueur</th>
                <th class="hid-m">ID</th>
                <th>Total</th>
                <th>Part.</th>
                <th>Moy.</th>
                <th>D1 gagn√©s</th>
                <th>D2 gagn√©s</th>
                <th>√âquipes diff.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <!-- cartes mobiles -->
        <div id="seasonCards" style="margin-top:10px"></div>
      </div>
    </section>

  </main>
</div>

<!-- Modale Profil joueur -->
<dialog id="pModal">
  <div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700" id="pmTitle">Profil joueur</div>
  <div style="padding:14px;display:grid;gap:10px">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="pmAvatar" class="avatar">
      <div>
        <div id="pmName" style="font-weight:700">‚Äî</div>
        <div id="pmId" class="muted">‚Äî</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <select id="pmSeason">
        <option value="current">Saison en cours</option>
        <option value="previous">Saison pr√©c√©dente</option>
      </select>
      <button id="pmH2hBtn" class="btn" type="button" title="Voir vos confrontations face-√†-face avec ce joueur">Voir face-√†-face</button>
    </div>
    <div id="pmStats" class="muted">‚Äî</div>
    <div class="tableWrap">
      <table class="tbl">
        <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
        <tbody id="pmMatches"></tbody>
      </table>
    </div>
  </div>
  <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
    <button class="btn" onclick="document.getElementById('pModal').close()" title="Fermer cette fen√™tre">Fermer</button>
  </div>
</dialog>

<!-- Modale Face-√†-face -->
<dialog id="h2hModal">
  <form method="dialog" style="margin:0">
    <div class="h2h-h">
      <div id="h2hTitle">Face-√†-face</div>
      <button class="btn" value="close" aria-label="Fermer" title="Fermer cette fen√™tre">‚úñ</button>
    </div>
    <div class="h2h-b">
      <div class="h2h-toolbar">
        <select id="h2hSeason" title="Saison">
          <option value="current">Saison en cours</option>
          <option value="previous">Saison pr√©c√©dente</option>
        </select>
        <select id="h2hDay" title="Journ√©e">
          <option value="">Toutes journ√©es</option>
        </select>
        <span class="muted" style="margin-left:6px">Filtrer :</span>
        <button id="h2hD1" class="chip" type="button" aria-pressed="false">D1</button>
        <button id="h2hD2" class="chip" type="button" aria-pressed="false">D2</button>
        <button id="h2hAller"  class="chip" type="button" aria-pressed="false">Aller</button>
        <button id="h2hRetour" class="chip" type="button" aria-pressed="false">Retour</button>
      </div>

      <div class="h2h-hero">
        <img id="h2hMePic" src="assets/icons/apple-touch-icon.png" alt="">
        <div id="h2hNames">Moi vs Adversaire</div>
        <div class="wdl">
          <span class="badge win"  id="h2hW">V 0</span>
          <span class="badge draw" id="h2hD">N 0</span>
          <span class="badge lose" id="h2hL">D 0</span>
          <span class="badge"      id="h2hGFGA">0-0</span>
        </div>
      </div>

      <div class="tableWrap">
        <table class="tbl" id="h2hTable">
          <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
          <tbody id="h2hBody"></tbody>
        </table>
      </div>
    </div>
    <div class="h2h-f">
      <button class="btn" value="close" title="Fermer cette fen√™tre">Fermer</button>
    </div>
  </form>
</dialog>

<footer style="text-align:center;margin:14px 0;color:var(--muted)">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

<script>
/* ===== Utilitaires ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const DEF_API = ()=> (location.protocol.startsWith('http') ? location.protocol : 'http:') + '//' + location.hostname + ':3005';
const API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const TOKEN = localStorage.getItem('efoot.token');

/* ===== Helper safeFetch (d√©fini en premier pour l'auth guard) ===== */
async function safeFetch(url,opt={},ms=12000){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms);
  try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t); }
}

/* ===== Auth guard ===== */
(function(){
  const expAt=+localStorage.getItem('efoot.expAt')||0;
  if(!TOKEN || Date.now()>=expAt){
    location.href='login.html';
  }
})();

/* ===== Th√®me ===== */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== Menu Mobile Moderne ===== */
(function(){
  const sheet = $('#mobileMenu');
  const toggle = $('#menuToggle');
  const closeBtn = $('#mmClose');
  const open = ()=>{ sheet.hidden=false; document.body.style.overflow='hidden'; };
  const close= ()=>{ sheet.hidden=true;  document.body.style.overflow=''; };

  toggle?.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
  closeBtn?.addEventListener('click', close);
  sheet?.addEventListener('click', (e)=>{ if(e.target===sheet) close(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && !sheet.hidden) close(); });

  // Synchronise avec les contr√¥les existants
  $('#mmTheme').onclick = ()=> $('#theme').click();
  $('#mmLogout').onclick = ()=> $('#logoutBtn').click();
})();

/* ===== D√©connexion (avec confirmation) ===== */
$('#logoutBtn').onclick=()=>{
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
    location.href='login.html';
  }
};

/* ===== Identit√© + KPIs + confrontations ===== */
(async function initMe(){
  // Charger les saisons d'abord
  try{
    const rSeasons = await safeFetch(API+'/seasons', { headers:{Authorization:'Bearer '+TOKEN} }, 8000);
    const dSeasons = await rSeasons.json();
    const seasonSel = $('#seasonSel');
    seasonSel.innerHTML = '<option value="">Choisir une saison...</option>';

    if(dSeasons.seasons && dSeasons.seasons.length > 0){
      // Trouver la saison active
      let activeSeason = dSeasons.seasons.find(s => !s.is_closed);
      if(!activeSeason) activeSeason = dSeasons.seasons[0]; // Fallback sur la premi√®re

      dSeasons.seasons.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name || `Saison #${s.id}`;
        if(s.id === activeSeason.id) opt.selected = true;
        seasonSel.appendChild(opt);
      });
    }
  }catch(e){
    console.error('Erreur chargement saisons:', e);
    $('#seasonSel').innerHTML = '<option value="">Erreur chargement saisons</option>';
  }

  // Charger l'identit√© du joueur
  try{
    const rp = await safeFetch(API+'/me/player', { headers:{Authorization:'Bearer '+TOKEN} }, 8000);
    const dp = await rp.json();
    $('#playerName').textContent = dp.player?.name || '‚Äî';
    $('#playerId').textContent   = dp.player?.player_id || '‚Äî';
    $('#avatar').src = dp.player?.profile_pic_url ? (API+dp.player.profile_pic_url) : 'assets/icons/apple-touch-icon.png';
  }catch(e){
    console.error('Erreur chargement profil:', e);
    $('#playerName').textContent = 'Erreur';
    $('#playerId').textContent = '‚Äî';
  }

  async function refresh(){
    const season = $('#seasonSel').value;
    if(!season){
      // Pas de saison s√©lectionn√©e
      $('#k_played').textContent = '0';
      $('#k_bm').textContent = '0';
      $('#k_bc').textContent = '0';
      $('#k_rank').textContent = '‚Äî';
      $('#k_pts').textContent = '‚Äî';
      $('#k_avg').textContent = '‚Äî';
      $('#confTbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted)">S√©lectionnez une saison</td></tr>';
      return;
    }
    try{
      const rs = await safeFetch(API+'/me/stats?season='+season, { headers:{Authorization:'Bearer '+TOKEN} });
      const ds = await rs.json();
      const played = ds.played_legs ?? 0;
      const avgGF = played > 0 ? (ds.goals_for / played).toFixed(2) : '0.00';
      const avgGA = played > 0 ? (ds.goals_against / played).toFixed(2) : '0.00';
      $('#k_played').textContent = played;
      $('#k_bm').textContent     = avgGF;
      $('#k_bc').textContent     = avgGA;
      $('#k_rank').textContent   = ds.season_rank ?? '‚Äî';
      $('#k_pts').textContent    = ds.season_points ?? '‚Äî';
      $('#k_avg').textContent    = (ds.season_average ?? '‚Äî');
    }catch(e){
      console.error('Erreur chargement stats:', e);
      $('#k_played').textContent = 'Err';
      $('#k_bm').textContent = 'Err';
      $('#k_bc').textContent = 'Err';
      $('#k_rank').textContent = '‚Äî';
      $('#k_pts').textContent = '‚Äî';
      $('#k_avg').textContent = '‚Äî';
    }

    try{
      const rm = await safeFetch(API+'/me/matches?season='+season, { headers:{Authorization:'Bearer '+TOKEN} });
      const dm = await rm.json();
      const tb = $('#confTbody'); tb.innerHTML='';
      const limitVal = $('#confLimit').value;
      const limit = limitVal === 'all' ? Infinity : Number(limitVal || 10);
      (dm.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date))
      .slice(0, limit)
      .forEach(x=>{
        const add = (leg,sc,badge) => `<tr>
            <td>${new Date(x.date).toLocaleDateString('fr-FR')}</td>
            <td>${x.division}</td>
            <td>${(x.opponent_name||x.opponent)}</td>
            <td>${leg}</td>
            <td><span class="score-pill ${badge}">${sc}</span></td>
            <td><button class="btn" data-view="${x.opponent}">Face-√†-face</button></td>
          </tr>`;
        if(x.aller){
          const r = x.aller.gf>x.aller.ga?'win':x.aller.gf<x.aller.ga?'lose':'draw';
          tb.insertAdjacentHTML('beforeend', add('Aller', `${x.aller.gf}-${x.aller.ga}`, r));
        }
        if(x.retour){
          const r = x.retour.gf>x.retour.ga?'win':x.retour.gf<x.retour.ga?'lose':'draw';
          tb.insertAdjacentHTML('beforeend', add('Retour', `${x.retour.gf}-${x.retour.ga}`, r));
        }
      });
    }catch(e){
      console.error('Erreur chargement matchs:', e);
      $('#confTbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#ef4444">Erreur de chargement des confrontations</td></tr>';
    }
  }
  $('#seasonSel').onchange = refresh;
  $('#confLimit').onchange = refresh;
  $('#seasonConfSel').onchange = refresh;
  $('#confTbody').addEventListener('click',(e)=>{
    const pid=e.target?.dataset?.view; if(!pid) return; openH2H(pid);
  });

  // Appeler refresh() seulement si une saison est s√©lectionn√©e
  if($('#seasonSel').value){
    await refresh();
  }
})();

/* ===== Profil : nom / mot de passe / photo ===== */
(function profile(){
  $('#saveName').onclick=async ()=>{
    const name = $('#nameInp').value.trim();
    if(name.length<2) return alert('Nom trop court');
    const r=await fetch(`${API}/me/name`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({name})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
  $('#savePwd').onclick=async ()=>{
    const currentPassword=$('#curPwd').value;
    const newPassword=$('#newPwd').value;
    if(!newPassword || newPassword.length<6) return alert('Mot de passe trop court');
    const r=await fetch(`${API}/me/password`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({currentPassword,newPassword})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    alert('Mot de passe mis √† jour'); $('#curPwd').value=''; $('#newPwd').value='';
  };
  $('#savePhoto').onclick=async ()=>{
    const f=$('#photoInp').files[0]; if(!f) return alert('Choisir une image');
    const fd=new FormData(); fd.append('photo', f);
    const r=await fetch(`${API}/me/photo`,{method:'POST',headers:{Authorization:'Bearer '+TOKEN},body:fd});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
})();

/* ===== Recherche / aper√ßus ===== */
$('#pSearchBtn').onclick = searchPlayers;
async function searchPlayers(){
  const q = $('#pSearch').value.trim();
  const box = $('#pResults'); box.innerHTML='';
  if(!q) return;
  const r = await fetch(API+'/players/search?q='+encodeURIComponent(q), { headers:{Authorization:'Bearer '+TOKEN} });
  const d = await r.json();
  (d.players||[]).forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    const img = p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/icons/apple-touch-icon.png';
    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${img}" style="width:48px;height:48px;border-radius:12px;object-fit:cover;border:1px solid var(--border)">
        <div><div style="font-weight:700">${p.name||p.player_id}</div><div class="muted">${p.player_id}</div></div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-preview="${p.player_id}">Aper√ßu</button>
          <button class="btn" data-h2h="${p.player_id}">Face-√†-face</button>
        </div>
      </div>`;
    card.querySelector('button[data-preview]').onclick = ()=> openPlayerPreview(p.player_id);
    card.querySelector('button[data-h2h]').onclick     = ()=> openH2H(p.player_id);
    box.appendChild(card);
  });
}
async function openPlayerPreview(pid){
  const modal = $('#pModal'), seasonSel = $('#pmSeason');
  async function fill(){
    const pr = await fetch(API+`/players/${pid}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const pd = await pr.json();
    $('#pmName').textContent = pd.player?.name || '‚Äî';
    $('#pmId').textContent   = pd.player?.player_id || pid;
    $('#pmAvatar').src = pd.player?.profile_pic_url ? (API+pd.player.profile_pic_url) : 'assets/icons/apple-touch-icon.png';

    const ss=seasonSel.value;
    const sr = await fetch(API+`/players/${pid}/summary?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const sd = await sr.json();
    $('#pmStats').textContent =
      `Rang ${sd.rank ?? '‚Äî'} ‚Ä¢ Points ${sd.points ?? '‚Äî'} ‚Ä¢ Moyenne ${sd.moyenne ?? '‚Äî'} ‚Ä¢ `+
      `Manches ${sd.legs ?? 0} ‚Ä¢ BM ${sd.goals_for ?? 0} ‚Ä¢ BC ${sd.goals_against ?? 0}` +
      (sd.best?.date ? ` ‚Ä¢ Best ${sd.best.gf}-${sd.best.ga} (${sd.best.leg}, ${sd.best.division})` : '');

    const mr = await fetch(API+`/players/${pid}/matches?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const md = await mr.json(); const tb=$('#pmMatches'); tb.innerHTML='';
    (md.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(x=>{
      const add = (leg,gf,ga)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(x.date).toLocaleDateString('fr-FR')}</td><td>${x.division}</td><td>${leg}</td><td>${gf}-${ga}</td>`; tb.appendChild(tr); };
      if(x.aller)  add('Aller',  x.aller.gf,  x.aller.ga);
      if(x.retour) add('Retour', x.retour.gf, x.retour.ga);
    });
  }
  seasonSel.onchange = fill;
  $('#pmH2hBtn').onclick = ()=> openH2H(pid);
  await fill(); modal.showModal();
}

/* ===== Face-√†-face (modale) ===== */
function _pressed(el){ return el.getAttribute('aria-pressed')==='true'; }
function _toggle(el){ el.setAttribute('aria-pressed', _pressed(el)?'false':'true'); }
async function openH2H(oppId){
  const modal = $('#h2hModal');
  async function load(){
    const r = await fetch(API+`/faceoff/${encodeURIComponent(oppId)}?season=${encodeURIComponent($('#h2hSeason').value||'current')}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const d = await r.json(); if(!r.ok) throw new Error(d.error||('HTTP '+r.status));
    const t = d.totals || {legs:0,wins:0,draws:0,losses:0,gf:0,ga:0};
    $('#h2hTitle').textContent = `Face-√†-face : ${(d.me?.name||'Moi')} vs ${(d.opponent?.name||'Adversaire')}`;
    $('#h2hMePic').src = d.me?.profile_pic_url ? (API+d.me.profile_pic_url) : 'assets/icons/apple-touch-icon.png';
    $('#h2hW').textContent = `V ${t.wins}`; $('#h2hD').textContent = `N ${t.draws}`; $('#h2hL').textContent = `D ${t.losses}`;
    $('#h2hGFGA').textContent = `${t.gf}-${t.ga}`;

    const tb=$('#h2hBody'); tb.innerHTML='';
    (d.legs||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(L=>{
      const badge = (+L.gf>+L.ga)?'win':(+L.gf<+L.ga?'lose':'draw');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(L.date).toLocaleDateString('fr-FR')}</td>
                      <td>${L.division||''}</td>
                      <td>${L.leg||''}</td>
                      <td><span class="score-pill ${badge}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td>`;
      tb.appendChild(tr);
    });
  }
  if(!modal._bound){
    $('#h2hSeason').addEventListener('change', load);
    ['h2hD1','h2hD2','h2hAller','h2hRetour'].forEach(id=>{
      document.getElementById(id).addEventListener('click',(e)=>{ _toggle(e.currentTarget); /* filtres visuels (option √† brancher si besoin) */ });
    });
    modal._bound=true;
  }
  await load(); modal.showModal();
}

/* ===== Comparateur ===== */
const NAME_BY_ID = new Map();
const PIC_BY_ID  = new Map();
async function loadPlayersList(){
  if(NAME_BY_ID.size) return;
  const r=await fetch(API+'/players',{headers:{Authorization:'Bearer '+TOKEN}});
  const d=await r.json();
  (d.players||[]).forEach(p=>{
    NAME_BY_ID.set(p.player_id, p.name||p.player_id);
    PIC_BY_ID.set(p.player_id, p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/icons/apple-touch-icon.png');
  });
}
function fillSelectOptions(sel){
  sel.innerHTML = '<option value="">Choisir‚Ä¶</option>' + [...NAME_BY_ID.keys()]
    .map(id=>`<option value="${id}">${NAME_BY_ID.get(id)} ‚Äî ${id}</option>`).join('');
}
function last5Form(legs){
  const arr = legs.map(L=>{
    const gf=L.aller?.gf??null, ga=L.aller?.ga??null;
    const gf2=L.retour?.gf??null, ga2=L.retour?.ga??null;
    const out=[];
    if(gf!=null && ga!=null) out.push(gf>ga?'W':(gf<ga?'L':'D'));
    if(gf2!=null && ga2!=null) out.push(gf2>ga2?'W':(gf2<ga2?'L':'D'));
    return out;
  }).flat();
  return arr.slice(-5);
}
function formDotsHTML(form){
  if(!form.length) return '<span class="muted">‚Äî</span>';
  return '<div class="form5">'+ form.map(c=>`<span class="dot ${c}">${c}</span>`).join('') + '</div>';
}
async function getSummary(pid, season){
  // 1) r√©sum√©
  const rs = await fetch(API+`/players/${pid}/summary?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
  const sum = await rs.json();

  // 2) matches (pour calcul de forme)
  const rm = await fetch(API+`/players/${pid}/matches?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
  const mat = await rm.json();

  // 3) fallback : si l'API n'a pas (encore) won_d1/won_d2, va les chercher dans le standings
  if (typeof sum.won_d1 !== 'number' || typeof sum.won_d2 !== 'number') {
    try{
      const r2 = await fetch(API+`/season/standings?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
      const d2 = await r2.json();
      const rec = (d2.standings||[]).find(x=>x.id===pid);
      if(rec){
        sum.won_d1 = rec.won_d1 ?? 0;
        sum.won_d2 = rec.won_d2 ?? 0;
        if(typeof sum.points!=='number')   sum.points   = rec.total ?? sum.points;
        if(typeof sum.moyenne!=='number')  sum.moyenne  = rec.moyenne ?? sum.moyenne;
        if(typeof sum.rank!=='number')     sum.rank     = (d2.standings||[]).findIndex(x=>x.id===pid)+1 || sum.rank;
      }
    }catch(_) {}
  }

  return { sum, matches: mat.matches||[] };
}
function buildCmpCard(pid, data){
  const name = NAME_BY_ID.get(pid)||pid;
  const pic  = PIC_BY_ID.get(pid)||'assets/icons/apple-touch-icon.png';
  const s = data.sum||{};
  const form = formDotsHTML( last5Form(data.matches||[]) );
const wonD1 = (typeof s.won_d1 === 'number') ? s.won_d1 : '‚Äî';
const wonD2 = (typeof s.won_d2 === 'number') ? s.won_d2 : '‚Äî';


  const block = document.createElement('div');
  block.className='card cmp-card';
  block.innerHTML = `
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${pic}" class="avatar">
      <div>
        <h4>${name}</h4>
        <div class="muted">${pid}</div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="stat-row"><span class="muted">Rang</span><b>${s.rank ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Points</span><b>${s.points ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Moyenne</span><b>${(s.moyenne ?? '‚Äî')}</b></div>
    <div class="stat-row"><span class="muted">Manches</span><b>${s.legs ?? 0}</b></div>
    <div class="stat-row"><span class="muted">BM / BC</span><b>${s.goals_for ?? 0} / ${s.goals_against ?? 0}</b></div>
    <div class="stat-row"><span class="muted">Titres D1 / D2</span><b>${wonD1} / ${wonD2}</b></div>
    <div class="stat-row"><span class="muted">Forme (5)</span>${form}</div>
  `;
  return block;
}
(async function initComparator(){
  await loadPlayersList();
  fillSelectOptions($('#cmpA'));
  fillSelectOptions($('#cmpB'));

  $('#cmpSwap').onclick = ()=>{
    const a=$('#cmpA').value, b=$('#cmpB').value;
    $('#cmpA').value=b; $('#cmpB').value=a;
  };

  $('#cmpRun').onclick = async ()=>{
    const A=$('#cmpA').value, B=$('#cmpB').value, season=$('#cmpSeason').value;
    if(!A || !B || A===B) return alert('Choisir deux joueurs diff√©rents.');
    $('#cmpOut').innerHTML = '<div class="muted">Chargement‚Ä¶</div>';
    try{
      const [da, db] = await Promise.all([getSummary(A,season), getSummary(B,season)]);
      const host = $('#cmpOut'); host.innerHTML=''; host.appendChild(buildCmpCard(A,da)); host.appendChild(buildCmpCard(B,db));
    }catch(e){ console.error(e); $('#cmpOut').innerHTML='<div class="muted">Erreur de chargement</div>'; }
  };
})();

/* ===== Classement (bas de page) ===== */
let seasonData=[];
async function loadSeason(){
  try{
    const r=await fetch(`${API}/season/standings`,{headers:{'Authorization':`Bearer ${TOKEN}`}});
    const d=await r.json();
    seasonData = d.standings||[];
    renderSeason();
  }catch(e){ console.error(e); seasonData=[]; renderSeason(); }
}
function escapeHtml(t){return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function renderSeason(){
  const q = ($('#search')?.value||'').toLowerCase();
  const data = (seasonData||[]).filter(x=>(x.name||'').toLowerCase().includes(q) || (x.id||'').toLowerCase().includes(q));

  const tb = $('#seasonTable tbody'); if(tb) tb.innerHTML='';
  data.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      '<td>'+(i+1)+'</td>'
      + '<td>'+escapeHtml(p.name||p.id||'')+'</td>'
      + '<td class="hid-m">'+escapeHtml(p.id||'')+'</td>'
      + '<td>'+(p.total??0)+'</td>'
      + '<td>'+(p.participations??0)+'</td>'
      + '<td>'+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</td>'
      + '<td>'+(p.won_d1??0)+'</td>'
      + '<td>'+(p.won_d2??0)+'</td>'
      + '<td>'+(p.teams_used??0)+'</td>';
    tb.appendChild(tr);
  });

  const cards = $('#seasonCards'); if(cards) cards.innerHTML='';
  data.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML =
      '<div style="font-weight:700;margin-bottom:4px">'+(i+1)+'. '+escapeHtml(p.name||p.id||'')+'</div>'
      + '<div class="grid2">'
      + '<div><span class="muted">ID:</span> '+escapeHtml(p.id||'')+'</div>'
      + '<div><span class="muted">Total:</span> '+(p.total??0)+'</div>'
      + '<div><span class="muted">Part.:</span> '+(p.participations??0)+'</div>'
      + '<div><span class="muted">Moy.:</span> '+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</div>'
      + '<div><span class="muted">D1 gagn√©s:</span> '+(p.won_d1??0)+'</div>'
      + '<div><span class="muted">D2 gagn√©s:</span> '+(p.won_d2??0)+'</div>'
      + '<div><span class="muted">√âquipes diff.:</span> '+(p.teams_used??0)+'</div>'
      + '</div>';
    cards.appendChild(div);
  });
}
$('#seasonReload')?.addEventListener('click', loadSeason);
$('#search')?.addEventListener('input', renderSeason);
loadSeason();

/* ===== Toggle sections ===== */
function bindToggles(){
  $$('.toggle-card').forEach(btn=>{
    const id = btn.getAttribute('aria-controls');
    const box = document.getElementById(id);
    if(!box) return;
    btn.addEventListener('click', ()=>{
      const open = btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded', open?'false':'true');
      btn.textContent = open ? 'D√©velopper' : 'R√©duire';
      box.hidden = open;
    });
  });
}
bindToggles();

/* ===== Ping pr√©sence (membres) ===== */
(function(){
  const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!TOKEN || role==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:`Bearer ${TOKEN}`}}).catch(()=>{});
  ping(); setInterval(ping, 15000);
})();
</script>

<!-- === GOUZEPE additive patch (non-destructif) === -->
<script>
(function(){
  try{
    const isPrivateNet=(h)=>/^(localhost|127\.0\.0\.1|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[01])\.\d+\.\d+)$/.test(h||'');
    const DEF_API=()=>{
      const host=location.hostname||'localhost';
      return (location.protocol.startsWith('http')?location.protocol:'http:')+'//'+host+':3005';
    };
    if(!window.API){ window.API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,''); }
    // Auth guard
    (function(){
      const here=(location.pathname.split('/').pop()||'').toLowerCase();
      if(here==='login.html') return;
      const tok=localStorage.getItem('efoot.token')||'';
      const exp=+localStorage.getItem('efoot.expAt')||0;
      if(!tok || Date.now()>=exp){ location.href='login.html'; return; }
      const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
      const isAdminPage = /^admin-/.test(here) || here==='admin-joueurs.html' || here==='admin-utilisateurs.html';
      if(isAdminPage && role!=='admin'){ location.href='Accueil.html'; }
    })();
    // .adminOnly & .adminNav helper
    document.querySelectorAll('.adminOnly, .adminNav').forEach(el=>{
      const r=(localStorage.getItem('efoot.role')||'member').toLowerCase();
      el.style.display = r==='admin' ? '' : 'none';
    });
  }catch(e){ console.warn('additive patch error', e); }
})();
</script>

  <script src="pwa-init.js"></script>
</body>
</html>

