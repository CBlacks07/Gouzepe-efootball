<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Membre ‚Äî GOUZEPE</title>
  <link rel="stylesheet" href="theme.css"/>

  <style>
    :root{
      --font-ui: system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Trebuchet MS",sans-serif;
      --lh:1.45; --tracking:.01em;
    }
    html,body{font-family:var(--font-ui); line-height:var(--lh); letter-spacing:var(--tracking)}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .status{margin:8px 0;color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--panel)}
    .btn{border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:transparent;cursor:pointer}
    .btn.danger{color:#f87171;border-color:#7f1d1d}
    .top{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .menu{display:flex;gap:8px;flex-wrap:wrap}
    .menu-toggle{display:none}
    @media (max-width:700px){ .menu-toggle{display:inline-flex} }
    .section{ margin-top:12px }
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px}
    .toggle-card{ display:inline-flex; align-items:center; gap:6px }
    .section-body[hidden]{ display:none !important }
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
    .kpi .big{font-size:24px;font-weight:800}
    .tableWrap{overflow:auto}
    .tbl{min-width:700px;border-collapse:collapse;width:100%}
    .tbl th,.tbl td{border:1px solid var(--border);padding:8px}
    .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:700}
    .score-pill.win{background:#064e3b;color:#b7fbdc}
    .score-pill.draw{background:#1f2937;color:#e5e7eb}
    .score-pill.lose{background:#5b0b0b;color:#fed7d7}
    .avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="nav"><div class="logo" aria-hidden="true"></div></div>
    <h1 style="margin:0;font-size:20px">üë§ Panel Membre</h1>
    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" href="Accueil.html">üè† Accueil</a>
      <a class="btn" href="Duel.html">‚öîÔ∏è Duel</a>
      <a class="btn" href="Classement-general.html">üìä Classements</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <main style="margin-top:12px">
    <div id="status" class="status">‚Äî</div>

    <!-- Identit√© -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon espace</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Mon ID joueur :</label>
          <select id="myIdSel" style="min-width:220px"></select>
          <button id="myIdSave" class="btn">Utiliser</button>
        </div>
      </div>
      <div class="section-body">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center">
            <img id="avatar" src="assets/fond.png" alt="photo" class="avatar">
            <div>
              <div class="muted">Connect√©</div>
              <div id="playerName" style="font-size:20px;font-weight:700">‚Äî</div>
              <div id="playerId" class="muted">‚Äî</div>
            </div>
          </div>
          <button id="toggleIdent" class="btn toggle-card" aria-expanded="true" aria-controls="identBody">R√©duire</button>
        </div>

        <div id="identBody" style="margin-top:10px">
          <div class="kpis">
            <div class="card kpi"><div class="muted">Manches jou√©es</div><div id="k_played" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts marqu√©s</div><div id="k_bm" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts encaiss√©s</div><div id="k_bc" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Victoires / Nuls / D√©faites</div><div id="k_wdl" class="big">0 / 0 / 0</div></div>
            <div class="card kpi"><div class="muted">Points</div><div id="k_pts" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Diff√©rence</div><div id="k_diff" class="big">‚Äî</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes confrontations r√©centes -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mes confrontations r√©centes</h3>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <label>Limite</label>
          <select id="confLimit"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="confBody">R√©duire</button>
        </div>
      </div>
      <div id="confBody" class="section-body">
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Adversaire</th><th>Manche</th><th>Score</th><th></th></tr></thead>
            <tbody id="confTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Comparateur de joueurs -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Comparateur de joueurs</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="cmpA" style="min-width:220px"><option value="">Joueur A‚Ä¶</option></select>
          <select id="cmpB" style="min-width:220px"><option value="">Joueur B‚Ä¶</option></select>
          <button id="cmpRun" class="btn">Comparer</button>
          <button id="cmpSwap" class="btn">Inverser</button>
        </div>
      </div>
      <div id="cmpBody" class="section-body">
        <div id="cmpOut" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px"></div>
      </div>
    </section>

    <!-- Classement rapide (depuis /leaderboard) -->
    <section class="card section" id="seasonBlock">
      <div class="section-head">
        <h3 style="margin:6px 0">Classement ‚Äî Saison</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" placeholder="Rechercher joueur‚Ä¶" style="min-width:220px">
          <button class="btn toggle-card" aria-expanded="true" aria-controls="seasonBody">R√©duire</button>
        </div>
      </div>
      <div id="seasonBody" class="section-body">
        <div class="tableWrap">
          <table id="seasonTable" class="tbl">
            <thead>
              <tr>
                <th>#</th><th>Joueur</th><th>ID</th>
                <th>Pts</th><th>J</th><th>V</th><th>N</th><th>D</th><th>BM</th><th>BC</th><th>Diff</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Face-√†-face -->
<dialog id="h2hModal">
  <form method="dialog" style="margin:0">
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700">
      <div id="h2hTitle">Face-√†-face</div>
      <button class="btn" value="close" aria-label="Fermer">‚úñ</button>
    </div>
    <div style="padding:14px 16px;display:grid;gap:10px">
      <div style="display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:12px;padding:10px 12px">
        <img id="h2hMePic" src="assets/fond.png" alt="" class="avatar" style="width:40px;height:40px">
        <div id="h2hNames">Moi vs Adversaire</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <span class="score-pill win"  id="h2hW">V 0</span>
          <span class="score-pill draw" id="h2hD">N 0</span>
          <span class="score-pill lose" id="h2hL">D 0</span>
          <span class="score-pill"      id="h2hGFGA">0-0</span>
        </div>
      </div>
      <div class="tableWrap">
        <table class="tbl" id="h2hTable">
          <thead><tr><th>Date</th><th>Manche</th><th>Score</th></tr></thead>
          <tbody id="h2hBody"></tbody>
        </table>
      </div>
    </div>
    <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" value="close">Fermer</button>
    </div>
  </form>
</dialog>

<footer style="text-align:center;margin:14px 0;color:var(--muted)">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

<script>
/* ===== API helpers ===== */
const isPrivate=(h)=>/^(localhost|127\.0\.0\.1|10\.\d+\.\d+\.\d+|192\.168\.\d+\.\d+|172\.(1[6-9]|2\d|3[01])\.\d+\.\d+)$/.test(h||'');
function DEF_API(){
  const host=location.hostname||'';
  if(isPrivate(host)) return (location.protocol.startsWith('http')?location.protocol:'http:')+'//'+host+':3000';
  if(host.endsWith('.onrender.com')){
    if(host.includes('-app.')) return 'https://'+host.replace('-app.','-api.');
    if(host.includes('app.'))  return 'https://'+host.replace('app.','api.');
  }
  return 'https://gouzepe-api.onrender.com';
}
const API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const TOKEN = localStorage.getItem('efoot.token')||'';
const HDRS = TOKEN ? { Authorization:'Bearer '+TOKEN } : {};
async function safeFetch(url,opt={},ms=12000){ const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms); try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t); } }

/* ===== Auth guard ===== */
(function(){
  const expAt=+localStorage.getItem('efoot.expAt')||0;
  if(!TOKEN || Date.now()>=expAt){ location.href='login.html'; }
})();

/* ===== Th√®me ===== */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);document.getElementById('theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  document.getElementById('theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== Menu ===== */
(function(){
  const menu=document.getElementById('menu'), toggle=document.getElementById('menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',(e)=>{e.stopPropagation();open(!menu.classList.contains('open'));});
  document.addEventListener('click',(e)=>{ if(!menu.classList.contains('open'))return; if(e.target===toggle||menu.contains(e.target))return; open(false); },true);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') open(false); });
})();

/* ===== D√©connexion ===== */
document.getElementById('logoutBtn').onclick=()=>{
  if(confirm('Se d√©connecter ?')){
    const keep=new Set(['efoot.theme','efoot.api']);
    for(let i=localStorage.length-1;i>=0;i--){ const k=localStorage.key(i); if(!keep.has(k)) localStorage.removeItem(k); }
    sessionStorage.clear();
    location.href='login.html';
  }
};

/* ===== Choix / m√©morisation de mon ID joueur ===== */
let ALL_PLAYERS=[];
async function loadPlayersList(){
  try{
    const r=await safeFetch(API+'/players',{headers:HDRS});
    const d=await r.json();
    ALL_PLAYERS = d.players||[];
    const sel=document.getElementById('myIdSel');
    sel.innerHTML = '<option value="">‚Äî choisir ‚Äî</option>' + ALL_PLAYERS.map(p=>`<option value="${p.player_id}">${(p.name||p.player_id)} ‚Äî ${p.player_id}</option>`).join('');
    // pr√©-s√©lection si d√©j√† connu
    const me = localStorage.getItem('efoot.playerId') || '';
    if(me) sel.value = me;
    // remplir comparateur
    document.getElementById('cmpA').innerHTML = '<option value="">Joueur A‚Ä¶</option>' + sel.innerHTML.replace('‚Äî choisir ‚Äî','Joueur A‚Ä¶');
    document.getElementById('cmpB').innerHTML = '<option value="">Joueur B‚Ä¶</option>' + sel.innerHTML.replace('‚Äî choisir ‚Äî','Joueur B‚Ä¶');
  }catch(e){ console.error(e); }
}
document.getElementById('myIdSave').onclick=()=>{
  const v=document.getElementById('myIdSel').value;
  if(!v) return alert('Choisis ton ID joueur');
  localStorage.setItem('efoot.playerId', v);
  bootIdentity();
  bootRecent();
};

/* ===== Identit√© & KPIs ===== */
async function bootIdentity(){
  const pid = localStorage.getItem('efoot.playerId')||'';
  document.getElementById('playerId').textContent = pid || '‚Äî';
  if(!pid){
    document.getElementById('status').textContent = 'S√©lectionne ton ID joueur en haut.';
    document.getElementById('playerName').textContent='‚Äî';
    document.getElementById('avatar').src='assets/fond.png';
    ['k_played','k_bm','k_bc','k_wdl','k_pts','k_diff'].forEach(id=>document.getElementById(id).textContent='‚Äî');
    return;
  }
  try{
    const pr = await safeFetch(API+`/players/${encodeURIComponent(pid)}`, { headers:HDRS }, 8000);
    const pd = await pr.json();
    document.getElementById('playerName').textContent = pd.name || pd.player?.name || pid;
    document.getElementById('avatar').src = (pd.profile_pic_url||pd.player?.profile_pic_url) ? (API + (pd.profile_pic_url||pd.player?.profile_pic_url)) : 'assets/fond.png';
  }catch(e){ console.error(e); }

  try{
    const sr = await safeFetch(API+`/players/${encodeURIComponent(pid)}/stats`, { headers:HDRS }, 8000);
    const st = await sr.json(); const s=st.stats||st||{};
    const wins=+s.wins||0, draws=+s.draws||0, losses=+s.losses||0, gf=+s.gf||0, ga=+s.ga||0, games=+s.games||0;
    document.getElementById('k_played').textContent = games;
    document.getElementById('k_bm').textContent = gf;
    document.getElementById('k_bc').textContent = ga;
    document.getElementById('k_wdl').textContent = `${wins} / ${draws} / ${losses}`;
    // points & diff approximatifs bas√©s sur duels
    document.getElementById('k_pts').textContent = wins*3 + draws;
    document.getElementById('k_diff').textContent = (gf-ga);
  }catch(e){ console.error(e); }
}

/* ===== Confrontations r√©centes ===== */
async function bootRecent(){
  const pid = localStorage.getItem('efoot.playerId')||'';
  const tb = document.getElementById('confTbody'); tb.innerHTML='';
  if(!pid){ tb.innerHTML='<tr><td colspan="5" class="muted">S√©lectionne ton ID joueur ci-dessus.</td></tr>'; return; }
  try{
    const r=await safeFetch(API+`/duels/recent?player=${encodeURIComponent(pid)}&limit=${encodeURIComponent(document.getElementById('confLimit').value||15)}`, { headers:HDRS });
    const d=await r.json();
    const arr=(d.duels||[]);
    if(!arr.length){ tb.innerHTML='<tr><td colspan="5" class="muted">Aucun duel trouv√©</td></tr>'; return; }
    arr.sort((a,b)=> new Date(b.played_at)-new Date(a.played_at));
    arr.forEach(x=>{
      const meIsA = String(x.p1_id)===String(pid);
      const opp = meIsA ? (x.p2_name||x.p2_id) : (x.p1_name||x.p1_id);
      const gf = meIsA ? x.score_a : x.score_b;
      const ga = meIsA ? x.score_b : x.score_a;
      const badge = (gf>ga)?'win':(gf<ga?'lose':'draw');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${x.played_at? new Date(x.played_at).toLocaleDateString('fr-FR'): '‚Äî'}</td>
                      <td>${opp}</td>
                      <td>${meIsA?'Aller':'Retour'}</td>
                      <td><span class="score-pill ${badge}">${gf}&nbsp;‚Äì&nbsp;${ga}</span></td>
                      <td><button class="btn" data-view="${meIsA?x.p2_id:x.p1_id}">Face-√†-face</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="5" class="muted">Erreur de chargement</td></tr>';
  }
}
document.getElementById('confLimit').onchange = bootRecent;
document.getElementById('confTbody').addEventListener('click', (e)=>{
  const pid=e.target?.dataset?.view; if(!pid) return;
  openH2H(pid);
});

/* ===== Face-√†-face ===== */
async function openH2H(oppId){
  const me = localStorage.getItem('efoot.playerId')||'';
  if(!me) return alert('Choisis d‚Äôabord ton ID joueur.');
  const modal=document.getElementById('h2hModal');
  try{
    const r=await safeFetch(API+`/duels/compare?p1=${encodeURIComponent(me)}&p2=${encodeURIComponent(oppId)}`, { headers:HDRS });
    const d=await r.json();
    const t=d.totals||{wins:0,draws:0,losses:0,gf:0,ga:0,legs:0};
    document.getElementById('h2hTitle').textContent = `Face-√†-face : ${(d.p1?.name||d.p1?.id||me)} vs ${(d.p2?.name||d.p2?.id||oppId)}`;
    document.getElementById('h2hW').textContent = `V ${t.wins}`;
    document.getElementById('h2hD').textContent = `N ${t.draws}`;
    document.getElementById('h2hL').textContent = `D ${t.losses}`;
    document.getElementById('h2hGFGA').textContent = `${t.gf}-${t.ga}`;
    const body=document.getElementById('h2hBody'); body.innerHTML='';
    // Pas de liste de manches d√©taill√©e c√¥t√© serveur -> on reconstruit depuis /duels/recent pour les deux joueurs
    const [a,b] = await Promise.all([
      safeFetch(API+`/duels/recent?player=${encodeURIComponent(me)}&limit=200`,{headers:HDRS}).then(r=>r.json()).catch(()=>({duels:[]})),
      safeFetch(API+`/duels/recent?player=${encodeURIComponent(oppId)}&limit=200`,{headers:HDRS}).then(r=>r.json()).catch(()=>({duels:[]})),
    ]);
    const combined = [...(a.duels||[]), ...(b.duels||[])]
      .filter(x=> (x.p1_id===me && x.p2_id===oppId) || (x.p1_id===oppId && x.p2_id===me))
      .sort((x,y)=> new Date(y.played_at)-new Date(x.played_at));
    combined.forEach(x=>{
      const meIsA = x.p1_id===me;
      const gf = meIsA? x.score_a : x.score_b;
      const ga = meIsA? x.score_b : x.score_a;
      const badge = (gf>ga)?'win':(gf<ga?'lose':'draw');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${x.played_at? new Date(x.played_at).toLocaleDateString('fr-FR'): '‚Äî'}</td>
                      <td>${meIsA?'Aller':'Retour'}</td>
                      <td><span class="score-pill ${badge}">${gf}&nbsp;‚Äì&nbsp;${ga}</span></td>`;
      body.appendChild(tr);
    });
    modal.showModal();
  }catch(e){
    alert('Impossible de charger le face-√†-face');
  }
}

/* ===== Comparateur (cartes) ===== */
function cardFrom(pid, name, stats){
  const div=document.createElement('div'); div.className='card';
  const s=stats||{};
  div.innerHTML = `
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:6px">
      <img src="${s.pic||'assets/fond.png'}" class="avatar">
      <div><div style="font-weight:700">${name||pid}</div><div class="muted">${pid}</div></div>
    </div>
    <div class="tableWrap">
      <table class="tbl">
        <tbody>
          <tr><td>V/N/D</td><td>${s.wins||0} / ${s.draws||0} / ${s.losses||0}</td></tr>
          <tr><td>BM / BC</td><td>${s.gf||0} / ${s.ga||0}</td></tr>
          <tr><td>Manches</td><td>${s.games||0}</td></tr>
          <tr><td>Points (approx.)</td><td>${(s.wins||0)*3 + (s.draws||0)}</td></tr>
          <tr><td>Diff.</td><td>${(s.gf||0)-(s.ga||0)}</td></tr>
        </tbody>
      </table>
    </div>
  `;
  return div;
}
document.getElementById('cmpSwap').onclick=()=>{
  const A=document.getElementById('cmpA'), B=document.getElementById('cmpB');
  const va=A.value; A.value=B.value; B.value=va;
};
document.getElementById('cmpRun').onclick=async ()=>{
  const A=document.getElementById('cmpA').value, B=document.getElementById('cmpB').value;
  if(!A || !B || A===B) return alert('Choisis deux joueurs diff√©rents.');
  const out=document.getElementById('cmpOut'); out.innerHTML='Chargement‚Ä¶';
  try{
    const [a,b] = await Promise.all([
      safeFetch(API+`/players/${encodeURIComponent(A)}/stats`,{headers:HDRS}).then(r=>r.json()).catch(()=>({stats:{}})),
      safeFetch(API+`/players/${encodeURIComponent(B)}/stats`,{headers:HDRS}).then(r=>r.json()).catch(()=>({stats:{}})),
    ]);
    const nameA = (ALL_PLAYERS.find(p=>p.player_id===A)||{}).name || A;
    const nameB = (ALL_PLAYERS.find(p=>p.player_id===B)||{}).name || B;
    out.innerHTML=''; out.appendChild(cardFrom(A,nameA,a.stats||a)); out.appendChild(cardFrom(B,nameB,b.stats||b));
  }catch(e){
    out.innerHTML='<div class="muted">Erreur de chargement</div>';
  }
};

/* ===== Classement (depuis /leaderboard) ===== */
let leaderboard=[];
async function loadLeaderboard(){
  try{
    const r=await safeFetch(API+'/leaderboard',{headers:HDRS});
    const d=await r.json();
    leaderboard = d.leaderboard||[];
    renderLeaderboard();
  }catch(e){ console.error(e); leaderboard=[]; renderLeaderboard(); }
}
function escapeHtml(t){return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function renderLeaderboard(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const data = leaderboard.filter(x=> (x.name||'').toLowerCase().includes(q) || (x.player_id||'').toLowerCase().includes(q));
  const tb=document.querySelector('#seasonTable tbody'); tb.innerHTML='';
  data.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(p.name||p.player_id||'')}</td><td>${escapeHtml(p.player_id||'')}</td>
                    <td>${p.points??0}</td><td>${p.games??0}</td><td>${p.wins??0}</td><td>${p.draws??0}</td><td>${p.losses??0}</td>
                    <td>${p.gf??0}</td><td>${p.ga??0}</td><td>${p.gd??((p.gf||0)-(p.ga||0))}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('search').addEventListener('input', renderLeaderboard);

/* ===== Boot ===== */
(async function boot(){
  await loadPlayersList();
  await bootIdentity();
  await bootRecent();
  await loadLeaderboard();
})();
</script>
</body>
</html>
