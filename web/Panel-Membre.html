<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Panel Membre ‚Äî GOUZEPE</title>

  <link rel="stylesheet" href="theme.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --font-ui:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Trebuchet MS",sans-serif; --lh:1.45; --tracking:.01em }
    html,body{font-family:var(--font-ui); line-height:var(--lh); letter-spacing:var(--tracking)}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .status{margin:8px 0;color:var(--muted)}
    .section{ margin-top:12px }
    .section-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:10px}
    .toggle-card{ display:inline-flex; align-items:center; gap:6px }
    .section-body[hidden]{ display:none !important }
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin:10px 0}
    .kpi .big{font-size:24px;font-weight:800}
    .tableWrap{overflow:auto}
    .tbl{min-width:700px}
    .score-pill{display:inline-block;min-width:46px;text-align:center;padding:4px 8px;border-radius:10px;border:1px solid var(--border);font-weight:700}
    .score-pill.win{background:#064e3b;color:#b7fbdc}
    .score-pill.draw{background:#1f2937;color:#e5e7eb}
    .score-pill.lose{background:#5b0b0b;color:#fed7d7}
    .cmp-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 920px){ .cmp-grid{grid-template-columns:1fr 1fr} }
    .avatar{width:56px;height:56px;border-radius:12px;object-fit:cover;border:1px solid var(--border)}
    .cmp-card h4{margin:0 0 6px}
    .stat-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:transparent;cursor:pointer}
    .chip[aria-pressed="true"]{background:rgba(37,99,235,.18);border-color:#2563eb}
    .form5{display:flex;gap:6px}
    .form5 .dot{width:18px;height:18px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800}
    .form5 .W{background:#064e3b;color:#b7fbdc}
    .form5 .D{background:#1f2937;color:#e5e7eb}
    .form5 .L{background:#5b0b0b;color:#fed7d7}
    dialog{border:none;border-radius:14px;max-width:980px;width:min(96vw,980px);padding:0;background:var(--panel);color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.4);backdrop-filter:blur(1.5px)}
    .h2h-h{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .h2h-b{padding:14px 16px;display:grid;gap:10px}
    .h2h-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .h2h-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .h2h-hero{display:flex;align-items:center;gap:14px;border:1px solid var(--border);border-radius:14px;padding:10px 12px}
    .h2h-hero img{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .h2h-hero .wdl{display:flex;gap:8px;margin-left:auto}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .badge.win{background:#064e3b;color:#b7fbdc}
    .badge.draw{background:#1f2937;color:#e5e7eb}
    .badge.lose{background:#5b0b0b;color:#fed7d7}
  </style>
</head>

<body>
<div class="wrap">

  <!-- NAV -->
  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
      <h1 style="margin:0;font-size:20px">üë§ Panel Membre</h1>
    </div>
    <button id="menuToggle" class="menu-toggle" aria-label="Ouvrir le menu" aria-expanded="false" aria-controls="menu">‚ò∞</button>
    <div id="menu" class="menu top">
      <a class="btn" href="Accueil.html">üè† Accueil</a>
      <a class="btn" href="Classement-general.html">üìä Classements</a>
      <a class="btn" id="linkMembers" href="Admin-Joueurs.html">üë• Admin-Joueurs</a>
      <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn danger">D√©connexion</button>
    </div>
  </div>

  <main style="margin-top:12px">
    <div id="status" class="status">‚Äî</div>

    <!-- Identit√© -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon espace</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
        </div>
      </div>
      <div class="section-body">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
          <div style="display:flex;gap:10px;align-items:center">
            <img id="avatar" src="" alt="photo" class="avatar" style="width:64px;height:64px;border-radius:50%">
            <div>
              <div class="muted">Connect√© en tant que</div>
              <div id="playerName" style="font-size:20px;font-weight:700">‚Äî</div>
              <div id="playerId" class="muted">‚Äî</div>
            </div>
          </div>
          <button id="toggleIdent" class="btn toggle-card" aria-expanded="true" aria-controls="identBody">R√©duire</button>
        </div>

        <div id="identBody" style="margin-top:10px">
          <div class="kpis">
            <div class="card kpi"><div class="muted">Manches jou√©es</div><div id="k_played" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts marqu√©s</div><div id="k_bm" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Buts encaiss√©s</div><div id="k_bc" class="big">0</div></div>
            <div class="card kpi"><div class="muted">Rang g√©n√©ral</div><div id="k_rank" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Points</div><div id="k_pts" class="big">‚Äî</div></div>
            <div class="card kpi"><div class="muted">Moyenne</div><div id="k_avg" class="big">‚Äî</div></div>
          </div>

          <!-- Graphiques -->
          <div class="tableWrap" style="min-width:0">
            <div style="display:grid;grid-template-columns:1fr;gap:12px">
              <div class="card">
                <h3>Points par journ√©e (moyenne glissante)</h3>
                <canvas id="chartPoints"></canvas>
              </div>
              <div class="card">
                <h3>√âvolution du rang</h3>
                <canvas id="chartRank"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mon profil -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mon profil</h3>
        <button class="btn toggle-card" aria-expanded="true" aria-controls="profilBody">R√©duire</button>
      </div>
      <div id="profilBody" class="section-body">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="nameInp" placeholder="Votre nom"/>
          <button id="saveName" class="btn">Enregistrer</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <input id="photoInp" type="file" accept="image/*">
          <button id="savePhoto" class="btn">Changer la photo</button>
        </div>
        <div style="margin-top:10px">
          <div class="muted">Changer le mot de passe</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="curPwd" type="password" placeholder="Mot de passe actuel (optionnel)">
            <input id="newPwd" type="password" placeholder="Nouveau mot de passe (min 6)">
            <button id="savePwd" class="btn">Mettre √† jour</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes confrontations r√©centes -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Mes confrontations r√©centes</h3>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="seasonConfSel">
            <option value="current">En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <label>Limite</label>
          <select id="confLimit"><option>10</option><option selected>15</option><option>25</option><option>50</option></select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="confBody">R√©duire</button>
        </div>
      </div>
      <div id="confBody" class="section-body">
        <div class="tableWrap">
          <table class="tbl">
            <thead><tr><th>Date</th><th>Division</th><th>Adversaire</th><th>Manche</th><th>Score</th><th></th></tr></thead>
            <tbody id="confTbody"></tbody>
          </table>
        </div>
        <div class="card" style="margin-top:10px">
          <h3>S√©rie GF/GA</h3>
          <canvas id="foChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Comparateur de joueurs -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Comparateur de joueurs</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label>Saison :</label>
          <select id="cmpSeason">
            <option value="current" selected>En cours</option>
            <option value="previous">Pr√©c√©dente</option>
          </select>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="cmpBody">R√©duire</button>
        </div>
      </div>
      <div id="cmpBody" class="section-body">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <select id="cmpA" style="min-width:220px"><option value="">Joueur A‚Ä¶</option></select>
          <select id="cmpB" style="min-width:220px"><option value="">Joueur B‚Ä¶</option></select>
          <button id="cmpRun" class="btn">Comparer</button>
          <button id="cmpSwap" class="btn">Inverser</button>
        </div>
        <div id="cmpOut" class="cmp-grid"></div>
        <div class="card" style="margin-top:10px">
          <h3>Radar</h3>
          <canvas id="cmpRadar"></canvas>
        </div>
      </div>
    </section>

    <!-- Recherche & Profil joueur -->
    <section class="card section">
      <div class="section-head">
        <h3 style="margin:6px 0">Rechercher un joueur</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="pSearch" placeholder="Nom ou ID‚Ä¶" style="min-width:220px">
          <button id="pSearchBtn" class="btn">Rechercher</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="searchBody">R√©duire</button>
        </div>
      </div>
      <div id="searchBody" class="section-body">
        <div id="pResults" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px"></div>
      </div>
    </section>

    <!-- Classement rapide -->
    <section class="card section" id="seasonBlock">
      <div class="section-head">
        <h3 style="margin:6px 0">Classement ‚Äî Saison</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="search" placeholder="Rechercher joueur‚Ä¶" style="min-width:220px">
          <button id="seasonReload" class="btn" type="button">Rafra√Æchir</button>
          <button class="btn toggle-card" aria-expanded="true" aria-controls="seasonBody">R√©duire</button>
        </div>
      </div>
      <div id="seasonBody" class="section-body">
        <div class="tableWrap">
          <table id="seasonTable" class="tbl">
            <thead>
              <tr>
                <th>#</th><th>Joueur</th><th class="hid-m">ID</th>
                <th>Total</th><th>Part.</th><th>Moy.</th>
                <th>D1 gagn√©s</th><th>D2 gagn√©s</th><th>√âquipes diff.</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="seasonCards" style="margin-top:10px"></div>
      </div>
    </section>

  </main>
</div>

<!-- Modale Profil joueur -->
<dialog id="pModal">
  <div style="padding:14px;border-bottom:1px solid var(--border);font-weight:700" id="pmTitle">Profil joueur</div>
  <div style="padding:14px;display:grid;gap:10px">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="pmAvatar" class="avatar" alt="">
      <div>
        <div id="pmName" style="font-weight:700">‚Äî</div>
        <div id="pmId" class="muted">‚Äî</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <select id="pmSeason"><option value="current">Saison en cours</option><option value="previous">Saison pr√©c√©dente</option></select>
      <button id="pmH2hBtn" class="btn" type="button">Voir face-√†-face</button>
    </div>
    <div id="pmStats" class="muted">‚Äî</div>
    <div class="tableWrap">
      <table class="tbl">
        <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
        <tbody id="pmMatches"></tbody>
      </table>
    </div>
  </div>
  <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end">
    <button class="btn" onclick="document.getElementById('pModal').close()">Fermer</button>
  </div>
</dialog>

<!-- Modale Face-√†-face -->
<dialog id="h2hModal">
  <form method="dialog" style="margin:0">
    <div class="h2h-h">
      <div id="h2hTitle">Face-√†-face</div>
      <button class="btn" value="close" aria-label="Fermer">‚úñ</button>
    </div>
    <div class="h2h-b">
      <div class="h2h-toolbar">
        <select id="h2hSeason"><option value="current">Saison en cours</option><option value="previous">Saison pr√©c√©dente</option></select>
        <span class="muted" style="margin-left:6px">Filtrer :</span>
        <button id="h2hD1" class="chip" type="button" aria-pressed="false">D1</button>
        <button id="h2hD2" class="chip" type="button" aria-pressed="false">D2</button>
        <button id="h2hAller"  class="chip" type="button" aria-pressed="false">Aller</button>
        <button id="h2hRetour" class="chip" type="button" aria-pressed="false">Retour</button>
      </div>
      <div class="h2h-hero">
        <img id="h2hMePic" src="assets/fond.png" alt="">
        <div id="h2hNames">Moi vs Adversaire</div>
        <div class="wdl">
          <span class="badge win"  id="h2hW">V 0</span>
          <span class="badge draw" id="h2hD">N 0</span>
          <span class="badge lose" id="h2hL">D 0</span>
          <span class="badge"      id="h2hGFGA">0-0</span>
        </div>
      </div>
      <div class="tableWrap" style="margin-top:8px">
        <table class="tbl" id="h2hTable">
          <thead><tr><th>Date</th><th>Division</th><th>Manche</th><th>Score</th></tr></thead>
          <tbody id="h2hBody"></tbody>
        </table>
      </div>
    </div>
    <div class="h2h-f"><button class="btn" value="close">Fermer</button></div>
  </form>
</dialog>

<footer style="text-align:center;margin:14px 0;color:var(--muted)">Copyright ¬© -GOUZEPE GAMING CLUB 2025</footer>

<script>
/* ===== Utils ===== */
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const DEF_API = ()=> (location.protocol.startsWith('http') ? location.protocol : 'http:') + '//' + location.hostname + ':3000';
const API = (localStorage.getItem('efoot.api')||DEF_API()).replace(/\/+$/,'');
const TOKEN = localStorage.getItem('efoot.token');

/* ===== Auth guard ===== */
(function(){
  const expAt=+localStorage.getItem('efoot.expAt')||0;
  if(!TOKEN || Date.now()>=expAt){ location.href='login.html'; }
})();

/* ===== Th√®me + Charts recolor ===== */
let CHARTS=[];
function chartCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() }
function refreshCharts(){
  CHARTS.forEach(c=>{ try{c.destroy()}catch(_){ } });
  CHARTS=[];
  // relance les rendus si data pr√©sente
  if(window._seriesReady){ renderStatsCharts(window._SERIES); }
  if(window._foSeries){ renderFaceoffChart(window._foSeries); }
  if(window._radarSeries){ renderRadar(window._radarSeries); }
}
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);$('#theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'; refreshCharts();};
  apply(localStorage.getItem(k)||'dark');
  $('#theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== Menu mobile ===== */
(function(){
  const menu=$('#menu'), toggle=$('#menuToggle');
  function open(v){menu.classList.toggle('open',v);toggle.setAttribute('aria-expanded',v?'true':'false')}
  toggle?.addEventListener('click',(e)=>{e.stopPropagation();open(!menu.classList.contains('open'));});
  document.addEventListener('click',(e)=>{ if(!menu.classList.contains('open'))return; if(e.target===toggle||menu.contains(e.target))return; open(false); },true);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') open(false); });
})();

/* ===== D√©connexion ===== */
$('#logoutBtn').onclick=()=>{
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    ['efoot.token','efoot.role','efoot.expAt'].forEach(k=>localStorage.removeItem(k));
    location.href='login.html';
  }
};

/* ===== fetch s√©curis√© ===== */
async function safeFetch(url,opt={},ms=15000){
  const c=new AbortController(); const t=setTimeout(()=>c.abort(),ms);
  try{ return await fetch(url,{signal:c.signal,...opt}); } finally{ clearTimeout(t); }
}

/* ===== Identit√© + KPIs + Confrontations (liste) ===== */
let SELF_ID=null;
(async function initMe(){
  try{
    const rp = await safeFetch(API+'/me/player', { headers:{Authorization:'Bearer '+TOKEN} }, 8000);
    const dp = await rp.json();
    $('#playerName').textContent = dp.player?.name || '‚Äî';
    $('#playerId').textContent   = dp.player?.player_id || '‚Äî';
    $('#avatar').src = dp.player?.profile_pic_url ? (API+dp.player.profile_pic_url) : 'assets/fond.png';
    SELF_ID = dp.player?.player_id || null;
  }catch(e){ console.error(e); }

  async function refreshBlocks(){
    const season = $('#seasonSel').value;
    const rs = await safeFetch(API+'/me/stats?season='+season, { headers:{Authorization:'Bearer '+TOKEN} });
    const ds = await rs.json();
    $('#k_played').textContent = ds.played_legs ?? 0;
    $('#k_bm').textContent     = ds.goals_for ?? 0;
    $('#k_bc').textContent     = ds.goals_against ?? 0;
    $('#k_rank').textContent   = ds.season_rank ?? '‚Äî';
    $('#k_pts').textContent    = ds.season_points ?? '‚Äî';
    $('#k_avg').textContent    = (ds.season_average ?? '‚Äî');

    const rm = await safeFetch(API+'/me/matches?season='+season, { headers:{Authorization:'Bearer '+TOKEN} });
    const dm = await rm.json();
    const tb = $('#confTbody'); tb.innerHTML='';
    const legs=[];
    (dm.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date))
      .slice(0, Number($('#confLimit').value||15))
      .forEach(x=>{
        const add = (leg,sc,badge,gf,ga) => {
          legs.push({date:x.date, gf, ga});
          return `<tr>
            <td>${new Date(x.date).toLocaleDateString('fr-FR')}</td>
            <td>${x.division}</td>
            <td>${(x.opponent_name||x.opponent)}</td>
            <td>${leg}</td>
            <td><span class="score-pill ${badge}">${sc}</span></td>
            <td><button class="btn" data-view="${x.opponent}">Face-√†-face</button></td>
          </tr>`;
        };
        if(x.aller){
          const r = x.aller.gf>x.aller.ga?'win':x.aller.gf<x.aller.ga?'lose':'draw';
          tb.insertAdjacentHTML('beforeend', add('Aller', `${x.aller.gf}-${x.aller.ga}`, r, x.aller.gf, x.aller.ga));
        }
        if(x.retour){
          const r = x.retour.gf>x.retour.ga?'win':x.retour.gf<x.retour.ga?'lose':'draw';
          tb.insertAdjacentHTML('beforeend', add('Retour', `${x.retour.gf}-${x.retour.ga}`, r, x.retour.gf, x.retour.ga));
        }
      });
    $('#confTbody').onclick=(e)=>{ const pid=e.target?.dataset?.view; if(pid) openH2H(pid); };

    // S√©rie GF/GA (graph)
    window._foSeries = { legs };
    renderFaceoffChart(window._foSeries);

    // S√©rie points & rang (graph)
    const ser = await seriesPointsAndRank(season);
    window._SERIES = ser; window._seriesReady = true;
    renderStatsCharts(ser);
  }
  $('#seasonSel').onchange = refreshBlocks;
  $('#confLimit').onchange = refreshBlocks;
  $('#seasonConfSel').onchange = refreshBlocks;
  refreshBlocks();
})();

/* ===== Profil ===== */
(function profile(){
  $('#saveName').onclick=async ()=>{
    const name = $('#nameInp').value.trim();
    if(name.length<2) return alert('Nom trop court');
    const r=await fetch(`${API}/me/name`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({name})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
  $('#savePwd').onclick=async ()=>{
    const currentPassword=$('#curPwd').value;
    const newPassword=$('#newPwd').value;
    if(!newPassword || newPassword.length<6) return alert('Mot de passe trop court');
    const r=await fetch(`${API}/me/password`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+TOKEN},body:JSON.stringify({currentPassword,newPassword})});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    alert('Mot de passe mis √† jour'); $('#curPwd').value=''; $('#newPwd').value='';
  };
  $('#savePhoto').onclick=async ()=>{
    const f=$('#photoInp').files[0]; if(!f) return alert('Choisir une image');
    const fd=new FormData(); fd.append('photo', f);
    const r=await fetch(`${API}/me/photo`,{method:'POST',headers:{Authorization:'Bearer '+TOKEN},body:fd});
    if(!r.ok){ const d=await r.json().catch(()=>({})); return alert(d.error||'Erreur'); }
    location.reload();
  };
})();

/* ===== Recherche / aper√ßus ===== */
$('#pSearchBtn').onclick = searchPlayers;
async function searchPlayers(){
  const q = $('#pSearch').value.trim();
  const box = $('#pResults'); box.innerHTML='';
  if(!q) return;
  const r = await fetch(API+'/players/search?q='+encodeURIComponent(q), { headers:{Authorization:'Bearer '+TOKEN} });
  const d = await r.json();
  (d.players||[]).forEach(p=>{
    const card=document.createElement('div'); card.className='card';
    const img = p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/fond.png';
    card.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <img src="${img}" style="width:48px;height:48px;border-radius:12px;object-fit:cover;border:1px solid var(--border)">
        <div><div style="font-weight:700">${p.name||p.player_id}</div><div class="muted">${p.player_id}</div></div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" data-preview="${p.player_id}">Aper√ßu</button>
          <button class="btn" data-h2h="${p.player_id}">Face-√†-face</button>
        </div>
      </div>`;
    card.querySelector('button[data-preview]').onclick = ()=> openPlayerPreview(p.player_id);
    card.querySelector('button[data-h2h]').onclick     = ()=> openH2H(p.player_id);
    box.appendChild(card);
  });
}
async function openPlayerPreview(pid){
  const modal = $('#pModal'), seasonSel = $('#pmSeason');
  async function fill(){
    const pr = await fetch(API+`/players/${pid}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const pd = await pr.json();
    $('#pmName').textContent = pd.player?.name || '‚Äî';
    $('#pmId').textContent   = pd.player?.player_id || pid;
    $('#pmAvatar').src = pd.player?.profile_pic_url ? (API+pd.player.profile_pic_url) : 'assets/fond.png';

    const ss=seasonSel.value;
    const sr = await fetch(API+`/players/${pid}/summary?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const sd = await sr.json();
    $('#pmStats').textContent =
      `Rang ${sd.rank ?? '‚Äî'} ‚Ä¢ Points ${sd.points ?? '‚Äî'} ‚Ä¢ Moyenne ${sd.moyenne ?? '‚Äî'} ‚Ä¢ `+
      `Manches ${sd.legs ?? 0} ‚Ä¢ BM ${sd.goals_for ?? 0} ‚Ä¢ BC ${sd.goals_against ?? 0}` +
      (sd.best?.date ? ` ‚Ä¢ Best ${sd.best.gf}-${sd.best.ga} (${sd.best.leg}, ${sd.best.division})` : '');

    const mr = await fetch(API+`/players/${pid}/matches?season=${ss}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const md = await mr.json(); const tb=$('#pmMatches'); tb.innerHTML='';
    (md.matches||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(x=>{
      const add = (leg,gf,ga)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${new Date(x.date).toLocaleDateString('fr-FR')}</td><td>${x.division}</td><td>${leg}</td><td>${gf}-${ga}</td>`; tb.appendChild(tr); };
      if(x.aller)  add('Aller',  x.aller.gf,  x.aller.ga);
      if(x.retour) add('Retour', x.retour.gf, x.retour.ga);
    });
  }
  seasonSel.onchange = fill;
  $('#pmH2hBtn').onclick = ()=> openH2H(pid);
  await fill(); modal.showModal();
}

/* ===== Face-√†-face (modale + graph s√©rie globale GF/GA) ===== */
function _pressed(el){ return el.getAttribute('aria-pressed')==='true'; }
function _toggle(el){ el.setAttribute('aria-pressed', _pressed(el)?'false':'true'); }
let H2H_CHART=null;
function renderFaceoffChart(series){
  const ctx=$('#foChart'); if(!ctx) return;
  if(H2H_CHART){ try{H2H_CHART.destroy()}catch(_){ } }
  const labels=(series.legs||[]).map((_,i)=>'M'+(i+1));
  const gf=(series.legs||[]).map(x=>x.gf), ga=(series.legs||[]).map(x=>x.ga);
  H2H_CHART = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[
      {label:'GF', data:gf, backgroundColor: chartCSS('--accent')+'55', borderColor: chartCSS('--accent'), borderWidth:1},
      {label:'GA', data:ga, backgroundColor: chartCSS('--danger-500')+'55', borderColor: chartCSS('--danger-500'), borderWidth:1}
    ]},
    options:{ responsive:true, plugins:{legend:{labels:{boxWidth:12}}}, scales:{ y:{ beginAtZero:true, ticks:{precision:0}}}}
  });
  CHARTS.push(H2H_CHART);
}
async function openH2H(oppId){
  const modal = $('#h2hModal');
  async function load(){
    const r = await fetch(API+`/faceoff/${encodeURIComponent(oppId)}?season=${encodeURIComponent($('#h2hSeason').value||'current')}`, { headers:{Authorization:'Bearer '+TOKEN} });
    const d = await r.json(); if(!r.ok) throw new Error(d.error||('HTTP '+r.status));
    const t = d.totals || {legs:0,wins:0,draws:0,losses:0,gf:0,ga:0};
    $('#h2hTitle').textContent = `Face-√†-face : ${(d.me?.name||'Moi')} vs ${(d.opponent?.name||'Adversaire')}`;
    $('#h2hMePic').src = d.me?.profile_pic_url ? (API+d.me.profile_pic_url) : 'assets/fond.png';
    $('#h2hW').textContent = `V ${t.wins}`; $('#h2hD').textContent = `N ${t.draws}`; $('#h2hL').textContent = `D ${t.losses}`;
    $('#h2hGFGA').textContent = `${t.gf}-${t.ga}`;
    const tb=$('#h2hBody'); tb.innerHTML='';
    const legs=[];
    (d.legs||[]).sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(L=>{
      const badge = (+L.gf>+L.ga)?'win':(+L.gf<+L.ga?'lose':'draw');
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${new Date(L.date).toLocaleDateString('fr-FR')}</td>
                      <td>${L.division||''}</td>
                      <td>${L.leg||''}</td>
                      <td><span class="score-pill ${badge}">${L.gf}&nbsp;‚Äì&nbsp;${L.ga}</span></td>`;
      tb.appendChild(tr);
      legs.push({date:L.date, gf:L.gf, ga:L.ga});
    });
    renderFaceoffChart({legs:legs.reverse()});
  }
  if(!modal._bound){
    $('#h2hSeason').addEventListener('change', load);
    ['h2hD1','h2hD2','h2hAller','h2hRetour'].forEach(id=>{
      document.getElementById(id).addEventListener('click',(e)=>{ _toggle(e.currentTarget); /* filtres visuels si besoin */ });
    });
    modal._bound=true;
  }
  await load(); modal.showModal();
}

/* ===== Computations pour s√©ries (points & rang) ===== */
function computeStandings(matches){
  const agg={};
  function add(A,B,ga,gb){
    if(ga==null||gb==null) return;
    if(!agg[A]) agg[A]={J:0,V:0,N:0,D:0,BP:0,BC:0};
    if(!agg[B]) agg[B]={J:0,V:0,N:0,D:0,BP:0,BC:0};
    agg[A].J++; agg[B].J++; agg[A].BP+=ga; agg[A].BC+=gb; agg[B].BP+=gb; agg[B].BC+=ga;
    if(ga>gb){ agg[A].V++; agg[B].D++; } else if(ga<gb){ agg[B].V++; agg[A].D++; } else { agg[A].N++; agg[B].N++; }
  }
  for(const m of matches||[]){ if(!m.p1||!m.p2) continue; if(m.a1!=null&&m.a2!=null) add(m.p1,m.p2,m.a1,m.a2); if(m.r1!=null&&m.r2!=null) add(m.p2,m.p1,m.r2,m.r1); }
  return Object.entries(agg).map(([id,x])=>({id,PTS:x.V*3+x.N,DIFF:x.BP-x.BC,BP:x.BP})).sort((a,b)=>b.PTS-a.PTS||b.DIFF-a.DIFF||b.BP-a.BP||a.id.localeCompare(b.id));
}
const pointsD1=(n,rank)=> (rank<1||rank>n)?0: 9+(n-rank);
const pointsD2=(rank)=> { const t=[10,8,7,6,5,4,3,2,1,1,1]; return (rank>0 && rank<=t.length)? t[rank-1] : 1; };
function movingAvg(arr, n=3){ const out=[]; for(let i=0;i<arr.length;i++){ const a=Math.max(0,i-n+1); const s=arr.slice(a,i+1); out.push( +(s.reduce((x,y)=>x+y,0)/s.length).toFixed(2) ); } return out; }

async function seriesPointsAndRank(seasonKey){
  const daysResp = await fetch(`${API}/matchdays?season=${seasonKey}`, { headers:{Authorization:'Bearer '+TOKEN} });
  const dd = await daysResp.json();
  const labels = dd.days||[];
  const points=[], ranks=[];
  for(const day of labels){
    const p=await (await fetch(`${API}/matchdays/${day}`,{headers:{Authorization:'Bearer '+TOKEN}})).json();
    const s1=computeStandings(p.d1||[]), s2=computeStandings(p.d2||[]);
    const ix1=s1.findIndex(x=>x.id===SELF_ID), ix2=s2.findIndex(x=>x.id===SELF_ID);
    let today=0;
    if(ix1>=0) today = pointsD1(s1.length, ix1+1);
    if(ix2>=0) today = pointsD2(ix2+1);
    points.push(today);
    if(ix1>=0){ ranks.push(ix1+1); }
    else if(ix2>=0){ ranks.push(ix2+1 + (s1.length||0)); }
    else { ranks.push(null); }
  }
  const filled = ranks.map((v,i)=>{
    if(v!=null) return v;
    let l=i-1; while(l>=0 && ranks[l]==null) l--;
    let r=i+1; while(r<ranks.length && ranks[r]==null) r++;
    if(l>=0 && r<ranks.length) return Math.round((ranks[l]+ranks[r])/2);
    return (l>=0)?ranks[l] : (r<ranks.length? ranks[r] : 0);
  });
  return { labels, points, movavg: movingAvg(points,3), rank: filled };
}

/* ===== Charts: Points & Rang ===== */
function renderStatsCharts(ser){
  const c1 = new Chart($('#chartPoints').getContext('2d'),{
    type:'bar',
    data:{
      labels:ser.labels,
      datasets:[
        { type:'bar', label:'Points', data:ser.points, borderWidth:1, backgroundColor: chartCSS('--accent')+'33', borderColor: chartCSS('--accent') },
        { type:'line', label:'Moy. glissante (3)', data:ser.movavg, borderWidth:2, pointRadius:0, tension:.25, borderColor: chartCSS('--info-600') }
      ]
    },
    options:{ responsive:true, plugins:{ legend:{ labels:{ boxWidth:12 } } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
  const c2 = new Chart($('#chartRank').getContext('2d'),{
    type:'line',
    data:{ labels:ser.labels, datasets:[{ label:'Rang', data:ser.rank, borderWidth:2, pointRadius:2, tension:.2, borderColor: chartCSS('--warn-700') }] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ reverse:true, beginAtZero:false, ticks:{ precision:0 } } } }
  });
  CHARTS.push(c1,c2);
}

/* ===== Comparateur ===== */
const NAME_BY_ID = new Map(), PIC_BY_ID = new Map();
async function loadPlayersList(){
  if(NAME_BY_ID.size) return;
  const r=await fetch(API+'/players',{headers:{Authorization:'Bearer '+TOKEN}}); const d=await r.json();
  (d.players||[]).forEach(p=>{
    NAME_BY_ID.set(p.player_id, p.name||p.player_id);
    PIC_BY_ID.set(p.player_id, p.profile_pic_url ? (API+p.profile_pic_url) : 'assets/fond.png');
  });
}
function fillSelect(sel){
  sel.innerHTML = '<option value="">Choisir‚Ä¶</option>' + [...NAME_BY_ID.keys()].map(id=>`<option value="${id}">${NAME_BY_ID.get(id)} ‚Äî ${id}</option>`).join('');
}
function last5FormFromMatches(matches){
  const arr = matches.map(x=>{
    const out=[];
    if(x.aller){ out.push(x.aller.gf>x.aller.ga?'W':(x.aller.gf<x.aller.ga?'L':'D')); }
    if(x.retour){ out.push(x.retour.gf>x.retour.ga?'W':(x.retour.gf<x.xretour.ga?'L':'D')); }
    return out;
  }).flat();
  return arr.slice(-5);
}
function formDotsHTML(form){ if(!form.length) return '<span class="muted">‚Äî</span>'; return '<div class="form5">'+ form.map(c=>`<span class="dot ${c}">${c}</span>`).join('') + '</div>'; }
async function getSummary(pid, season){
  const rs = await fetch(API+`/players/${pid}/summary?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} }); const sum = await rs.json();
  const rm = await fetch(API+`/players/${pid}/matches?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} }); const mat = await rm.json();
  if (typeof sum.won_d1 !== 'number' || typeof sum.won_d2 !== 'number') {
    try{
      const r2 = await fetch(API+`/season/standings?season=${season}`, { headers:{Authorization:'Bearer '+TOKEN} });
      const d2 = await r2.json();
      const rec = (d2.standings||[]).find(x=>x.id===pid);
      if(rec){
        sum.won_d1 = rec.won_d1 ?? 0; sum.won_d2 = rec.won_d2 ?? 0;
        if(typeof sum.points!=='number')   sum.points   = rec.total ?? sum.points;
        if(typeof sum.moyenne!=='number')  sum.moyenne  = rec.moyenne ?? sum.moyenne;
        if(typeof sum.rank!=='number')     sum.rank     = (d2.standings||[]).findIndex(x=>x.id===pid)+1 || sum.rank;
      }
    }catch(_){}
  }
  return { sum, matches: mat.matches||[] };
}
function buildCmpCard(pid, data){
  const name = NAME_BY_ID.get(pid)||pid;
  const pic  = PIC_BY_ID.get(pid)||'assets/fond.png';
  const s = data.sum||{};
  const form = formDotsHTML( last5FormFromMatches(data.matches||[]) );
  const wonD1 = (typeof s.won_d1 === 'number') ? s.won_d1 : '‚Äî';
  const wonD2 = (typeof s.won_d2 === 'number') ? s.won_d2 : '‚Äî';
  const block = document.createElement('div');
  block.className='card cmp-card';
  block.innerHTML = `
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${pic}" class="avatar" alt="">
      <div>
        <h4>${name}</h4>
        <div class="muted">${pid}</div>
      </div>
    </div>
    <div style="height:8px"></div>
    <div class="stat-row"><span class="muted">Rang</span><b>${s.rank ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Points</span><b>${s.points ?? '‚Äî'}</b></div>
    <div class="stat-row"><span class="muted">Moyenne</span><b>${(s.moyenne ?? '‚Äî')}</b></div>
    <div class="stat-row"><span class="muted">Manches</span><b>${s.legs ?? 0}</b></div>
    <div class="stat-row"><span class="muted">BM / BC</span><b>${s.goals_for ?? 0} / ${s.goals_against ?? 0}</b></div>
    <div class="stat-row"><span class="muted">Titres D1 / D2</span><b>${wonD1} / ${wonD2}</b></div>
    <div class="stat-row"><span class="muted">Forme (5)</span>${form}</div>
  `;
  return block;
}
let RAD=null;
function renderRadar(series){
  if(RAD){ try{RAD.destroy()}catch(_){ } }
  RAD = new Chart($('#cmpRadar').getContext('2d'),{
    type:'radar',
    data:{ labels:['Win%','Pts/jrn','Diff./match','Participation%','Clutch'],
      datasets:[
        {label:series.A.name, data:series.A.values, borderWidth:2, pointRadius:2, fill:true, borderColor:chartCSS('--accent'), backgroundColor:chartCSS('--accent')+'33'},
        {label:series.B.name, data:series.B.values, borderWidth:2, pointRadius:2, fill:true, borderColor:chartCSS('--warn-700'), backgroundColor:chartCSS('--warn-700')+'33'}
      ]
    },
    options:{ responsive:true, scales:{ r:{ beginAtZero:true, max:100 } } }
  });
  CHARTS.push(RAD);
}
function toPct(x){ return Math.max(0, Math.min(100, Math.round(x*100))); }
async function collectRadarMetrics(pid, season){
  const st=await (await fetch(`${API}/season/standings?season=${season}`,{headers:{Authorization:'Bearer '+TOKEN}})).json();
  const rec=(st.standings||[]).find(x=>x.id===pid)||{ total:0, participations:0, moyenne:0, name:pid };
  const matches=await (await fetch(`${API}/players/${pid}/matches?season=${season}`,{headers:{Authorization:'Bearer '+TOKEN}})).json();
  let legs=0,W=0,BP=0,BC=0;
  (matches.matches||[]).forEach(x=>{
    if(x.aller){legs++;BP+=x.aller.gf;BC+=x.aller.ga; if(x.aller.gf>x.aller.ga)W++;}
    if(x.retour){legs++;BP+=x.retour.gf;BC+=x.retour.ga; if(x.retour.gf>x.retour.ga)W++;}
  });
  const win = legs? (W/legs) : 0;
  const ptsPerDay = rec.participations? (rec.total/rec.participations) : 0;
  const maxAvg = Math.max(1, ...(st.standings||[]).map(s=>s.moyenne||0));
  const diffPer = legs? ((BP-BC)/legs) : 0;
  const normDiff = 0.5 + Math.tanh(diffPer/5)/2; // 0..1
  const partPct = (st.standings?.length && st.season_days ? (rec.participations/st.season_days) : 0); // si tu exposes season_days c√¥t√© API, sinon ~0
  const clutch = (rec.moyenne||0) / maxAvg;
  return { name: rec.name||pid, values:[toPct(win),toPct(ptsPerDay/10),toPct(normDiff),toPct(partPct),toPct(clutch)] };
}
(async function initComparator(){
  await loadPlayersList();
  fillSelect($('#cmpA')); fillSelect($('#cmpB'));
  $('#cmpSwap').onclick = ()=>{ const a=$('#cmpA').value, b=$('#cmpB').value; $('#cmpA').value=b; $('#cmpB').value=a; };
  $('#cmpRun').onclick = async ()=>{
    const A=$('#cmpA').value, B=$('#cmpB').value, season=$('#cmpSeason').value;
    if(!A || !B || A===B) return alert('Choisir deux joueurs diff√©rents.');
    $('#cmpOut').innerHTML = '<div class="muted">Chargement‚Ä¶</div>';
    try{
      const [da, db, ra, rb] = await Promise.all([getSummary(A,season), getSummary(B,season), collectRadarMetrics(A,season), collectRadarMetrics(B,season)]);
      const host = $('#cmpOut'); host.innerHTML=''; host.appendChild(buildCmpCard(A,da)); host.appendChild(buildCmpCard(B,db));
      window._radarSeries = { A:ra, B:rb }; renderRadar(window._radarSeries);
    }catch(e){ console.error(e); $('#cmpOut').innerHTML='<div class="muted">Erreur de chargement</div>'; }
  };
})();

/* ===== Classement rapide ===== */
let seasonData=[];
async function loadSeason(){
  try{
    const r=await fetch(`${API}/season/standings`,{headers:{'Authorization':`Bearer ${TOKEN}`}}); const d=await r.json();
    seasonData = d.standings||[]; renderSeason();
  }catch(e){ console.error(e); seasonData=[]; renderSeason(); }
}
function escapeHtml(t){return String(t||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function renderSeason(){
  const q = ($('#search')?.value||'').toLowerCase();
  const data = (seasonData||[]).filter(x=>(x.name||'').toLowerCase().includes(q) || (x.id||'').toLowerCase().includes(q));
  const tb = $('#seasonTable tbody'); if(tb) tb.innerHTML='';
  data.forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML =
      '<td>'+(i+1)+'</td>'
      + '<td>'+escapeHtml(p.name||p.id||'')+'</td>'
      + '<td class="hid-m">'+escapeHtml(p.id||'')+'</td>'
      + '<td>'+(p.total??0)+'</td>'
      + '<td>'+(p.participations??0)+'</td>'
      + '<td>'+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</td>'
      + '<td>'+(p.won_d1??0)+'</td>'
      + '<td>'+(p.won_d2??0)+'</td>'
      + '<td>'+(p.teams_used??0)+'</td>';
    tb.appendChild(tr);
  });
  const cards = $('#seasonCards'); if(cards) cards.innerHTML='';
  data.forEach((p,i)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML =
      '<div style="font-weight:700;margin-bottom:4px">'+(i+1)+'. '+escapeHtml(p.name||p.id||'')+'</div>'
      + '<div class="grid2">'
      + '<div><span class="muted">ID:</span> '+escapeHtml(p.id||'')+'</div>'
      + '<div><span class="muted">Total:</span> '+(p.total??0)+'</div>'
      + '<div><span class="muted">Part.:</span> '+(p.participations??0)+'</div>'
      + '<div><span class="muted">Moy.:</span> '+((p.moyenne??0).toFixed? (p.moyenne||0).toFixed(2): (p.moyenne??0))+'</div>'
      + '<div><span class="muted">D1 gagn√©s:</span> '+(p.won_d1??0)+'</div>'
      + '<div><span class="muted">D2 gagn√©s:</span> '+(p.won_d2??0)+'</div>'
      + '<div><span class="muted">√âquipes diff.:</span> '+(p.teams_used??0)+'</div>'
      + '</div>';
    cards.appendChild(div);
  });
}
$('#seasonReload')?.addEventListener('click', loadSeason);
$('#search')?.addEventListener('input', renderSeason);
loadSeason();

/* ===== Toggle sections ===== */
(function bindToggles(){
  $$('.toggle-card').forEach(btn=>{
    const id = btn.getAttribute('aria-controls');
    const box = document.getElementById(id);
    if(!box) return;
    btn.addEventListener('click', ()=>{
      const open = btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded', open?'false':'true');
      btn.textContent = open ? 'D√©velopper' : 'R√©duire';
      box.hidden = open;
    });
  });
})();

/* ===== Ping pr√©sence (membres) ===== */
(function(){
  const role=(localStorage.getItem('efoot.role')||'member').toLowerCase();
  if(!TOKEN || role==='admin') return;
  const ping = ()=> fetch(`${API}/presence/ping`, { method:'POST', headers:{Authorization:'Bearer ${TOKEN}'}}).catch(()=>{});
  ping(); setInterval(ping, 15000);
})();
</script>
</body>
</html>
