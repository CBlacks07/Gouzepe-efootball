<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Connexion ‚Äî GOUZEPE eFOOT</title>
  <link rel="stylesheet" href="theme.css"/>
  <style>
    .wrap{max-width:860px;margin:auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 840px){ .grid{grid-template-columns:1fr} }
    .panel{border:1px solid var(--border);border-radius:14px;background:var(--panel);padding:14px}
    .title{font-size:20px;font-weight:800;margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .full{width:100%}
    input,select{width:100%}
    .err{color:#ef4444;margin-top:6px;min-height:22px}
    .boot{color:var(--muted);margin-top:6px;min-height:22px}
    .btn.block{width:100%}
    .apiBox{display:flex;gap:8px;align-items:center}
    .apiBox input{flex:1}
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <div class="nav">
      <div class="logo" aria-hidden="true"></div>
      <h1 style="margin:0;font-size:18px">Connexion</h1>
    </div>
    <button id="theme" class="btn" title="Basculer th√®me">‚òÄÔ∏è</button>
  </div>

  <div class="grid" style="margin-top:12px">
    <!-- Connexion -->
    <section class="panel">
      <h2 class="title">Se connecter</h2>
      <form id="f" class="row full" style="gap:10px">
        <input id="email" type="text" placeholder="Email ou identifiant" autocomplete="username" required>
        <input id="pwd" type="password" placeholder="Mot de passe" autocomplete="current-password" required>
        <button id="loginBtn" class="btn primary block" type="submit">Se connecter</button>
        <div id="err" class="err"></div>
        <div id="boot" class="boot"></div>
      </form>
    </section>

    <!-- R√©glages API -->
    <section class="panel">
      <h2 class="title">Param√®tres</h2>
      <div class="muted">API √† utiliser :</div>
      <div class="apiBox" style="margin-top:6px">
        <input id="api" placeholder="https://gouzepe-efootball.onrender.com">
        <button id="saveApi" class="btn">Enregistrer</button>
        <button id="clearApi" class="btn danger">R√©initialiser</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Par d√©faut, on utilise <b>https://gouzepe-efootball.onrender.com</b>.
      </div>
    </section>
  </div>

  <footer style="text-align:center;margin:16px 0;color:var(--muted)">¬© GOUZEPE GAMING CLUB 2025</footer>
</div>

<script>
/* ===== Th√®me ===== */
(function(){
  const k='efoot.theme';
  const apply=m=>{document.documentElement.classList.toggle('light',m==='light');localStorage.setItem(k,m);document.getElementById('theme').textContent=m==='light'?'üåô':'‚òÄÔ∏è'};
  apply(localStorage.getItem(k)||'dark');
  document.getElementById('theme').onclick=()=>apply(document.documentElement.classList.contains('light')?'dark':'light');
})();

/* ===== API base ===== */
const DEFAULT_API = 'https://gouzepe-efootball.onrender.com';
function getAPI(){
  const v=(localStorage.getItem('efoot.api')||'').trim();
  return v || DEFAULT_API;
}
function setAPI(v){
  v=(v||'').trim().replace(/\/+$/,'');
  if(v) localStorage.setItem('efoot.api', v); else localStorage.removeItem('efoot.api');
}
document.getElementById('api').value = localStorage.getItem('efoot.api') || DEFAULT_API;
document.getElementById('saveApi').onclick = ()=>{
  setAPI(document.getElementById('api').value);
  alert('API enregistr√©e.');
};
document.getElementById('clearApi').onclick = ()=>{
  localStorage.removeItem('efoot.api');
  document.getElementById('api').value = DEFAULT_API;
  alert('API r√©initialis√©e.');
};

/* ===== UI helpers ===== */
function showErr(t){ document.getElementById('err').textContent=t||''; }
function showBoot(t){ document.getElementById('boot').textContent=t||''; }
function setBusy(v){
  const btn = document.getElementById('loginBtn');
  btn.disabled = !!v; btn.textContent = v ? 'Connexion‚Ä¶' : 'Se connecter';
}
async function safeFetch(url,opt={},ms=15000){
  const c=new AbortController(); const to=setTimeout(()=>c.abort(),ms);
  try{ return await fetch(url,{signal:c.signal,...opt}); }
  finally{ clearTimeout(to); }
}
/* Attendre que /health r√©ponde (Render peut ‚Äúr√©veiller‚Äù le conteneur) */
async function waitForHealth(api, timeoutMs=90000){
  const start=Date.now();
  while(Date.now()-start < timeoutMs){
    try{
      const r = await safeFetch(api+'/health',{},6000);
      if(r && r.ok){ const d=await r.json().catch(()=>({})); if(d && d.ok) return true; }
    }catch(_){}
    await new Promise(r=>setTimeout(r, 1500));
  }
  return false;
}
async function validateSession(){
  const tk = localStorage.getItem('efoot.token'); if(!tk) return false;
  try{
    const r=await safeFetch(getAPI()+'/auth/me',{headers:{Authorization:'Bearer '+tk}},8000);
    if(!r || !r.ok) return false;
    const d=await r.json().catch(()=>({}));
    return d && d.user;
  }catch(_){ return false; }
}
function goAfterLogin(user){
  const role = (user && user.role || '').toLowerCase();
  if(role==='admin') location.href='Admin-Utilisateurs.html';
  else location.href='Panel-Membre.html';
}

/* ===== Connexion avec prise de contr√¥le (‚Äúforce‚Äù) ===== */
document.getElementById('f').addEventListener('submit', async (e)=>{
  e.preventDefault();
  showErr(''); showBoot(''); setBusy(true);

  // normaliser email si identifiant court
  let email=(document.getElementById('email').value||'').trim();
  const password=document.getElementById('pwd').value||'';
  if(email && !email.includes('@')) email = email + '@gz.local';

  let forceBtn;

  function showForce(){
    if(forceBtn) return;
    forceBtn = document.createElement('button');
    forceBtn.type = 'button';
    forceBtn.className = 'btn';
    forceBtn.style.marginTop = '8px';
    forceBtn.textContent = "C'est moi ‚Äî connecter ici";
    forceBtn.onclick = ()=> doLogin(true);
    document.getElementById('f').appendChild(forceBtn);
  }

  const doLogin = async (force=false)=>{
    try{
      const url = getAPI()+'/auth/login' + (force ? '?force=1' : '');
      const r = await safeFetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(force?{'X-Force-Login':'1'}:{}) },
        body: JSON.stringify({ email, password })
      }, 15000);

      // Session active ailleurs ‚Üí 409
      if(r && r.status === 409){
        const d=await r.json().catch(()=>({}));
        showErr("Une session est d√©j√† ouverte sur un autre appareil.");
        showBoot("Clique sur ¬´ C'est moi ‚Äî connecter ici ¬ª pour prendre la main.");
        setBusy(false);
        showForce();
        return;
      }

      const d=await r.json().catch(()=>({}));
      if(!r || !r.ok) throw new Error((d && d.error) || 'Identifiants invalides');

      const token=d.token;
      const role=(d.user&&d.user.role)||'member';
      const expHours = Number(d.expHours||24);
      localStorage.setItem('efoot.token', token);
      localStorage.setItem('efoot.role', role.toLowerCase());
      localStorage.setItem('efoot.expAt', String(Date.now()+expHours*3600*1000));

      showBoot('Connexion r√©ussie. D√©marrage du serveur‚Ä¶');
      const ok = await waitForHealth(getAPI(), 90000);
      if(!ok){ showErr("Le serveur est lent √† d√©marrer (Render). R√©essaie."); setBusy(false); showBoot(''); return; }

      const vr = await validateSession();
      if(vr){ showBoot(''); goAfterLogin(vr.user || vr); }
      else { showErr("Impossible de valider la session."); setBusy(false); showBoot(''); }

    }catch(err){
      console.error(err);
      showErr(err.message||'Erreur r√©seau');
      setBusy(false); showBoot('');
    }
  };

  doLogin(false);
});
</script>
</body>
</html>
