<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GOUZEPE — Connexion</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial; background:#0f172a; color:#e2e8f0; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:24px; }
    .card { width:100%; max-width:440px; background:#111827; border:1px solid #1f2937; border-radius:16px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:22px; font-weight:700; }
    p.sub { margin:0 0 18px; color:#9ca3af; font-size:14px; }
    label { display:block; font-size:13px; color:#cbd5e1; margin:12px 0 6px; }
    input[type="email"], input[type="password"] {
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid #334155; outline:none; background:#0b1220; color:#e2e8f0;
    }
    input::placeholder{ color:#64748b; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:14px; }
    button {
      display:inline-flex; align-items:center; justify-content:center;
      width:100%; margin-top:16px; padding:12px 14px; border:0; border-radius:12px;
      background:#10b981; color:#04131a; font-weight:700; cursor:pointer; transition:transform .06s ease;
    }
    button[disabled]{ opacity:.6; cursor:wait; transform:none !important; }
    button:hover{ transform:translateY(-1px); }
    .muted { font-size:12px; color:#94a3b8; }
    .err { margin-top:10px; padding:10px 12px; border-radius:12px; background:#3b0b0b; color:#fecaca; display:none; }
    .ok  { margin-top:10px; padding:10px 12px; border-radius:12px; background:#0b3b14; color:#bbf7d0; display:none; }
    .api { font-size:11px; color:#94a3b8; margin-top:10px; word-break:break-all; }
    .toplogo { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .badge { display:inline-flex; align-items:center; gap:8px; background:#0b1220; border:1px solid #1f2937; color:#9ca3af; padding:6px 10px; border-radius:999px; font-size:12px; }
    .right { text-align:right; }
    a { color:#60a5fa; text-decoration:none; }
    .eye { position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:12px; color:#94a3b8; }
    .rel { position:relative; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="toplogo">
        <span class="badge">GOUZEPE eFOOTBALL</span>
        <div style="flex:1"></div>
        <span class="muted" id="envBadge">…</span>
      </div>
      <h1>Connexion</h1>
      <p class="sub">Accédez à votre espace membre.</p>

      <form id="loginForm">
        <label for="email">Adresse e-mail</label>
        <input id="email" type="email" inputmode="email" autocomplete="username" placeholder="ex: nom@exemple.com" required />

        <label for="password">Mot de passe</label>
        <div class="rel">
          <input id="password" type="password" autocomplete="current-password" placeholder="Votre mot de passe" required />
          <span class="eye" id="togglePwd">afficher</span>
        </div>

        <div class="row">
          <span class="muted">Besoin d’un compte ? Demandez à un admin.</span>
          <a class="muted right" href="#" id="forceApiLink" title="Changer l’URL API">config API</a>
        </div>

        <button id="submitBtn" type="submit">Se connecter</button>
      </form>

      <div class="err" id="errBox"></div>
      <div class="ok" id="okBox"></div>
      <div class="api" id="apiInfo"></div>
    </div>
  </div>

  <script>
  (function(){
    /* === Détection API (Render & local) === */
    const PROD_API='https://gouzepe-api.onrender.com';
    const isPrivateNet=(h)=>/^(localhost|127\\.0\\.0\\.1|10\\.\\d+\\.\\d+\\.\\d+|192\\.168\\.\\d+\\.\\d+|172\\.(1[6-9]|2\\d|3[01])\\.\\d+\\.\\d+)$/.test(h||'');
    function DEF_API(){
      const host=location.hostname||'';
      if(isPrivateNet(host)) return (location.protocol.startsWith('http')?location.protocol:'http:')+'//'+host+':3000';
      if(host.endsWith('.onrender.com')){
        if(host.includes('-app.')) return 'https://'+host.replace('-app.','-api.');
        if(host.includes('app.'))  return 'https://'+host.replace('app.','api.');
      }
      return PROD_API;
    }
    function getAPI(){ return (localStorage.getItem('efoot.api')||DEF_API()).replace(/\\/+$/,''); }
    function setAPI(v){ localStorage.setItem('efoot.api', String(v||'').trim()); }

    /* === Health warm-up (Render cold start) === */
    async function waitHealth(api, maxMs=45000){
      const start=Date.now();
      let attempt=0;
      while(Date.now()-start < maxMs){
        attempt++;
        try{
          const r=await fetch(api+'/health',{cache:'no-store'});
          if(r.ok){ const j=await r.json().catch(()=>({})); return j; }
        }catch(e){ /* ignore and retry */ }
        await new Promise(res=>setTimeout(res, Math.min(500*attempt, 2500)));
      }
      throw new Error('API indisponible (health timeout)');
    }

    /* === Utilitaires UI === */
    const $ = (id)=>document.getElementById(id);
    function showErr(msg){ const b=$('errBox'); b.textContent=msg||''; b.style.display=msg?'block':'none'; $('okBox').style.display='none'; }
    function showOk(msg){ const b=$('okBox'); b.textContent=msg||''; b.style.display=msg?'block':'none'; $('errBox').style.display='none'; }

    /* === Affiche env + API courante === */
    function refreshApiInfo(){
      const api=getAPI();
      $('apiInfo').textContent='API: '+api;
      const host=new URL(api).hostname;
      $('envBadge').textContent = isPrivateNet(host) ? 'LOCAL' : (host.includes('onrender.com') ? 'RENDER' : 'PROD');
      window.API=api; // expose global au besoin
    }
    refreshApiInfo();

    /* === Toggle mot de passe === */
    $('togglePwd').addEventListener('click', ()=>{
      const p=$('password');
      const s=$('togglePwd');
      const is=p.type==='password';
      p.type=is?'text':'password';
      s.textContent=is?'masquer':'afficher';
    });

    /* === Config API (manuel) === */
    $('forceApiLink').addEventListener('click', (e)=>{
      e.preventDefault();
      const current=getAPI();
      const v=prompt('URL API (http…):', current);
      if(v && /^https?:\\/\\//i.test(v)){ setAPI(v); refreshApiInfo(); }
    });

    /* === Soumission login === */
    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn=$('submitBtn');
      btn.disabled=true; showErr(''); showOk('');

      const api=getAPI();
      try{
        await waitHealth(api, 45000);
      }catch(err){
        btn.disabled=false;
        return showErr('API indisponible. Réessaie dans quelques secondes.');
      }

      const email=$('email').value.trim();
      const password=$('password').value;
      try{
        const r=await fetch(api+'/auth/login',{
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body:JSON.stringify({ email, password })
        });
        const j=await r.json().catch(()=>({}));
        if(!r.ok){
          btn.disabled=false;
          return showErr(j.error || 'Identifiants invalides.');
        }
        // Stockage session
        const token=j.token;
        const user=j.user||{};
        const hours=j.expHours||24;
        const expAt=Date.now()+hours*60*60*1000;
        localStorage.setItem('efoot.token', token);
        localStorage.setItem('efoot.role', user.role||'member');
        localStorage.setItem('efoot.userEmail', user.email||'');
        localStorage.setItem('efoot.userId', String(user.id||''));
        localStorage.setItem('efoot.expAt', String(expAt));

        showOk('Connexion réussie, redirection…');
        setTimeout(()=>{ location.href='Accueil.html'; }, 500);
      }catch(err){
        btn.disabled=false;
        showErr('Erreur réseau : '+(err.message||'inconnue'));
      }
    });
  })();
  </script>
</body>
</html>
